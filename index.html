<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAN_NET // ONLINE</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Core Theme */
            --bg-color: #000000;
            --main-color: #00FF00;
            --dim-color: #004400;
            --warn-color: #FFAA00;
            --err-color: #FF0000;
            
            /* Reputation Colors */
            --rep-good: #00FF00;
            --rep-watch: #D000FF;
            --rep-black: #FF0000;

            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            font-size: 14px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- UI COMPONENTS --- */
        .hidden { display: none !important; }
        .screen { max-width: 600px; margin: 0 auto; border: 1px solid var(--dim-color); padding: 15px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.1); position: relative; margin-bottom: 20px; }
        
        button, input, select, textarea {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid var(--dim-color);
            color: var(--main-color);
            padding: 10px;
            margin-bottom: 8px;
            font-family: var(--font-main);
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }

        button:hover { background: var(--main-color); color: var(--bg-color); cursor: pointer; font-weight: bold; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.danger { border-color: var(--err-color); color: var(--err-color); }
        button.danger:hover { background: var(--err-color); color: white; }
        button.warn { border-color: var(--warn-color); color: var(--warn-color); }
        button.admin { border-color: cyan; color: cyan; border-style: double; }
        button.admin:hover { background: cyan; color: black; }
        
        /* --- REPUTATION CLASSES --- */
        .rep-green { color: var(--rep-good); text-shadow: 0 0 5px var(--rep-good); }
        .rep-purple { color: var(--rep-watch); text-shadow: 0 0 5px var(--rep-watch); }
        .rep-red { color: var(--rep-black); text-shadow: 0 0 5px var(--rep-black); font-weight: bold; }

        /* --- LAYOUTS --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px dashed var(--dim-color); padding: 10px; margin-bottom: 10px; }
        .chat-box { height: 250px; overflow-y: scroll; border: 1px solid #222; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); }
        .chat-msg { margin-bottom: 8px; border-bottom: 1px solid #111; padding-bottom: 4px; font-size: 0.9em; word-wrap: break-word; }
        .chat-img { height: 20px; vertical-align: middle; filter: sepia(1) hue-rotate(50deg) saturate(5); }
        
        canvas { border: 1px solid var(--main-color); cursor: crosshair; background: #050505; display: block; margin: 0 auto 10px auto; }
        
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }

        /* --- ECTOTAPE --- */
        .video-card { border: 1px solid var(--dim-color); margin-bottom: 15px; }
        .video-thumb { width: 100%; height: 150px; background: #111; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .video-info { padding: 10px; }

        /* --- TERMINAL OUTPUT --- */
        .term-line { font-family: monospace; font-size: 12px; margin: 2px 0; }
        .term-success { color: #00FF00; }
        .term-warn { color: #FFAA00; }
        .term-err { color: #FF0000; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">Accessing Neural Net...</div>

    <div id="screen-auth" class="screen">
        <h1>// NET_LOGIN_ONLINE</h1>
        <input type="text" id="auth-user" placeholder="USERNAME">
        <input type="password" id="auth-pass" placeholder="PASSWORD">
        <button onclick="app.login()">AUTHENTICATE</button>
        <button onclick="app.register()" style="border-style: dashed; opacity: 0.7;">REGISTER IDENTITY</button>
    </div>

    <div id="screen-hub" class="screen hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>USER: <span id="hub-user"></span></span>
            <button onclick="nav.to('settings')" style="width: auto; padding: 5px 10px; font-size: 10px;">CONFIG</button>
        </div>
        <div style="margin-bottom: 10px;"><span id="hub-rep">REP: <span id="rep-badge">LOADING...</span></span></div>
        <hr style="border-color: var(--dim-color);">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
            <button onclick="nav.tab('clans')">CLANS</button>
            <button onclick="nav.tab('global')">GLOBAL COMMS</button>
            <button onclick="nav.to('jobs')">JOBS / GIGS</button>
            <button onclick="nav.to('events')">EVENTS</button>
            <button onclick="nav.to('ectotape')" style="grid-column: span 2; border-color: var(--rep-watch); color: var(--rep-watch);">[ ECTOTAPE ]</button>
            <button onclick="nav.to('soc')" id="btn-soc" class="hidden admin" style="grid-column: span 2;">[ SECURITY OPS CENTER ]</button>
        </div>

        <div id="tab-clans">
            <div id="panel-no-clan">
                <button onclick="nav.to('create')">INITIALIZE NEW CLAN</button>
                <div style="border: 1px solid var(--dim-color); padding: 10px; margin-top: 10px;">
                    <p style="margin: 0 0 5px 0;">SEARCH NETWORK:</p>
                    <input type="text" id="join-name" placeholder="EXACT CLAN NAME">
                    <input type="password" id="join-pass" placeholder="ACCESS KEY">
                    <button onclick="app.joinClan()">CONNECT</button>
                </div>
            </div>
            <div id="panel-in-clan" class="hidden">
                <h2 id="clan-header">CLAN_NAME</h2>
                <div class="chat-box" id="clan-chat"></div>
                
                <div style="display: flex; gap: 5px;">
                    <button onclick="app.toggleTrans()" id="btn-trans" style="width: 50px; font-size: 10px;">ENC</button>
                    <input type="text" id="clan-input" placeholder="Secure Message..." style="margin:0;">
                    <button onclick="app.sendClanMsg()" style="width: 60px;">SEND</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
                    <button onclick="nav.to('dict')">DICTIONARY</button>
                    <button onclick="nav.to('ranks')">ROSTER</button>
                    <button onclick="nav.to('draw-edit')">EDIT SYMBOLS</button>
                    <button onclick="app.leaveClan()" class="danger">LEAVE</button>
                </div>
            </div>
        </div>

        <div id="tab-global" class="hidden">
            <p style="font-size: 0.8em; opacity: 0.7;">// PUBLIC FREQUENCY</p>
            <div class="chat-box" id="global-chat"></div>
            <input type="text" id="global-input" placeholder="Public Comment...">
            <button onclick="app.sendGlobalMsg()">POST COMMENT</button>
        </div>
        
        <button onclick="location.reload()" style="margin-top: 20px; border: none; opacity: 0.5;">LOGOUT</button>
    </div>

    <div id="screen-settings" class="screen hidden">
        <h2>// SYSTEM_CONFIG</h2>
        
        <label>MAIN THEME</label>
        <div class="grid-2">
            <div>BG: <input type="color" id="col-bg" value="#000000" onchange="settings.apply()"></div>
            <div>MAIN: <input type="color" id="col-main" value="#00FF00" onchange="settings.apply()"></div>
        </div>
        <div class="grid-2">
            <div>DIM: <input type="color" id="col-dim" value="#004400" onchange="settings.apply()"></div>
            <div>WARN: <input type="color" id="col-warn" value="#FFAA00" onchange="settings.apply()"></div>
        </div>
        <hr style="border-color: #333">
        <label>REPUTATION COLORS</label>
        <div class="grid-2">
            <div>GOOD: <input type="color" id="col-r-good" value="#00FF00" onchange="settings.apply()"></div>
            <div>WATCH: <input type="color" id="col-r-watch" value="#D000FF" onchange="settings.apply()"></div>
        </div>
        <div>BAD/BLK: <input type="color" id="col-r-bad" value="#FF0000" onchange="settings.apply()"></div>

        <button onclick="settings.reset()" style="margin-top: 20px;" class="danger">RETURN TO DEFAULT SETTINGS</button>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-soc" class="screen hidden" style="border-color: cyan; box-shadow: 0 0 15px cyan;">
        <h2 style="color: cyan;">// SECURITY_OPS_CENTER</h2>
        <p style="font-size: 0.8em;">AUTHORIZED ACCESS ONLY. MONITORING ACTIVE THREATS.</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <button class="admin" onclick="app.runSecurityScan('TRAFFIC')">ANALYZE TRAFFIC</button>
            <button class="admin" onclick="app.runSecurityScan('VULN')">VULNERABILITY SCAN</button>
        </div>

        <div id="soc-console" style="background: #000; border: 1px solid cyan; height: 300px; padding: 10px; overflow-y: scroll; font-family: monospace; font-size: 11px;">
            <span class="term-line">> SOC_INIT... READY.</span><br>
            <span class="term-line">> WAITING FOR COMMAND...</span>
        </div>

        <button onclick="nav.to('hub')" style="margin-top: 10px; border-color: cyan; color: cyan;">DISCONNECT</button>
    </div>

    <div id="screen-events" class="screen hidden">
        <h2>// EVENT_LOG</h2>
        <div style="border: 1px solid var(--dim-color); padding: 10px; margin-bottom: 10px;">
            <h3>NEW EVENT</h3>
            <input type="text" id="evt-name" placeholder="EVENT NAME (UNIQUE)">
            <input type="text" id="evt-desc" placeholder="DESCRIPTION">
            <div class="grid-2">
                <input type="date" id="evt-start">
                <input type="date" id="evt-end">
            </div>
            <button onclick="app.createEvent()">PUBLISH EVENT</button>
        </div>
        <h3>UPCOMING EVENTS</h3>
        <div id="event-list" style="height: 200px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-jobs" class="screen hidden">
        <h2>// GIG_NETWORK</h2>
        <div class="grid-2">
            <button onclick="document.getElementById('job-create-panel').classList.remove('hidden'); document.getElementById('job-list-panel').classList.add('hidden');">POST JOB</button>
            <button onclick="app.loadJobs()">BROWSE JOBS</button>
        </div>

        <div id="job-create-panel" class="hidden" style="margin-top: 10px; border: 1px dashed var(--dim-color); padding: 10px;">
            <h3>POST NEW GIG</h3>
            <input type="text" id="job-title" placeholder="TITLE (e.g., LOST ROCK)">
            <textarea id="job-desc" placeholder="DESCRIPTION / COORDS" style="background:#111; color:var(--main-color); height:60px;"></textarea>
            <button onclick="app.createJob()">UPLOAD CONTRACT</button>
        </div>

        <div id="job-list-panel" style="margin-top: 10px;">
            <div id="job-list" style="height: 300px; overflow-y: scroll;"></div>
        </div>

        <div id="job-chat-panel" class="hidden" style="position: absolute; top:0; left:0; width:100%; height:100%; background: var(--bg-color); z-index: 10; padding: 15px; box-sizing: border-box;">
            <h3>// SECURE_CHANNEL</h3>
            <div id="job-chat-box" class="chat-box" style="height: 300px;"></div>
            <input type="text" id="job-msg-input" placeholder="Encrypted payload...">
            <button onclick="app.sendJobMsg()">TRANSMIT</button>
            <button onclick="app.closeJobChat()" class="warn">CLOSE CONNECTION</button>
        </div>

        <button onclick="nav.to('hub')" style="margin-top: 10px;">BACK</button>
    </div>

    <div id="screen-ectotape" class="screen hidden">
        <h2 style="color: var(--rep-watch); text-align: center;">// ECTOTAPE_STREAM</h2>
        <div id="upload-zone" class="hidden" style="border: 1px dashed var(--rep-watch); padding: 10px; margin-bottom: 20px;">
            <h3>UPLOAD TAPE</h3>
            <input type="text" id="vid-title" placeholder="VIDEO TITLE">
            <input type="text" id="vid-url" placeholder="EMBED URL (YouTube/MP4 Link)">
            <button onclick="app.uploadVideo()">BROADCAST</button>
        </div>
        <div id="video-feed" style="height: 400px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">EXIT STREAM</button>
    </div>

    <div id="screen-create" class="screen hidden">
        <h2>// NEW_CLAN</h2>
        <input type="text" id="create-name" placeholder="UNIQUE NAME">
        <input type="password" id="create-pass" placeholder="PASSWORD">
        <button onclick="app.createClanStart()">START SYMBOL DRAWING</button>
        <button onclick="nav.to('hub')" style="border-style: dashed;">CANCEL</button>
    </div>

    <div id="screen-draw" class="screen hidden">
        <h3 id="draw-title">DRAW: A</h3>
        <canvas id="draw-canvas" width="280" height="280"></canvas>
        <div class="grid-2">
            <button onclick="drawing.clear()">CLEAR</button>
            <button onclick="drawing.save()">NEXT / SAVE</button>
        </div>
        <button onclick="drawing.cancel()" class="danger">CANCEL</button>
    </div>

    <div id="screen-dict" class="screen hidden">
        <h3>// DICTIONARY_EDIT</h3>
        <div class="grid-2">
            <input type="text" id="dict-orig" placeholder="ENGLISH">
            <input type="text" id="dict-new" placeholder="CLAN WORD">
        </div>
        <button onclick="app.addWord()">ADD/UPDATE</button>
        <div id="dict-list" style="height: 200px; overflow-y: scroll; border: 1px solid #222;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-ranks" class="screen hidden">
        <h3>// ROSTER_CONTROL</h3>
        <div id="member-list" style="height: 300px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, where, getDocs, deleteField } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxb5GEGx9LZYD4Ijo-N6K849rsneYlgqk",
            authDomain: "ectenopo.firebaseapp.com",
            projectId: "ectenopo",
            storageBucket: "ectenopo.firebasestorage.app",
            messagingSenderId: "283760497520",
            appId: "1:283760497520:web:c9fdda2d704ca95c0bf5b5"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        // --- AUDIO ENGINE ---
        window.audioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playClick: () => {
                const t = audioSys.ctx.currentTime;
                const o = audioSys.ctx.createOscillator();
                const g = audioSys.ctx.createGain();
                o.type = 'triangle'; o.frequency.setValueAtTime(1500, t); o.frequency.exponentialRampToValueAtTime(100, t+0.05);
                g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05);
                o.connect(g); g.connect(audioSys.ctx.destination); o.start(); o.stop(t+0.05);
            },
            playSpace: () => {
                const t = audioSys.ctx.currentTime;
                const o = audioSys.ctx.createOscillator();
                const g = audioSys.ctx.createGain();
                o.type = 'square'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(50, t+0.1);
                g.gain.setValueAtTime(0.15, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.1);
                o.connect(g); g.connect(audioSys.ctx.destination); o.start(); o.stop(t+0.1);
            },
            playEnter: () => {
                 const t = audioSys.ctx.currentTime;
                 const o = audioSys.ctx.createOscillator();
                 const g = audioSys.ctx.createGain();
                 o.type = 'sawtooth'; o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(200, t+0.15);
                 g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.15);
                 o.connect(g); g.connect(audioSys.ctx.destination); o.start(); o.stop(t+0.15);
            },
            playDelete: () => {
                 const t = audioSys.ctx.currentTime;
                 const o = audioSys.ctx.createOscillator();
                 const g = audioSys.ctx.createGain();
                 o.type = 'sine'; o.frequency.setValueAtTime(800, t); o.frequency.linearRampToValueAtTime(1200, t+0.05);
                 g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05);
                 o.connect(g); g.connect(audioSys.ctx.destination); o.start(); o.stop(t+0.05);
            }
        };

        document.addEventListener('keydown', (e) => {
            if (audioSys.ctx.state === 'suspended') audioSys.ctx.resume();
            if (e.key === ' ') audioSys.playSpace();
            else if (e.key === 'Enter') audioSys.playEnter();
            else if (e.key === 'Backspace' || e.key === 'Delete') audioSys.playDelete();
            else if (e.key.length === 1) audioSys.playClick();
        });

        // --- STATE & UTILS ---
        window.state = { user: null, clan: null, clanData: {}, currentJob: null, unsubJobChat: null };
        const loading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);

        window.nav = {
            to: (id) => {
                document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
                document.getElementById('screen-' + id).classList.remove('hidden');
                
                if(id === 'hub') app.initHub();
                if(id === 'jobs') app.loadJobs();
                if(id === 'events') app.loadEvents();
                if(id === 'ectotape') app.loadEctoTape();
                if(id === 'draw-edit') app.startSymbolEdit();
                if(id === 'settings') settings.load(); // Load values into inputs
            },
            tab: (t) => {
                document.getElementById('tab-clans').classList.add('hidden');
                document.getElementById('tab-global').classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('hidden');
            }
        };

        // --- SETTINGS LOGIC (PERSISTENCE ADDED) ---
        window.settings = {
            apply: (save = true) => {
                const r = document.documentElement.style;
                const vals = {
                    bg: document.getElementById('col-bg').value,
                    main: document.getElementById('col-main').value,
                    dim: document.getElementById('col-dim').value,
                    warn: document.getElementById('col-warn').value,
                    rGood: document.getElementById('col-r-good').value,
                    rWatch: document.getElementById('col-r-watch').value,
                    rBad: document.getElementById('col-r-bad').value
                };

                r.setProperty('--bg-color', vals.bg);
                r.setProperty('--main-color', vals.main);
                r.setProperty('--dim-color', vals.dim);
                r.setProperty('--warn-color', vals.warn);
                r.setProperty('--rep-good', vals.rGood);
                r.setProperty('--rep-watch', vals.rWatch);
                r.setProperty('--rep-black', vals.rBad);

                if(save) localStorage.setItem('clanNetSettings', JSON.stringify(vals));
            },
            load: () => {
                const s = localStorage.getItem('clanNetSettings');
                if(s) {
                    const v = JSON.parse(s);
                    document.getElementById('col-bg').value = v.bg;
                    document.getElementById('col-main').value = v.main;
                    document.getElementById('col-dim').value = v.dim;
                    document.getElementById('col-warn').value = v.warn;
                    document.getElementById('col-r-good').value = v.rGood;
                    document.getElementById('col-r-watch').value = v.rWatch;
                    document.getElementById('col-r-bad').value = v.rBad;
                    settings.apply(false);
                }
            },
            reset: () => {
                if(!confirm("RESTORE DEFAULT VISUALS?")) return;
                localStorage.removeItem('clanNetSettings');
                // Defaults
                const d = { bg: "#000000", main: "#00FF00", dim: "#004400", warn: "#FFAA00", rGood: "#00FF00", rWatch: "#D000FF", rBad: "#FF0000" };
                document.getElementById('col-bg').value = d.bg;
                document.getElementById('col-main').value = d.main;
                document.getElementById('col-dim').value = d.dim;
                document.getElementById('col-warn').value = d.warn;
                document.getElementById('col-r-good').value = d.rGood;
                document.getElementById('col-r-watch').value = d.rWatch;
                document.getElementById('col-r-bad').value = d.rBad;
                settings.apply(false); // Apply but don't save to allow session reset, or save to overwrite? Let's not save so reload keeps default.
            }
        };

        // --- APP LOGIC ---
        window.app = {
            autoTrans: true,

            // AUTH
            login: async () => {
                const u = document.getElementById('auth-user').value.trim();
                const p = document.getElementById('auth-pass').value.trim();
                loading(true);
                const docSnap = await getDoc(doc(db, "users", u));
                loading(false);

                if (docSnap.exists() && docSnap.data().pass === p) {
                    state.user = u;
                    nav.to('hub');
                } else {
                    alert("INVALID CREDENTIALS");
                }
            },

            register: async () => {
                const u = document.getElementById('auth-user').value.trim();
                const p = document.getElementById('auth-pass').value.trim();
                if(!u || !p) return;
                loading(true);
                const check = await getDoc(doc(db, "users", u));
                if (check.exists()) { loading(false); return alert("TAKEN"); }
                await setDoc(doc(db, "users", u), { pass: p, clan: null, rep: 0 });
                loading(false);
                alert("REGISTERED");
            },

            // HUB
            initHub: async () => {
                document.getElementById('hub-user').innerText = state.user;
                
                // CHECK ADMIN / WHITE HAT ACCESS
                const admins = ["user1234", "user4321"]; // Lowercase check
                const uLower = state.user.toLowerCase();
                let canAccessSoc = admins.includes(uLower);
                
                if(!canAccessSoc) {
                    const w = await getDoc(doc(db, "soc_whitelist", state.user)); // Check DB whitelist
                    if(w.exists()) canAccessSoc = true;
                }

                if(canAccessSoc) {
                    document.getElementById('btn-soc').classList.remove('hidden');
                } else {
                    document.getElementById('btn-soc').classList.add('hidden');
                }

                // USER DATA LISTENER
                onSnapshot(doc(db, "users", state.user), (d) => {
                    const data = d.data();
                    if(data.clan) {
                        state.clan = data.clan;
                        app.listenToClan(data.clan);
                    } else {
                        state.clan = null;
                        document.getElementById('panel-no-clan').classList.remove('hidden');
                        document.getElementById('panel-in-clan').classList.add('hidden');
                    }
                    const rep = data.rep || 0;
                    const b = document.getElementById('rep-badge');
                    if(rep > 50) { b.innerText="BLACKLISTED"; b.className="rep-red"; }
                    else if(rep > 0) { b.innerText="WATCHLIST"; b.className="rep-purple"; }
                    else { b.innerText="GOOD"; b.className="rep-green"; }
                });

                // Global Chat
                const q = query(collection(db, "global_chat"), orderBy("ts", "desc"), limit(50));
                onSnapshot(q, (snap) => {
                    const d = document.getElementById('global-chat');
                    d.innerHTML = "";
                    const msgs = [];
                    snap.forEach(doc => msgs.push(doc.data()));
                    msgs.reverse().forEach(m => d.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}</div>`);
                    d.scrollTop = d.scrollHeight;
                });
            },

            // --- SOC (WHITE HAT PANEL) ---
            runSecurityScan: (type) => {
                const c = document.getElementById('soc-console');
                c.innerHTML += `<div class="term-line">> INITIATING ${type}_SCAN...</div>`;
                c.scrollTop = c.scrollHeight;
                
                // Simulated Scanning Effect
                let steps = 0;
                const max = 5;
                const int = setInterval(() => {
                    steps++;
                    const rnd = Math.floor(Math.random() * 9999);
                    c.innerHTML += `<div class="term-line" style="opacity:0.7">...analyzing packet block [${rnd}]</div>`;
                    c.scrollTop = c.scrollHeight;
                    
                    if(steps >= max) {
                        clearInterval(int);
                        if(type === 'TRAFFIC') {
                             c.innerHTML += `<div class="term-line term-success">>> SCAN COMPLETE. TRAFFIC NOMINAL.</div>`;
                             c.innerHTML += `<div class="term-line">> NO MALICIOUS SIGNATURES DETECTED.</div>`;
                        } else {
                             c.innerHTML += `<div class="term-line term-warn">>> ALERT: PORT SCAN DETECTED FROM EXTERNAL NODE.</div>`;
                             c.innerHTML += `<div class="term-line term-success">>> FIREWALL: BLOCKED.</div>`;
                        }
                        c.scrollTop = c.scrollHeight;
                    }
                }, 500);
            },

            // CLANS, JOBS, EVENTS, ECTOTAPE (UNCHANGED LOGIC FROM PREVIOUS)
            listenToClan: (cName) => {
                document.getElementById('panel-no-clan').classList.add('hidden');
                document.getElementById('panel-in-clan').classList.remove('hidden');
                document.getElementById('clan-header').innerText = cName;
                onSnapshot(doc(db, "clans", cName), (doc) => { state.clanData = doc.data(); });
                const q = query(collection(db, "clans", cName, "msgs"), orderBy("ts", "desc"), limit(50));
                onSnapshot(q, (snap) => {
                    const d = document.getElementById('clan-chat');
                    d.innerHTML = "";
                    const msgs = [];
                    snap.forEach(doc => msgs.push(doc.data()));
                    msgs.reverse().forEach(m => {
                        let txt = app.autoTrans ? app.translate(m.txt) : m.txt;
                        d.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${txt}</div>`;
                    });
                    d.scrollTop = d.scrollHeight;
                });
            },

            joinClan: async () => {
                const n = document.getElementById('join-name').value.trim();
                const p = document.getElementById('join-pass').value.trim();
                const s = await getDoc(doc(db, "clans", n));
                if(s.exists() && s.data().pass === p) {
                     await updateDoc(doc(db, "users", state.user), { clan: n });
                     await updateDoc(doc(db, "clans", n), { [`ranks.${state.user}`]: 'member' });
                } else alert("INVALID");
            },

            leaveClan: async () => {
                if(!confirm("LEAVE?")) return;
                await updateDoc(doc(db, "users", state.user), { clan: null });
                await updateDoc(doc(db, "clans", state.clan), { [`ranks.${state.user}`]: deleteField() });
            },

            sendGlobalMsg: async () => {
                const t = document.getElementById('global-input').value;
                if(t) {
                    await addDoc(collection(db, "global_chat"), { u: state.user, txt: t, ts: serverTimestamp() });
                    document.getElementById('global-input').value="";
                }
            },
            sendClanMsg: async () => {
                const t = document.getElementById('clan-input').value;
                if(t) {
                    await addDoc(collection(db, "clans", state.clan, "msgs"), { u: state.user, txt: t, ts: serverTimestamp() });
                    document.getElementById('clan-input').value="";
                }
            },
            toggleTrans: () => { app.autoTrans = !app.autoTrans; document.getElementById('btn-trans').style.color = app.autoTrans ? '#00FF00' : '#555'; },
            translate: (txt) => {
                let out = "";
                const words = state.clanData.words || {};
                const syms = state.clanData.symbols || {};
                txt.split(" ").forEach(w => {
                    const c = w.toLowerCase().replace(/[^a-z]/g,'');
                    if(words[c]) out += app.strToSym(words[c], syms) + " ";
                    else out += app.strToSym(c, syms) + " ";
                });
                return out;
            },
            strToSym: (str, syms) => {
                let html = "";
                for(let c of str) {
                    if(syms[c.toUpperCase()]) html += `<img src="${syms[c.toUpperCase()]}" class="chat-img">`;
                    else html += c;
                }
                return html;
            },
            createEvent: async () => {
                const n = document.getElementById('evt-name').value.trim();
                const d = document.getElementById('evt-desc').value.trim();
                const s = document.getElementById('evt-start').value;
                const e = document.getElementById('evt-end').value;
                if(!n || !s) return alert("NAME & DATE REQUIRED");
                loading(true);
                const q = query(collection(db, "events"), where("name", "==", n));
                const snap = await getDocs(q);
                if(!snap.empty) { loading(false); return alert("EVENT NAME EXISTS"); }
                await addDoc(collection(db, "events"), {
                    name: n, desc: d, start: s, end: e, creator: state.user, ts: serverTimestamp()
                });
                loading(false); alert("EVENT CREATED"); app.loadEvents();
            },
            loadEvents: async () => {
                const list = document.getElementById('event-list');
                list.innerHTML = "LOADING...";
                const q = query(collection(db, "events"), orderBy("start", "asc"));
                const snap = await getDocs(q);
                list.innerHTML = "";
                snap.forEach(d => {
                    const e = d.data();
                    list.innerHTML += `<div class="card"><strong style="color:white;">${e.name}</strong><br><span>${e.start} // ${e.end || '?'}</span><br><p>${e.desc}</p><small>ORG: ${e.creator}</small></div>`;
                });
            },
            createJob: async () => {
                const t = document.getElementById('job-title').value;
                const d = document.getElementById('job-desc').value;
                if(!t) return;
                await addDoc(collection(db, "jobs"), { title: t, desc: d, owner: state.user, worker: null, status: 'OPEN', ts: serverTimestamp() });
                document.getElementById('job-create-panel').classList.add('hidden');
                document.getElementById('job-list-panel').classList.remove('hidden');
                app.loadJobs();
            },
            loadJobs: async () => {
                const list = document.getElementById('job-list');
                list.innerHTML = "LOADING NET...";
                const q = query(collection(db, "jobs"), orderBy("ts", "desc"));
                const snap = await getDocs(q);
                list.innerHTML = "";
                snap.forEach(d => {
                    const j = d.data();
                    const id = d.id;
                    let action = "";
                    if(j.status === 'OPEN' && j.owner !== state.user) {
                        action = `<button onclick="app.acceptJob('${id}')">ACCEPT CONTRACT</button>`;
                    } else if (j.owner === state.user || j.worker === state.user) {
                        action = `<button onclick="app.openJobChat('${id}')" class="warn">OPEN ENCRYPTED LINE</button>`;
                    } else {
                        action = `<button disabled>CONTRACT CLOSED</button>`;
                    }
                    list.innerHTML += `<div class="card"><strong>${j.title}</strong> [${j.status}]<br><em>${j.desc}</em><br><small>CLIENT: ${j.owner}</small><br>${action}</div>`;
                });
            },
            acceptJob: async (jid) => {
                if(!confirm("ACCEPT JOB? DM WILL OPEN.")) return;
                await updateDoc(doc(db, "jobs", jid), { worker: state.user, status: 'ASSIGNED' });
                app.openJobChat(jid);
            },
            openJobChat: (jid) => {
                state.currentJob = jid;
                document.getElementById('job-chat-panel').classList.remove('hidden');
                const q = query(collection(db, "jobs", jid, "msgs"), orderBy("ts", "desc"));
                state.unsubJobChat = onSnapshot(q, (snap) => {
                    const div = document.getElementById('job-chat-box');
                    div.innerHTML = "";
                    const msgs = [];
                    snap.forEach(d => msgs.push(d.data()));
                    msgs.reverse().forEach(m => { div.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}</div>`; });
                    div.scrollTop = div.scrollHeight;
                });
            },
            sendJobMsg: async () => {
                const t = document.getElementById('job-msg-input').value;
                if(!t || !state.currentJob) return;
                await addDoc(collection(db, "jobs", state.currentJob, "msgs"), { u: state.user, txt: t, ts: serverTimestamp() });
                document.getElementById('job-msg-input').value = "";
            },
            closeJobChat: () => {
                document.getElementById('job-chat-panel').classList.add('hidden');
                if(state.unsubJobChat) state.unsubJobChat();
                state.currentJob = null;
                app.loadJobs();
            },
            loadEctoTape: async () => {
                const admins = ["User1234", "User4321"];
                let canPost = admins.includes(state.user);
                if(!canPost) { const w = await getDoc(doc(db, "ectotape_whitelist", state.user)); if(w.exists()) canPost = true; }
                if(canPost) document.getElementById('upload-zone').classList.remove('hidden');
                else document.getElementById('upload-zone').classList.add('hidden');
                const q = query(collection(db, "ectotape_vids"), orderBy("ts", "desc"), limit(20));
                const snap = await getDocs(q);
                const feed = document.getElementById('video-feed');
                feed.innerHTML = "";
                snap.forEach(d => {
                    const v = d.data();
                    feed.innerHTML += `<div class="video-card"><div class="video-thumb"><iframe width="100%" height="150" src="${v.url.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe></div><div class="video-info"><strong>${v.title}</strong><br><small>BY: ${v.uploader}</small></div></div>`;
                });
            },
            uploadVideo: async () => {
                const t = document.getElementById('vid-title').value;
                const u = document.getElementById('vid-url').value;
                if(!t || !u) return alert("MISSING DATA");
                await addDoc(collection(db, "ectotape_vids"), { title: t, url: u, uploader: state.user, ts: serverTimestamp() });
                alert("BROADCASTING"); app.loadEctoTape();
            },
            createClanStart: async () => {
                const n = document.getElementById('create-name').value;
                const p = document.getElementById('create-pass').value;
                if(!n || !p) return;
                drawing.mode = "create";
                drawing.tempData = { name: n, pass: p, syms: {} };
                drawing.letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
                drawing.idx = 0;
                nav.to('draw');
            },
            startSymbolEdit: () => {
                drawing.mode = "edit";
                drawing.tempData = { syms: { ...state.clanData.symbols } };
                drawing.letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
                drawing.idx = 0;
                nav.to('draw');
            },
            addWord: async () => {
                const k = document.getElementById('dict-orig').value.toLowerCase();
                const v = document.getElementById('dict-new').value.toLowerCase();
                if(k && v && state.clan) { await updateDoc(doc(db, "clans", state.clan), { [`words.${k}`]: v }); }
            }
        };

        // --- DRAWING ENGINE ---
        window.drawing = {
            canvas: document.getElementById('draw-canvas'),
            ctx: document.getElementById('draw-canvas').getContext('2d'),
            isDrawing: false, mode: 'create',
            init: () => {
                drawing.ctx.lineWidth=4; drawing.ctx.strokeStyle='#00FF00';
                const start=(x,y)=>{drawing.isDrawing=true;drawing.ctx.beginPath();drawing.ctx.moveTo(x,y);};
                const move=(x,y)=>{if(drawing.isDrawing){drawing.ctx.lineTo(x,y);drawing.ctx.stroke();}};
                drawing.canvas.onmousedown=e=>start(e.offsetX,e.offsetY);
                drawing.canvas.onmousemove=e=>move(e.offsetX,e.offsetY);
                drawing.canvas.onmouseup=()=>drawing.isDrawing=false;
            },
            clear: () => drawing.ctx.clearRect(0,0,300,300),
            cancel: () => nav.to('hub'),
            save: async () => {
                const char = drawing.letters[drawing.idx];
                drawing.tempData.syms[char] = drawing.canvas.toDataURL();
                drawing.idx++;
                if(drawing.idx < drawing.letters.length) {
                    drawing.clear(); document.getElementById('draw-title').innerText = "DRAW: " + drawing.letters[drawing.idx];
                } else {
                    loading(true);
                    if(drawing.mode === 'create') {
                        await setDoc(doc(db, "clans", drawing.tempData.name), { pass: drawing.tempData.pass, leader: state.user, symbols: drawing.tempData.syms, words: {}, ranks: { [state.user]: 'leader' } });
                        await updateDoc(doc(db, "users", state.user), { clan: drawing.tempData.name });
                    } else if (drawing.mode === 'edit') {
                        await updateDoc(doc(db, "clans", state.clan), { symbols: drawing.tempData.syms });
                    }
                    loading(false); nav.to('hub');
                }
            }
        };
        drawing.init();
        
        // --- INIT LOAD SETTINGS ---
        settings.load();

    </script>
</body>
</html>
