<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAN_NET // SYSTEM_V3.2 - TACTICAL_AUDIO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #000000;
            --main-color: #00FF00;
            --dim-color: #004400;
            --warn-color: #FFAA00;
            --err-color: #FF0000;
            --rep-good: #00FF00;
            --rep-watch: #D000FF;
            --rep-black: #FF0000;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            font-size: 14px;
            padding-top: 40px; /* Space for alert banner */
        }

        /* --- UI COMPONENTS --- */
        .hidden { display: none !important; }
        .screen { max-width: 800px; margin: 0 auto; border: 1px solid var(--dim-color); padding: 15px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.1); position: relative; margin-bottom: 20px; background: rgba(0,0,0,0.9); }
        
        button, input, select, textarea {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid var(--dim-color);
            color: var(--main-color);
            padding: 10px;
            margin-bottom: 8px;
            font-family: var(--font-main);
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }

        button:hover { background: var(--main-color); color: var(--bg-color); cursor: pointer; font-weight: bold; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.danger { border-color: var(--err-color); color: var(--err-color); }
        button.danger:hover { background: var(--err-color); color: white; }
        button.warn { border-color: var(--warn-color); color: var(--warn-color); }
        button.warn:hover { background: var(--warn-color); color: black; } 
        button.admin { border-color: cyan; color: cyan; border-style: double; }
        button.admin:hover { background: cyan; color: black; }
        
        /* DELETE BUTTONS */
        .del-btn { 
            display: inline-block; width: auto; padding: 2px 5px; font-size: 10px; 
            border: 1px solid var(--err-color); color: var(--err-color); background: transparent; 
            margin-left: 5px; cursor: pointer; 
        }
        .del-btn:hover { background: var(--err-color); color: black; }

        /* SOCIAL ACTIONS */
        .social-actions { display: flex; gap: 5px; margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; }
        .social-btn { flex: 1; font-size: 10px; padding: 5px; background: transparent; border: 1px solid #333; cursor: pointer; color: #888; }
        .social-btn:hover { background: #111; border-color: var(--main-color); color: var(--main-color); }
        .active-action { color: var(--warn-color) !important; border-color: var(--warn-color) !important; font-weight: bold; }

        /* COMMENTS SECTION */
        .comment-item { border-bottom: 1px solid #222; padding: 6px 0; font-size: 0.9em; word-wrap: break-word; }
        
        /* LAYOUT */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .card { border: 1px dashed var(--dim-color); padding: 10px; margin-bottom: 10px; position: relative; }
        .chat-box { height: 250px; overflow-y: scroll; border: 1px solid #222; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); }
        .chat-msg { margin-bottom: 8px; border-bottom: 1px solid #111; padding-bottom: 4px; font-size: 0.9em; word-wrap: break-word; }
        .chat-img { height: 20px; vertical-align: middle; filter: sepia(1) hue-rotate(50deg) saturate(5); }
        
        /* PTT BUTTON */
        #btn-ptt {
            user-select: none; -webkit-user-select: none;
            touch-action: manipulation;
            transition: all 0.1s;
        }
        #btn-ptt:active {
            background: var(--warn-color) !important;
            color: black !important;
            transform: scale(0.98);
        }
        .transmitting {
            background: var(--warn-color) !important;
            color: black !important;
            box-shadow: 0 0 15px var(--warn-color);
        }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; color: var(--main-color); font-size: 1.5em; border: 2px solid var(--dim-color); }
        .poll-bar { height: 10px; background: #333; margin-top: 2px; position: relative; }
        .poll-fill { height: 100%; background: var(--main-color); width: 0%; transition: width 0.5s; }
        .post-header { display: flex; justify-content: space-between; font-size: 0.8em; color: #888; border-bottom: 1px solid #333; margin-bottom: 5px; }
        .vid-embed { width: 100%; height: 200px; border: none; margin-top: 10px; background: #000; }

        /* ALERT SYSTEM STYLES */
        #sys-alert-banner { position: fixed; top: 0; left: 0; width: 100%; min-height: 30px; z-index: 10000; display: flex; align-items: center; justify-content: center; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s; background: #002200; color: #00FF00; border-bottom: 2px solid #00FF00; }
        .alert-off { transform: translateY(-100%); }
        .alert-on { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- SYSTEM ALERT BANNER -->
    <div id="sys-alert-banner" class="alert-off">
        <span id="sys-alert-msg">SYSTEM NORMAL</span>
        <button onclick="document.getElementById('sys-alert-banner').classList.add('alert-off')" style="background:transparent; border:none; color:inherit; font-size:16px; margin-left:20px; cursor:pointer; width:auto;">[X]</button>
    </div>

    <div id="loading-overlay" class="hidden">>> INITIALIZING NEURAL LINK...</div>

    <!-- AUTH SCREEN -->
    <div id="screen-auth" class="screen">
        <h1>// NET_LOGIN_V3.2</h1>
        <input type="text" id="auth-user" placeholder="USERNAME">
        <input type="password" id="auth-pass" placeholder="PASSWORD">
        <button onclick="app.login()">AUTHENTICATE</button>
        <button onclick="app.register()" style="border-style: dashed; opacity: 0.7;">REGISTER IDENTITY</button>
    </div>

    <!-- HUB SCREEN -->
    <div id="screen-hub" class="screen hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div onclick="app.openProfile(state.user)" style="cursor: pointer;">
                USER: <span id="hub-user"></span>
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="app.openProfile(state.user)" style="width: auto; padding: 5px 10px; font-size: 10px;">PROFILE</button>
                <button onclick="nav.to('settings')" style="width: auto; padding: 5px 10px; font-size: 10px;">CONFIG</button>
            </div>
        </div>
        <div style="margin-bottom: 10px;">
            <span id="hub-rep">REP: <span id="rep-badge">LOADING...</span></span>
        </div>
        
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <input type="text" id="search-user-input" placeholder="SEARCH EXACT USERNAME..." style="margin:0;">
            <button onclick="app.searchUser()" style="width: 80px; margin:0;">FIND</button>
        </div>

        <hr style="border-color: var(--dim-color);">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
            <button onclick="nav.tab('clans')">CLANS</button>
            <button onclick="nav.to('social')">NET_SOCIAL</button>
            <button onclick="nav.to('jobs')">JOBS / GIGS</button>
            <button onclick="nav.to('events')">EVENTS</button>
            <button onclick="nav.tab('global')">GLOBAL COMMS</button>
            
            <button onclick="nav.to('news')" style="color: cyan; border-color: cyan;">[ WORLD_WIRE ]</button>
            <button onclick="nav.to('ectotape')" style="border-color: var(--rep-watch); color: var(--rep-watch);">[ ECTOTAPE ]</button>
        </div>

        <!-- CLANS TAB -->
        <div id="tab-clans">
            <div id="panel-no-clan">
                <button onclick="nav.to('create')">INITIALIZE NEW CLAN</button>
                <div style="border: 1px solid var(--dim-color); padding: 10px; margin-top: 10px;">
                    <p style="margin: 0 0 5px 0;">SEARCH NETWORK:</p>
                    <input type="text" id="join-name" placeholder="EXACT CLAN NAME">
                    <input type="password" id="join-pass" placeholder="ACCESS KEY">
                    <button onclick="app.joinClan()">CONNECT</button>
                </div>
            </div>
            <div id="panel-in-clan" class="hidden">
                <h2 id="clan-header">CLAN_NAME</h2>
                
                <!-- NEW PTT VOICE COMMS -->
                <div style="border: 1px solid var(--warn-color); padding: 5px; margin-bottom: 10px; background: rgba(50,20,0,0.2);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <small style="color:var(--warn-color);">TACTICAL AUDIO (WALKIE-TALKIE)</small>
                        <div id="voice-status-dot" style="width:8px; height:8px; border-radius:50%; background:red;"></div>
                    </div>
                    
                    <div id="voice-controls" class="hidden" style="margin-top:5px;">
                        <button id="btn-ptt" style="font-weight:bold; height:50px; border: 2px solid var(--warn-color);">HOLD TO TALK</button>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px;">
                            <span id="voice-status-text" style="font-size:10px; color:#888;">STANDBY</span>
                            <button onclick="voice.toggleMute()" id="btn-mute" style="width:auto; padding:2px 5px; font-size:10px;">MUTE AUDIO</button>
                        </div>
                    </div>

                    <button onclick="voice.connect()" id="btn-connect-voice" style="margin-top:5px;">CONNECT COMMS CHANNEL</button>
                    
                    <div id="voice-log" style="font-size:10px; color:#555; max-height:40px; overflow-y:scroll; margin-top:5px; font-family:monospace;"></div>
                </div>

                <div class="chat-box" id="clan-chat"></div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="clan-input" placeholder="Secure Message..." style="margin:0;">
                    <button onclick="app.sendClanMsg()" style="width: 60px;">SEND</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
                    <button onclick="app.loadRoster()">ROSTER / RANKS</button>
                    <button onclick="app.leaveClan()" class="danger">LEAVE</button>
                </div>
            </div>
        </div>

        <!-- GLOBAL TAB -->
        <div id="tab-global" class="hidden">
            <p style="font-size: 0.8em; opacity: 0.7;">// PUBLIC FREQUENCY</p>
            <div class="chat-box" id="global-chat"></div>
            <input type="text" id="global-input" placeholder="Public Comment...">
            <button onclick="app.sendGlobalMsg()">POST COMMENT</button>
        </div>
        
        <button onclick="location.reload()" style="margin-top: 20px; border: none; opacity: 0.5;">LOGOUT</button>
    </div>

    <!-- SOCIAL SCREEN -->
    <div id="screen-social" class="screen hidden">
        <h2>// NET_SOCIAL</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="social.tab('posts')">POSTS</button>
            <button onclick="social.tab('polls')">POLLS</button>
        </div>
        <div id="soc-tab-posts">
            <div style="border-bottom: 1px dashed #333; padding-bottom: 10px; margin-bottom: 10px;">
                <textarea id="post-content" placeholder="What's happening?" style="height: 60px;"></textarea>
                <input type="text" id="post-video" placeholder="Youtube URL (Optional)">
                <button onclick="social.createPost()">PUBLISH POST</button>
            </div>
            <div id="feed-posts" style="height: 400px; overflow-y: scroll;"></div>
        </div>
        <div id="soc-tab-polls" class="hidden">
            <button onclick="document.getElementById('poll-creator').classList.remove('hidden')">CREATE NEW POLL</button>
            <div id="poll-creator" class="hidden card">
                <input type="text" id="poll-q" placeholder="Question">
                <input type="text" id="poll-o1" placeholder="Option 1">
                <input type="text" id="poll-o2" placeholder="Option 2">
                <button onclick="social.createPoll()">LAUNCH POLL</button>
            </div>
            <div id="feed-polls" style="height: 400px; overflow-y: scroll; margin-top: 10px;"></div>
        </div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <!-- ECTOTAPE SCREEN -->
    <div id="screen-ectotape" class="screen hidden">
        <h2 style="color:var(--rep-watch);text-align:center;">// ECTOTAPE_STREAM</h2>
        <div id="upload-zone" style="border:1px solid #333; padding:10px; margin-bottom:10px;">
            <input type="text" id="vid-title" placeholder="TITLE">
            <input type="text" id="vid-url" placeholder="YOUTUBE URL (e.g. youtube.com/watch?v=...)">
            <button onclick="app.uploadVideo()">BROADCAST</button>
        </div>
        <div id="video-feed" style="height:400px;overflow-y:scroll;"></div>
        <button onclick="nav.to('hub')">EXIT</button>
    </div>

    <!-- NEWS SCREEN -->
    <div id="screen-news" class="screen hidden" style="border-color: cyan;">
        <h2 style="color: cyan;">// WORLD_WIRE</h2>
        <div style="border: 1px solid #333; padding: 5px; margin-bottom: 10px;">
             <input type="text" id="news-headline" placeholder="Headline...">
             <input type="text" id="news-link-input" placeholder="Source URL (Optional)...">
             <button onclick="news.post()" class="admin">BROADCAST UPDATE</button>
        </div>
        <div id="news-feed-internal" style="height: 300px; overflow-y: scroll; border: 1px solid #333; margin-bottom: 20px; padding: 5px;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <!-- PROFILE SCREEN -->
    <div id="screen-profile" class="screen hidden">
        <h2 id="prof-header">// USER_PROFILE</h2>
        <div class="card">
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="prof-pfp-display" style="width: 50px; height: 50px; background: #222; border: 1px solid var(--main-color); background-size: cover; background-position: center;"></div>
                <div>
                    <h3 id="prof-displayname" style="margin: 0;"></h3>
                    <small id="prof-username" style="color: #888;"></small>
                </div>
            </div>
        </div>
        <div id="prof-details">
            <p>CLAN: <span id="prof-clan">LOADING...</span></p>
            <p>STATUS: <span id="prof-rep">LOADING...</span></p>
        </div>
        <div id="prof-edit-panel" class="hidden" style="border-top: 1px solid #333; padding-top: 10px; margin-top: 10px;">
            <input type="text" id="edit-disp" placeholder="New Display Name">
            <input type="text" id="edit-pfp" placeholder="PFP Image URL">
            <button onclick="app.saveProfile()">SAVE CHANGES</button>
        </div>
        <button onclick="nav.to('hub')" style="margin-top: 10px;">BACK</button>
    </div>

    <!-- OTHER SCREENS -->
    <div id="screen-ranks" class="screen hidden">
        <h3>// ROSTER_CONTROL</h3>
        <div id="roster-list" style="height: 300px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-settings" class="screen hidden">
        <h2>// SYSTEM_CONFIG</h2>
        <div class="grid-2">
            <div>BG: <input type="color" id="col-bg" onchange="settings.apply()"></div>
            <div>MAIN: <input type="color" id="col-main" onchange="settings.apply()"></div>
        </div>
        <button onclick="settings.reset()" class="danger" style="margin-top:20px;">RESET DEFAULTS</button>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-events" class="screen hidden">
        <h2>// EVENT_LOG</h2>
        <div style="border:1px solid #333;padding:10px;margin-bottom:10px;"><input type="text" id="evt-name" placeholder="EVENT NAME"><input type="text" id="evt-desc" placeholder="DESCRIPTION"><div class="grid-2"><input type="date" id="evt-start"><input type="date" id="evt-end"></div><button onclick="app.createEvent()">PUBLISH</button></div>
        <div id="event-list" style="height:200px;overflow-y:scroll;"></div><button onclick="nav.to('hub')">BACK</button>
    </div>
    
    <div id="screen-jobs" class="screen hidden">
        <h2>// GIG_NETWORK</h2>
        <div class="grid-2"><button onclick="document.getElementById('job-create-panel').classList.remove('hidden');">POST JOB</button><button onclick="app.loadJobs()">BROWSE</button></div>
        <div id="job-create-panel" class="hidden" style="margin-top:10px;border:1px dashed #333;padding:10px;"><input type="text" id="job-title" placeholder="TITLE"><textarea id="job-desc" placeholder="DESC"></textarea><button onclick="app.createJob()">UPLOAD</button></div>
        <div id="job-list-panel" style="margin-top:10px;"><div id="job-list" style="height:300px;overflow-y:scroll;"></div></div>
        <div id="job-chat-panel" class="hidden" style="position:absolute;top:0;left:0;width:100%;height:100%;background:var(--bg-color);z-index:10;padding:15px;"><div id="job-chat-box" class="chat-box" style="height:300px;"></div><input type="text" id="job-msg-input"><button onclick="app.sendJobMsg()">SEND</button><button onclick="app.closeJobChat()" class="warn">CLOSE</button></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>
    
    <div id="screen-create" class="screen hidden"><h2>// NEW_CLAN</h2><input type="text" id="create-name" placeholder="NAME"><input type="password" id="create-pass" placeholder="PASS"><button onclick="app.createClan()">CREATE</button><button onclick="nav.to('hub')">CANCEL</button></div>

    <!-- COMMENT OVERLAY -->
    <div id="comment-overlay" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9000;display:flex;justify-content:center;align-items:center;">
        <div class="screen" style="width:90%; height:80%; display:flex; flex-direction:column; background: #000; border: 1px solid var(--main-color);">
            <div style="display:flex; justify-content:space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom:10px;">
                <h3 style="margin:0;">// COMMENTS_THREAD</h3>
                <button onclick="social.closeComments()" class="warn" style="width:auto; padding: 2px 10px;">CLOSE [X]</button>
            </div>
            <div id="active-comment-list" style="flex:1; overflow-y:scroll; padding:10px; margin-bottom:10px; border: 1px solid #222;"></div>
            <input type="text" id="new-comment-input" placeholder="Add comment...">
            <button onclick="social.submitComment()">POST COMMENT</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, where, getDocs, deleteField, deleteDoc, arrayUnion, arrayRemove } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "", authDomain: "ectenopo.firebaseapp.com", projectId: "ectenopo", storageBucket: "ectenopo.firebasestorage.app", messagingSenderId: "283760497520", appId: "1:283760497520:web:c9fdda2d704ca95c0bf5b5" };
        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        const loading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);

        // --- STATE & UTILS ---
        window.state = { user: null, clan: null, clanData: {}, viewedProfile: null, activeCommentId: null, activeCommentType: null };
        window.nav = {
            to: (id) => {
                document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
                document.getElementById('screen-' + id).classList.remove('hidden');
                if(id === 'hub') app.initHub();
                if(id === 'jobs') app.loadJobs();
                if(id === 'social') social.loadPosts();
                if(id === 'ectotape') app.loadEctoTape();
                if(id === 'news') news.init();
            },
            tab: (t) => { 
                document.getElementById('tab-clans').classList.add('hidden'); 
                document.getElementById('tab-global').classList.add('hidden'); 
                document.getElementById('tab-' + t).classList.remove('hidden'); 
            }
        };

        // --- VOICE CHAT (PUSH TO TALK) ---
        window.voice = {
            mediaRecorder: null,
            chunks: [],
            unsub: null,
            isMuted: false,
            isRecording: false,
            init: () => {
                // Setup PTT Button
                const btn = document.getElementById('btn-ptt');
                
                const startTx = () => {
                    if(!voice.mediaRecorder || voice.mediaRecorder.state === 'recording') return;
                    voice.chunks = [];
                    voice.mediaRecorder.start();
                    voice.isRecording = true;
                    btn.classList.add('transmitting');
                    btn.innerText = "TRANSMITTING...";
                    document.getElementById('voice-status-text').innerText = "MIC LIVE";
                    document.getElementById('voice-status-text').style.color = "red";
                };

                const stopTx = () => {
                    if(!voice.mediaRecorder || voice.mediaRecorder.state !== 'recording') return;
                    voice.mediaRecorder.stop(); // Triggers ondataavailable then onstop
                    voice.isRecording = false;
                    btn.classList.remove('transmitting');
                    btn.innerText = "HOLD TO TALK";
                    document.getElementById('voice-status-text').innerText = "STANDBY";
                    document.getElementById('voice-status-text').style.color = "#888";
                };

                // Mouse & Touch Events
                btn.addEventListener('mousedown', startTx);
                btn.addEventListener('mouseup', stopTx);
                btn.addEventListener('mouseleave', stopTx);
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); startTx(); });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); stopTx(); });
            },
            connect: async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    voice.mediaRecorder = new MediaRecorder(stream);
                    
                    voice.mediaRecorder.ondataavailable = (e) => {
                        voice.chunks.push(e.data);
                    };

                    voice.mediaRecorder.onstop = async () => {
                        if(voice.chunks.length === 0) return;
                        const blob = new Blob(voice.chunks, { 'type' : 'audio/ogg; codecs=opus' });
                        
                        // Convert to Base64
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = async () => {
                            const base64data = reader.result;
                            // Upload to Firestore
                            if(state.clan) {
                                await addDoc(collection(db, "clans", state.clan, "voice_comms"), {
                                    u: state.user,
                                    audio: base64data,
                                    ts: serverTimestamp()
                                });
                                voice.log(">> SENT TRANSMISSION");
                            }
                        };
                    };

                    // UI Updates
                    document.getElementById('voice-controls').classList.remove('hidden');
                    document.getElementById('btn-connect-voice').classList.add('hidden');
                    document.getElementById('voice-status-dot').style.background = "#00FF00";
                    document.getElementById('voice-status-dot').style.boxShadow = "0 0 5px #00FF00";
                    voice.init(); // Bind listeners
                    voice.listen(); // Start listening for others
                    voice.log(">> COMMS CHANNEL OPEN. PRESS PTT TO SPEAK.");

                } catch(e) {
                    alert("MIC ACCESS DENIED. CHECK PERMISSIONS.");
                    console.error(e);
                }
            },
            listen: () => {
                if(!state.clan) return;
                const q = query(collection(db, "clans", state.clan, "voice_comms"), orderBy("ts", "desc"), limit(1));
                
                voice.unsub = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            // Only play if it's new (roughly) and not me
                            const now = Date.now();
                            const msgTime = data.ts ? data.ts.toMillis() : now;
                            
                            if (data.u !== state.user && (now - msgTime < 10000) && !voice.isMuted) {
                                const audio = new Audio(data.audio);
                                audio.play().catch(e => console.log("Audio play error", e));
                                voice.log(`>> RX: ${data.u}`);
                                document.getElementById('voice-status-text').innerText = `RX: ${data.u}`;
                                audio.onended = () => {
                                     document.getElementById('voice-status-text').innerText = "STANDBY";
                                };
                            }
                        }
                    });
                });
            },
            toggleMute: () => {
                voice.isMuted = !voice.isMuted;
                const btn = document.getElementById('btn-mute');
                if(voice.isMuted) {
                    btn.classList.add('warn');
                    btn.innerText = "UNMUTE";
                } else {
                    btn.classList.remove('warn');
                    btn.innerText = "MUTE AUDIO";
                }
            },
            log: (msg) => {
                const l = document.getElementById('voice-log');
                l.innerHTML += `<div>${msg}</div>`;
                l.scrollTop = l.scrollHeight;
            }
        };

        // --- MAIN APP ---
        window.app = {
            login: async () => {
                const u = document.getElementById('auth-user').value.trim(); const p = document.getElementById('auth-pass').value.trim();
                if(!u || !p) return; loading(true);
                const docSnap = await getDoc(doc(db, "users", u)); loading(false);
                if (docSnap.exists() && docSnap.data().pass === p) { 
                    state.user = u; 
                    nav.to('hub'); 
                } else alert("INVALID");
            },
            register: async () => {
                const u = document.getElementById('auth-user').value.trim(); const p = document.getElementById('auth-pass').value.trim();
                if(!u || !p) return; loading(true);
                const check = await getDoc(doc(db, "users", u));
                if (check.exists()) { loading(false); return alert("TAKEN"); }
                await setDoc(doc(db, "users", u), { pass: p, clan: null, rep: 0, displayName: u, verified: false, pfp: "", private: false });
                loading(false); alert("REGISTERED");
            },
            initHub: async () => {
                loading(true);
                const docSnap = await getDoc(doc(db, "users", state.user)); 
                const userData = docSnap.data();
                document.getElementById('hub-user').innerText = userData.displayName || state.user;
                document.getElementById('hub-rep').innerText = "REP: " + (userData.rep || 0);

                if(userData.clan) { 
                    state.clan = userData.clan; 
                    document.getElementById('panel-no-clan').classList.add('hidden'); 
                    document.getElementById('panel-in-clan').classList.remove('hidden'); 
                    document.getElementById('clan-header').innerText = userData.clan;
                    app.initClanChat();
                } else { 
                    state.clan = null; 
                    document.getElementById('panel-no-clan').classList.remove('hidden'); 
                    document.getElementById('panel-in-clan').classList.add('hidden'); 
                }
                loading(false);
                
                // Global Chat
                const q = query(collection(db, "global_chat"), orderBy("ts", "desc"), limit(50));
                onSnapshot(q, (snap) => {
                    const d = document.getElementById('global-chat'); d.innerHTML = "";
                    const msgs = []; snap.forEach(doc => msgs.push({id: doc.id, ...doc.data()}));
                    msgs.reverse().forEach(m => {
                        let del = (m.u === state.user) ? `<button class="del-btn" onclick="app.deleteItem('global_chat', '${m.id}')">DEL</button>` : '';
                        d.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}${del}</div>`;
                    });
                    d.scrollTop = d.scrollHeight;
                });
            },
            initClanChat: () => {
                const q = query(collection(db, "clans", state.clan, "msgs"), orderBy("ts", "desc"), limit(50));
                onSnapshot(q, (snap) => { 
                    const d = document.getElementById('clan-chat'); 
                    d.innerHTML = ""; 
                    const msgs = []; 
                    snap.forEach(doc => msgs.push({id: doc.id, ...doc.data()})); 
                    msgs.reverse().forEach(m => { 
                        let del = (m.u === state.user) ? `<button class="del-btn" onclick="app.deleteItem('clans/${state.clan}/msgs', '${m.id}')">DEL</button>` : '';
                        d.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}${del}</div>`; 
                    }); 
                    d.scrollTop = d.scrollHeight; 
                });
            },
            sendGlobalMsg: async () => { const t = document.getElementById('global-input').value; if(t) { await addDoc(collection(db, "global_chat"), { u: state.user, txt: t, ts: serverTimestamp() }); document.getElementById('global-input').value=""; } },
            sendClanMsg: async () => { const t = document.getElementById('clan-input').value; if(t) { await addDoc(collection(db, "clans", state.clan, "msgs"), { u: state.user, txt: t, ts: serverTimestamp() }); document.getElementById('clan-input').value=""; } },
            
            // PROFILE & SEARCH
            searchUser: () => { const u = document.getElementById('search-user-input').value.trim(); if(u) app.openProfile(u); },
            openProfile: async (targetUser) => {
                loading(true); const snap = await getDoc(doc(db, "users", targetUser)); loading(false);
                if(!snap.exists()) return alert("USER NOT FOUND");
                const d = snap.data(); state.viewedProfile = targetUser;
                document.getElementById('prof-username').innerText = "@" + targetUser; document.getElementById('prof-displayname').innerText = d.displayName || targetUser;
                const pfp = d.pfp || ""; document.getElementById('prof-pfp-display').style.backgroundImage = pfp ? `url('${pfp}')` : "none";
                document.getElementById('prof-clan').innerText = d.clan || "NONE"; document.getElementById('prof-rep').innerText = d.rep || "0";
                if(targetUser === state.user) { document.getElementById('prof-edit-panel').classList.remove('hidden'); document.getElementById('edit-disp').value = d.displayName || ""; document.getElementById('edit-pfp').value = d.pfp || ""; }
                else { document.getElementById('prof-edit-panel').classList.add('hidden'); }
                nav.to('profile');
            },
            saveProfile: async () => { const dn = document.getElementById('edit-disp').value.trim(); const pf = document.getElementById('edit-pfp').value.trim(); await updateDoc(doc(db, "users", state.user), { displayName: dn, pfp: pf }); alert("SAVED"); app.openProfile(state.user); },

            // CLAN MANAGEMENT
            joinClan: async () => { const n = document.getElementById('join-name').value.trim(); const p = document.getElementById('join-pass').value.trim(); const s = await getDoc(doc(db, "clans", n)); if(s.exists() && s.data().pass === p) { await updateDoc(doc(db, "users", state.user), { clan: n }); await updateDoc(doc(db, "clans", n), { [`ranks.${state.user}`]: 'member' }); nav.to('hub'); } else alert("INVALID"); },
            createClan: async () => { const n=document.getElementById('create-name').value; const p=document.getElementById('create-pass').value; if(!n||!p) return; await setDoc(doc(db, "clans", n), { pass: p, leader: state.user, ranks: { [state.user]: 'leader' } }); await updateDoc(doc(db, "users", state.user), { clan: n }); nav.to('hub'); },
            leaveClan: async () => { if(!confirm("LEAVE?")) return; await updateDoc(doc(db, "users", state.user), { clan: null }); await updateDoc(doc(db, "clans", state.clan), { [`ranks.${state.user}`]: deleteField() }); nav.to('hub'); },
            loadRoster: async () => { 
                nav.to('ranks'); 
                const snap = await getDoc(doc(db, "clans", state.clan));
                const ranks = snap.data().ranks || {}; 
                const list = document.getElementById('roster-list'); list.innerHTML = ""; 
                for (const [member, rank] of Object.entries(ranks)) { 
                    list.innerHTML += `<div class="card"><span>${member} <span style="color:yellow">[${rank.toUpperCase()}]</span></span></div>`; 
                } 
            },

            // CONTENT CREATION
            createEvent: async () => { const n = document.getElementById('evt-name').value; if(!n) return; await addDoc(collection(db, "events"), { name: n, desc: document.getElementById('evt-desc').value, start: document.getElementById('evt-start').value, end: document.getElementById('evt-end').value, creator: state.user, ts: serverTimestamp() }); alert("CREATED"); app.loadEvents(); },
            loadEvents: async () => { const list = document.getElementById('event-list'); list.innerHTML = "LOADING..."; const q = query(collection(db, "events"), orderBy("start", "asc")); const snap = await getDocs(q); list.innerHTML = ""; snap.forEach(d => { const e = d.data(); let del = (e.creator === state.user) ? `<button class="del-btn" onclick="app.deleteItem('events', '${d.id}', app.loadEvents)">DEL</button>` : ''; list.innerHTML += `<div class="card"><strong style="color:white;">${e.name}</strong>${del}<br><span>${e.start} // ${e.end || '?'}</span><br><p>${e.desc}</p><small>ORG: ${e.creator}</small></div>`; }); },
            
            // JOBS
            createJob: async () => { const t = document.getElementById('job-title').value; if(!t) return; await addDoc(collection(db, "jobs"), { title: t, desc: document.getElementById('job-desc').value, owner: state.user, worker: null, status: 'OPEN', ts: serverTimestamp() }); alert("POSTED"); app.loadJobs(); },
            loadJobs: async () => { const list = document.getElementById('job-list'); list.innerHTML = "LOADING..."; const q = query(collection(db, "jobs"), orderBy("ts", "desc")); const snap = await getDocs(q); list.innerHTML = ""; snap.forEach(d => { const j = d.data(); const id = d.id; let action = ""; if(j.status === 'OPEN' && j.owner !== state.user) action = `<button onclick="app.acceptJob('${id}')">ACCEPT</button>`; else if (j.owner === state.user || j.worker === state.user) action = `<button onclick="app.openJobChat('${id}')" class="warn">OPEN CHAT</button>`; else action = `<button disabled>CLOSED</button>`; let del = (j.owner === state.user) ? `<button class="del-btn" onclick="app.deleteItem('jobs', '${id}', app.loadJobs)">DEL</button>` : ''; list.innerHTML += `<div class="card"><strong>${j.title}</strong> [${j.status}]${del}<br><em>${j.desc}</em><br><small>CLIENT: ${j.owner}</small><br>${action}</div>`; }); },
            acceptJob: async (jid) => { if(!confirm("ACCEPT?")) return; await updateDoc(doc(db, "jobs", jid), { worker: state.user, status: 'ASSIGNED' }); app.openJobChat(jid); },
            openJobChat: (jid) => { document.getElementById('job-chat-panel').classList.remove('hidden'); state.currentJob = jid; onSnapshot(query(collection(db, "jobs", jid, "msgs"), orderBy("ts", "desc")), (snap) => { const div = document.getElementById('job-chat-box'); div.innerHTML = ""; const msgs = []; snap.forEach(d => msgs.push({id:d.id, ...d.data()})); msgs.reverse().forEach(m => { let del = (m.u === state.user) ? `<button class="del-btn" onclick="app.deleteItem('jobs/${jid}/msgs', '${m.id}')">DEL</button>` : ''; div.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}${del}</div>`; }); div.scrollTop = div.scrollHeight; }); },
            sendJobMsg: async () => { const t = document.getElementById('job-msg-input').value; if(t) await addDoc(collection(db, "jobs", state.currentJob, "msgs"), { u: state.user, txt: t, ts: serverTimestamp() }); document.getElementById('job-msg-input').value = ""; },
            closeJobChat: () => { document.getElementById('job-chat-panel').classList.add('hidden'); state.currentJob = null; },

            // ECTOTAPE (FIXED)
            loadEctoTape: async () => { 
                const q = query(collection(db, "ectotape_vids"), orderBy("ts", "desc"), limit(20)); 
                const snap = await getDocs(q); 
                const feed = document.getElementById('video-feed'); 
                feed.innerHTML = ""; 
                snap.forEach(d => { 
                    const v = d.data(); 
                    let del = (v.uploader === state.user) ? `<button class="del-btn" onclick="app.deleteItem('ectotape_vids', '${d.id}', app.loadEctoTape)">DEL</button>` : '';
                    
                    // Fixed Youtube Embed logic
                    let embedUrl = "";
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                    const match = v.url.match(regExp);
                    if (match && match[2].length == 11) {
                        embedUrl = "https://www.youtube.com/embed/" + match[2];
                    }

                    if(embedUrl) {
                        feed.innerHTML += `<div class="card"><strong>${v.title}</strong>${del}<iframe width="100%" height="200" src="${embedUrl}" frameborder="0" allowfullscreen></iframe></div>`; 
                    } else {
                        feed.innerHTML += `<div class="card"><strong>${v.title}</strong>${del}<br><span style="color:red;">INVALID VIDEO URL</span></div>`;
                    }
                }); 
            },
            uploadVideo: async () => { 
                const t = document.getElementById('vid-title').value;
                const u = document.getElementById('vid-url').value;
                if(!t || !u) return;
                await addDoc(collection(db, "ectotape_vids"), { title: t, url: u, uploader: state.user, ts: serverTimestamp() }); 
                alert("UPLOADED"); app.loadEctoTape(); 
            },

            // UNIVERSAL DELETE
            deleteItem: async (collectionPath, id, callback) => {
                if(!confirm("DELETE ITEM?")) return;
                try {
                    await deleteDoc(doc(db, collectionPath, id));
                    if(callback) callback();
                } catch(e) {
                    console.error(e);
                    alert("ERROR DELETING");
                }
            }
        };

        // --- SOCIAL MODULE ---
        window.social = {
            tab: (t) => { document.getElementById('soc-tab-posts').classList.add('hidden'); document.getElementById('soc-tab-polls').classList.add('hidden'); document.getElementById('soc-tab-' + t).classList.remove('hidden'); if(t === 'posts') social.loadPosts(); if(t === 'polls') social.loadPolls(); },
            like: async (id, type) => { const col = type === 'post' ? 'posts' : 'polls'; const ref = doc(db, col, id); const snap = await getDoc(ref); const d = snap.data(); const likes = d.likes || []; const dislikes = d.dislikes || []; if(likes.includes(state.user)) await updateDoc(ref, { likes: arrayRemove(state.user) }); else { await updateDoc(ref, { likes: arrayUnion(state.user) }); if(dislikes.includes(state.user)) await updateDoc(ref, { dislikes: arrayRemove(state.user) }); } type === 'post' ? social.loadPosts() : social.loadPolls(); },
            dislike: async (id, type) => { const col = type === 'post' ? 'posts' : 'polls'; const ref = doc(db, col, id); const snap = await getDoc(ref); const d = snap.data(); const likes = d.likes || []; const dislikes = d.dislikes || []; if(dislikes.includes(state.user)) await updateDoc(ref, { dislikes: arrayRemove(state.user) }); else { await updateDoc(ref, { dislikes: arrayUnion(state.user) }); if(likes.includes(state.user)) await updateDoc(ref, { likes: arrayRemove(state.user) }); } type === 'post' ? social.loadPosts() : social.loadPolls(); },
            openComments: (id, type) => { state.activeCommentId = id; state.activeCommentType = type; const col = type === 'post' ? 'posts' : 'polls'; document.getElementById('comment-overlay').classList.remove('hidden'); const q = query(collection(db, col, id, "comments"), orderBy("ts", "desc")); onSnapshot(q, (snap) => { const div = document.getElementById('active-comment-list'); div.innerHTML = ""; if(snap.empty) div.innerHTML = "<div style='color:#555;'>No comments yet.</div>"; snap.forEach(d => { const c = d.data(); let del = (c.u === state.user) ? `<button class="del-btn" onclick="app.deleteItem('${col}/${id}/comments', '${d.id}')">DEL</button>` : ''; div.innerHTML += `<div class="comment-item"><strong>${c.u}:</strong> ${c.txt}${del}</div>`; }); }); },
            closeComments: () => { document.getElementById('comment-overlay').classList.add('hidden'); },
            submitComment: async () => { const txt = document.getElementById('new-comment-input').value.trim(); if(!txt || !state.activeCommentId) return; const col = state.activeCommentType === 'post' ? 'posts' : 'polls'; await addDoc(collection(db, col, state.activeCommentId, "comments"), { u: state.user, txt: txt, ts: serverTimestamp() }); document.getElementById('new-comment-input').value = ""; },
            createPost: async () => { const txt = document.getElementById('post-content').value; const vid = document.getElementById('post-video').value; if(!txt) return; await addDoc(collection(db, "posts"), { u: state.user, txt: txt, video: vid || null, ts: serverTimestamp(), likes: [], dislikes: [] }); document.getElementById('post-content').value = ""; document.getElementById('post-video').value = ""; social.loadPosts(); },
            loadPosts: async () => { const div = document.getElementById('feed-posts'); div.innerHTML = "LOADING FEED..."; const q = query(collection(db, "posts"), orderBy("ts", "desc"), limit(20)); const snap = await getDocs(q); div.innerHTML = ""; snap.forEach(d => { const p = d.data(); const likes = (p.likes || []).length; const dislikes = (p.dislikes || []).length; const userLiked = (p.likes || []).includes(state.user) ? "active-action" : ""; const userDisliked = (p.dislikes || []).includes(state.user) ? "active-action" : ""; 
                let vidHtml = ""; if(p.video) { const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/; const match = p.video.match(regExp); if (match && match[2].length == 11) vidHtml = `<iframe class="vid-embed" src="https://www.youtube.com/embed/${match[2]}" allowfullscreen></iframe>`; }
                let del = (p.u === state.user) ? `<button class="del-btn" onclick="app.deleteItem('posts', '${d.id}', social.loadPosts)">DEL</button>` : '';
                div.innerHTML += `<div class="card"><div class="post-header"><span onclick="app.openProfile('${p.u}')" style="cursor:pointer; color:var(--main-color);">@${p.u}</span>${del} <span>${p.ts ? new Date(p.ts.toDate()).toLocaleTimeString() : 'NOW'}</span></div><div>${p.txt}</div>${vidHtml}<div class="social-actions"><button class="social-btn ${userLiked}" onclick="social.like('${d.id}', 'post')">LIKE (${likes})</button><button class="social-btn ${userDisliked}" onclick="social.dislike('${d.id}', 'post')">DISLIKE (${dislikes})</button><button class="social-btn" onclick="social.openComments('${d.id}', 'post')">COMMENTS</button></div></div>`; }); },
            createPoll: async () => { const q = document.getElementById('poll-q').value; const o1 = document.getElementById('poll-o1').value; const o2 = document.getElementById('poll-o2').value; if(!q || !o1 || !o2) return; await addDoc(collection(db, "polls"), { u: state.user, q: q, opts: [{t: o1, v:0}, {t: o2, v:0}], voters: [], likes: [], dislikes: [], ts: serverTimestamp() }); document.getElementById('poll-creator').classList.add('hidden'); social.loadPolls(); },
            loadPolls: async () => { const div = document.getElementById('feed-polls'); div.innerHTML = "LOADING POLLS..."; const q = query(collection(db, "polls"), orderBy("ts", "desc"), limit(10)); const snap = await getDocs(q); div.innerHTML = ""; snap.forEach(d => { const p = d.data(); const likes = (p.likes || []).length; const dislikes = (p.dislikes || []).length; const userLiked = (p.likes || []).includes(state.user) ? "active-action" : ""; const userDisliked = (p.dislikes || []).includes(state.user) ? "active-action" : ""; let optsHTML = ""; p.opts.forEach((opt, idx) => { const total = p.opts.reduce((a,b)=>a+b.v,0) || 1; const pct = Math.round((opt.v / total) * 100); optsHTML += `<div style="margin-top:5px; cursor:pointer;" onclick="social.vote('${d.id}', ${idx})"><div style="display:flex; justify-content:space-between;"><span>${opt.t}</span> <span>${opt.v}</span></div><div class="poll-bar"><div class="poll-fill" style="width:${pct}%"></div></div></div>`; }); 
                let del = (p.u === state.user) ? `<button class="del-btn" onclick="app.deleteItem('polls', '${d.id}', social.loadPolls)">DEL</button>` : '';
                div.innerHTML += `<div class="card"><div class="post-header"><span>POLL BY @${p.u}</span>${del}</div><strong>${p.q}</strong>${optsHTML}<div class="social-actions"><button class="social-btn ${userLiked}" onclick="social.like('${d.id}', 'poll')">LIKE (${likes})</button><button class="social-btn ${userDisliked}" onclick="social.dislike('${d.id}', 'poll')">DISLIKE (${dislikes})</button><button class="social-btn" onclick="social.openComments('${d.id}', 'poll')">COMMENTS</button></div></div>`; }); },
            vote: async (id, optIdx) => { const ref = doc(db, "polls", id); const snap = await getDoc(ref); const d = snap.data(); if(d.voters.includes(state.user)) return alert("ALREADY VOTED"); d.opts[optIdx].v++; d.voters.push(state.user); await updateDoc(ref, { opts: d.opts, voters: d.voters }); social.loadPolls(); }
        };

        // --- NEWS MODULE ---
        window.news = {
            init: async () => { news.loadInternal(); },
            post: async () => {
                const h = document.getElementById('news-headline').value;
                const l = document.getElementById('news-link-input').value;
                if(!h) return;
                await addDoc(collection(db, "news"), { title: h, link: l || null, u: state.user, ts: serverTimestamp() });
                document.getElementById('news-headline').value = ""; document.getElementById('news-link-input').value = ""; news.loadInternal();
            },
            loadInternal: async () => {
                const d = document.getElementById('news-feed-internal');
                d.innerHTML = "Scanning local nodes...";
                const q = query(collection(db, "news"), orderBy("ts", "desc"), limit(10));
                const snap = await getDocs(q);
                d.innerHTML = "";
                snap.forEach(doc => {
                    const n = doc.data();
                    let del = (n.u === state.user) ? `<button class="del-btn" onclick="app.deleteItem('news', '${doc.id}', news.loadInternal)">DEL</button>` : '';
                    d.innerHTML += `<div style="border-bottom:1px solid #222; margin-bottom:5px; padding-bottom:5px;"><strong style="color:cyan;">${n.title}</strong>${del}${n.link ? `<br><a href="${n.link}" target="_blank" style="font-size:10px; color:#666;">[SOURCE LINK]</a>` : ''}<br><small style="color:#444;">REPORT: @${n.u}</small></div>`;
                });
            }
        };

        // --- SETTINGS MODULE ---
        window.settings = {
            apply: () => {
                const r = document.documentElement.style;
                const getVal = (id) => document.getElementById(id).value;
                r.setProperty('--bg-color', getVal('col-bg'));
                r.setProperty('--main-color', getVal('col-main'));
            },
            reset: () => {
                document.getElementById('col-bg').value = "#000000";
                document.getElementById('col-main').value = "#00FF00";
                settings.apply();
            }
        };

    </script>
</body>
</html>
