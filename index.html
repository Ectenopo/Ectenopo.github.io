<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAN_NET // SYSTEM_V3.1</title>
    <style>
        /* ============================================================
           THE CONSTRUCT DESIGN SYSTEM
           All color is driven by a single class on <body>.
           currentColor cascades everywhere — borders, glows, text.
           ============================================================ */

        /* --- THEME CLASSES ON BODY --- */
        body.color-green  { color: #00FF00; --dim: #003300; --dim2: rgba(0,255,0,0.12); }
        body.color-red    { color: #FF3333; --dim: #330000; --dim2: rgba(255,51,51,0.12); }
        body.color-blue   { color: #00AAFF; --dim: #00002a; --dim2: rgba(0,170,255,0.12); }
        body.color-white  { color: #EEEEEE; --dim: #333333; --dim2: rgba(238,238,238,0.12); }
        body.color-gold   { color: #FFD700; --dim: #332b00; --dim2: rgba(255,215,0,0.12); }
        body.color-purple { color: #CC44FF; --dim: #1a0033; --dim2: rgba(204,68,255,0.12); }
        body.color-cyan   { color: #00FFFF; --dim: #003333; --dim2: rgba(0,255,255,0.12); }

        /* Semantic colors — stay fixed regardless of theme */
        :root {
            --warn-color:  #FFAA00;
            --err-color:   #FF2222;
            --rep-watch:   #CC44FF;
            --font-main:   'Courier New', Courier, monospace;
        }

        /* --- BASE RESET --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: #000;
            font-family: var(--font-main);
            font-size: 14px;
            overflow-x: hidden;
            padding-top: 34px; /* space for fixed alert banner */
            min-height: 100vh;
        }

        /* Matrix canvas sits behind everything */
        #matrix-canvas {
            position: fixed;
            top: 0; left: 0;
            z-index: 0;
            opacity: 0.35;
            pointer-events: none;
        }

        /* ============================================================
           SCREENS / CARDS
           ============================================================ */
        .hidden { display: none !important; }

        .screen {
            position: relative;
            z-index: 10;
            max-width: 820px;
            margin: 20px auto;
            padding: 18px;
            background: rgba(0, 4, 0, 0.94);
            border: 1px solid currentColor;
            box-shadow: 0 0 28px currentColor;
            border-radius: 2px;
        }

        /* Full-viewport overlays (kali, etc.) keep their own stacking */
        #screen-kali {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 2000;
            background: #101010;
            display: flex; flex-direction: column;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Screen header lines */
        h1, h2, h3 {
            font-family: var(--font-main);
            color: inherit;
            font-weight: bold;
            letter-spacing: 1px;
            border-bottom: 1px solid currentColor;
            padding-bottom: 8px;
            margin-bottom: 14px;
        }
        h1 { font-size: 1.3em; }
        h2 { font-size: 1.1em; }
        h3 { font-size: 1em; }

        /* ============================================================
           FORM CONTROLS — all use currentColor via inheritance
           ============================================================ */
        button, input, select, textarea {
            width: 100%;
            display: block;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid currentColor;
            color: inherit;
            font-family: var(--font-main);
            font-size: 13px;
            padding: 9px 12px;
            margin-bottom: 8px;
            outline: none;
            border-radius: 1px;
            transition: background 0.15s, box-shadow 0.15s;
        }
        button { cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        button:hover:not(:disabled) {
            background: currentColor;
            color: #000;
            box-shadow: 0 0 12px currentColor;
        }
        button:disabled { opacity: 0.35; cursor: not-allowed; }
        input:focus, textarea:focus { box-shadow: 0 0 8px currentColor; }
        select option { background: #000; color: inherit; }

        /* Semantic button variants */
        button.danger {
            border-color: var(--err-color);
            color: var(--err-color);
        }
        button.danger:hover:not(:disabled) {
            background: var(--err-color);
            color: #000;
            box-shadow: 0 0 12px var(--err-color);
        }
        button.warn {
            border-color: var(--warn-color);
            color: var(--warn-color);
        }
        button.warn:hover:not(:disabled) {
            background: var(--warn-color);
            color: #000;
            box-shadow: 0 0 12px var(--warn-color);
        }
        button.admin {
            border-color: #00FFFF;
            color: #00FFFF;
            border-style: double;
        }
        button.admin:hover:not(:disabled) {
            background: #00FFFF;
            color: #000;
            box-shadow: 0 0 12px #00FFFF;
        }

        /* ============================================================
           GRID HELPERS
           ============================================================ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 5px; }

        /* ============================================================
           SHARED COMPONENTS
           ============================================================ */
        .card {
            border: 1px solid var(--dim, #003300);
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
            background: var(--dim2, rgba(0,255,0,0.05));
        }

        .chat-box {
            height: 240px;
            overflow-y: scroll;
            border: 1px solid var(--dim, #003300);
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            scroll-behavior: smooth;
        }
        .chat-box::-webkit-scrollbar { width: 6px; }
        .chat-box::-webkit-scrollbar-track { background: rgba(0,0,0,0.4); }
        .chat-box::-webkit-scrollbar-thumb { background: currentColor; border-radius: 3px; }

        .chat-msg {
            margin-bottom: 7px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 4px;
            font-size: 0.88em;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .chat-img { height: 20px; vertical-align: middle; filter: sepia(1) hue-rotate(50deg) saturate(5); }

        canvas.draw-canvas {
            border: 1px solid currentColor;
            cursor: crosshair;
            background: #050505;
            display: block;
            margin: 0 auto 10px;
            box-shadow: 0 0 15px currentColor;
        }

        /* ============================================================
           POLL BARS
           ============================================================ */
        .poll-bar { height: 8px; background: var(--dim, #003300); margin-top: 3px; }
        .poll-fill { height: 100%; background: currentColor; width: 0%; transition: width 0.5s; }
        .post-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.78em;
            opacity: 0.6;
            border-bottom: 1px solid var(--dim, #003300);
            margin-bottom: 6px;
            padding-bottom: 4px;
        }

        /* ============================================================
           SOCIAL ACTION BAR
           ============================================================ */
        .social-actions { display: flex; gap: 5px; margin-top: 8px; border-top: 1px solid var(--dim, #003300); padding-top: 6px; }
        .social-btn {
            flex: 1;
            font-size: 10px;
            padding: 5px;
            background: transparent;
            border: 1px solid var(--dim, #003300);
            cursor: pointer;
            color: inherit;
            opacity: 0.5;
            font-family: var(--font-main);
            letter-spacing: 0.5px;
            transition: opacity 0.15s;
        }
        .social-btn:hover { opacity: 1; border-color: currentColor; box-shadow: 0 0 6px currentColor; }
        .active-action { opacity: 1 !important; border-color: var(--warn-color) !important; color: var(--warn-color) !important; font-weight: bold; }

        /* Comment item */
        .comment-item { border-bottom: 1px solid var(--dim, #003300); padding: 6px 0; font-size: 0.88em; word-wrap: break-word; line-height: 1.4; }

        /* ============================================================
           VERIFIED BADGE
           ============================================================ */
        .verified-badge { display: inline-block; color: #00FFFF; margin-left: 4px; font-size: 1.1em; text-shadow: 0 0 5px #00FFFF; }

        /* ============================================================
           LOADING OVERLAY
           ============================================================ */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.96);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            color: inherit;
            font-size: 1.4em;
            letter-spacing: 3px;
            border: 2px solid currentColor;
            animation: loadPulse 1s infinite;
        }
        @keyframes loadPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ============================================================
           SYSTEM ALERT BANNER
           ============================================================ */
        #sys-alert-banner {
            position: fixed; top: 0; left: 0; width: 100%;
            height: 34px;
            z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; letter-spacing: 2px; text-transform: uppercase;
            font-size: 12px;
            transition: transform 0.3s;
        }
        .alert-off  { transform: translateY(-100%); }
        .alert-on   { transform: translateY(0); }
        .type-info  { background: #001100; color: #00FF00; border-bottom: 2px solid #00FF00; }
        .type-warn  { background: #332200; color: var(--warn-color); border-bottom: 2px solid var(--warn-color); animation: pulseAnim 1.5s infinite; }
        .type-crit  { background: #330000; color: #fff; border-bottom: 2px solid var(--err-color); animation: shakeAnim 0.4s infinite; }

        /* ============================================================
           CLAN RED ALERT OVERLAY
           ============================================================ */
        #clan-alert-overlay {
            position: fixed; top:0; left:0; width:100vw; height:100vh;
            z-index: 20000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            animation: alertBg 0.5s infinite;
        }
        @keyframes alertBg { 0% { background: #3a0000; } 50% { background: #cc0000; } 100% { background: #3a0000; } }
        #clan-alert-box {
            background: #000;
            border: 4px double #fff;
            padding: 40px;
            text-align: center;
            max-width: 80%;
            box-shadow: 0 0 60px red;
        }
        #clan-alert-msg { color: #fff; font-size: 1.8em; font-weight: bold; margin-bottom: 20px; display: block; line-height: 1.3; }

        /* ============================================================
           VOICE CHAT
           ============================================================ */
        .voice-bar-container { display: flex; align-items: flex-end; justify-content: center; height: 28px; gap: 2px; margin-top: 6px; }
        .voice-bar { width: 4px; background: var(--dim, #003300); height: 5px; transition: height 0.08s; }

        .voice-users-list { max-height: 90px; overflow-y: auto; border: 1px solid var(--dim, #003300); padding: 4px; margin: 5px 0; background: rgba(0,0,0,0.6); }
        .voice-user-item { display: flex; align-items: center; gap: 6px; padding: 3px; border-bottom: 1px solid var(--dim, #003300); font-size: 10px; }
        .voice-user-indicator { width: 7px; height: 7px; border-radius: 50%; background: currentColor; box-shadow: 0 0 5px currentColor; animation: pulseAnim 2s infinite; }
        @keyframes pulseAnim { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shakeAnim { 0% { transform: translateX(0); } 25% { transform: translateX(3px); } 75% { transform: translateX(-3px); } 100% { transform: translateX(0); } }

        /* ============================================================
           COCKPIT / CYBERDECK
           ============================================================ */
        .switch-container {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.5); padding: 5px 8px;
            border: 1px solid var(--dim, #003300); margin-bottom: 5px;
        }
        .switch-label { font-size: 0.75em; opacity: 0.7; }
        .toggle-switch { position: relative; width: 38px; height: 18px; background: #111; cursor: pointer; border: 1px solid var(--dim, #003300); }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: #333; transition: 0.2s; }
        .toggle-active { border-color: currentColor !important; }
        .toggle-active::after { left: 22px; background: currentColor; box-shadow: 0 0 5px currentColor; }
        .dial-container { text-align: center; background: rgba(0,0,0,0.4); padding: 5px; border: 1px solid var(--dim, #003300); }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: var(--dim, #003300); outline: none; margin: 10px 0; border: none; padding: 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: currentColor; cursor: pointer; border-radius: 0; box-shadow: 0 0 5px currentColor; }

        .action-btn {
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--dim, #003300);
            color: inherit;
            font-size: 10px; padding: 12px 4px;
            text-align: center; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
            font-family: var(--font-main); letter-spacing: 0.5px;
            transition: all 0.1s;
        }
        .action-btn:hover { background: currentColor; color: #000; box-shadow: 0 0 10px currentColor; border-color: currentColor; }
        .action-btn:active { transform: scale(0.95); }
        .led { width: 7px; height: 7px; background: #222; border-radius: 50%; border: 1px solid #444; }
        .led.on  { background: currentColor; box-shadow: 0 0 5px currentColor; border-color: #fff; }
        .led.busy { background: var(--warn-color); box-shadow: 0 0 5px var(--warn-color); animation: blinkAnim 0.3s infinite; }
        @keyframes blinkAnim { 0%,100% { opacity: 1; } 50% { opacity: 0.2; } }

        #network-scan-panel {
            background: #000; border: 1px solid var(--warn-color);
            height: 220px; overflow-y: scroll;
            font-size: 10px; color: var(--warn-color); padding: 10px; margin: 10px 0;
        }
        .device-card { border: 1px solid #333; padding: 7px; margin-bottom: 5px; background: rgba(255,170,0,0.04); cursor: pointer; }
        .device-card:hover { background: rgba(255,170,0,0.1); }
        .device-info { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 9px; }
        #scan-progress { width: 100%; height: 4px; background: #222; margin: 5px 0; }
        #scan-progress-fill { height: 100%; background: var(--warn-color); width: 0%; transition: width 0.1s; }
        .real-tools-panel { background: #111; border: 1px solid #00FFFF; padding: 10px; margin-top: 10px; font-size: 10px; }
        .real-tools-panel a { color: #00FFFF; text-decoration: none; }
        .real-tools-panel a:hover { text-decoration: underline; }

        /* ============================================================
           KALI EMU
           ============================================================ */
        #kali-bar { height: 38px; background: #1e1e1e; border-bottom: 1px solid #444; display: flex; align-items: center; padding: 0 10px; color: #ddd; justify-content: space-between; }
        .kali-btn { background: transparent; border: none; color: #ddd; width: auto; padding: 5px 14px; cursor: pointer; font-size: 13px; }
        .kali-btn:hover { background: #444; }
        #kali-desktop { flex: 1; position: relative; background: #0a0a0a; }
        .window { position: absolute; width: 580px; height: 380px; background: #1a1a1a; border: 1px solid #444; display: flex; flex-direction: column; top: 50px; left: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .win-header { height: 28px; background: #2a2a2a; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; cursor: move; color: #ccc; font-size: 12px; }
        .win-body { flex: 1; background: #000; padding: 5px; color: #00ff00; font-family: var(--font-main); overflow: hidden; display: flex; flex-direction: column; }
        #py-console { flex: 1; overflow-y: auto; padding: 5px; white-space: pre-wrap; font-size: 12px; }
        #py-input-line { display: flex; margin-top: 4px; border-top: 1px solid #222; padding-top: 4px; }
        #py-input { background: transparent; border: none; color: #0f0; flex: 1; font-family: var(--font-main); outline: none; font-size: 12px; width: auto; margin: 0; padding: 2px; }
        .term-line { font-size: 12px; margin: 2px 0; }
        .term-info { color: cyan; }

        /* ============================================================
           NEWS LINKS
           ============================================================ */
        .news-link {
            display: block; padding: 9px 12px; border: 1px solid var(--dim, #003300);
            margin-bottom: 5px; color: inherit; text-decoration: none;
            opacity: 0.6; transition: all 0.2s;
            font-size: 12px;
        }
        .news-link:hover { opacity: 1; border-color: currentColor; box-shadow: 0 0 8px currentColor; padding-left: 18px; }

        /* ============================================================
           RADIO / FREQ VIZ
           ============================================================ */
        .freq-bar { width: 5px; background: var(--dim, #003300); margin: 1px; display: inline-block; vertical-align: bottom; transition: height 0.1s; }

        /* ============================================================
           VIDEO EMBED
           ============================================================ */
        .vid-embed { width: 100%; height: 190px; border: none; margin-top: 8px; background: #000; display: block; }

        /* ============================================================
           REMOTE ACCESS OVERLAY
           ============================================================ */
        #remote-access-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.96); z-index: 4000;
            display: flex; justify-content: center; align-items: center;
        }

        /* ============================================================
           COMMENT OVERLAY
           ============================================================ */
        #comment-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.97); z-index: 9000;
            display: flex; justify-content: center; align-items: center;
        }

        /* ============================================================
           SETTINGS — THEME PRESET BUTTONS
           ============================================================ */
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 12px 0; }
        .theme-btn {
            border: 2px solid;
            background: rgba(0,0,0,0.8);
            padding: 14px 6px;
            cursor: pointer;
            font-family: var(--font-main);
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.15s;
            font-weight: bold;
        }
        .theme-btn:hover { filter: brightness(1.4); box-shadow: 0 0 14px; }
        .theme-btn.active { outline: 2px solid #fff; outline-offset: 2px; }
        .theme-btn-green  { color: #00FF00; border-color: #00FF00; }
        .theme-btn-red    { color: #FF3333; border-color: #FF3333; }
        .theme-btn-blue   { color: #00AAFF; border-color: #00AAFF; }
        .theme-btn-white  { color: #EEEEEE; border-color: #EEEEEE; }
        .theme-btn-gold   { color: #FFD700; border-color: #FFD700; }
        .theme-btn-purple { color: #CC44FF; border-color: #CC44FF; }
        .theme-btn-cyan   { color: #00FFFF; border-color: #00FFFF; }

        /* ============================================================
           COCKPIT CANVAS
           ============================================================ */
        #cockpit-canvas { border: none !important; background: transparent !important; }
    </style>
</head>

<!-- Body gets a theme class (color-green default) -->
<body class="color-green">

<!-- ================================================================
     MATRIX RAIN CANVAS — sits behind everything
     ================================================================ -->
<canvas id="matrix-canvas"></canvas>

<!-- ================================================================
     SYSTEM ALERT BANNER
     ================================================================ -->
<div id="sys-alert-banner" class="alert-off">
    <span id="sys-alert-msg">SYSTEM NORMAL</span>
    <button onclick="sysAlerts.hide()" style="background:transparent;border:none;color:inherit;font-size:15px;margin-left:20px;cursor:pointer;width:auto;margin-bottom:0;">[X]</button>
</div>

<!-- CLAN RED ALERT OVERLAY -->
<div id="clan-alert-overlay" class="hidden">
    <div id="clan-alert-box">
        <h1 style="color:yellow;font-size:2.5em;margin-bottom:16px;border:none;padding:0;">⚠ ALERT ⚠</h1>
        <span id="clan-alert-msg">CLAN UNDER ATTACK</span>
        <br><br>
        <button onclick="app.ackAlert()" style="font-size:1.3em;background:white;color:black;border:2px solid black;width:auto;padding:10px 30px;cursor:pointer;">ACKNOWLEDGE</button>
    </div>
</div>

<div id="loading-overlay" class="hidden">>> INITIALIZING NEURAL LINK...</div>

<!-- ================================================================
     AUTH SCREEN
     ================================================================ -->
<div id="screen-auth" class="screen">
    <h1>// CLAN_NET :: ACCESS_TERMINAL</h1>
    <input type="text"     id="auth-user" placeholder="USERNAME">
    <input type="password" id="auth-pass" placeholder="PASSWORD">
    <button onclick="app.login()">AUTHENTICATE</button>
    <button onclick="app.register()" style="border-style:dashed;opacity:0.65;">REGISTER IDENTITY</button>
</div>

<!-- ================================================================
     HUB SCREEN
     ================================================================ -->
<div id="screen-hub" class="screen hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid currentColor;padding-bottom:10px;margin-bottom:12px;">
        <div onclick="app.openProfile(state.user)" style="cursor:pointer;font-weight:bold;letter-spacing:1px;">
            USER: <span id="hub-user"></span>
        </div>
        <div style="display:flex;gap:6px;">
            <button onclick="app.openProfile(state.user)" style="width:auto;padding:5px 12px;font-size:10px;margin:0;">PROFILE</button>
            <button onclick="nav.to('settings')"          style="width:auto;padding:5px 12px;font-size:10px;margin:0;">CONFIG</button>
        </div>
    </div>

    <div style="margin-bottom:10px;font-size:11px;opacity:0.7;">
        <span id="hub-rep">REP: 0</span> &nbsp;|&nbsp;
        <span id="device-info">DEVICE: DETECTING...</span>
    </div>

    <div style="display:flex;gap:6px;margin-bottom:12px;">
        <input type="text" id="search-user-input" placeholder="SEARCH EXACT USERNAME..." style="margin:0;">
        <button onclick="app.searchUser()" style="width:80px;margin:0;">FIND</button>
    </div>

    <div class="grid-2" style="margin-bottom:10px;">
        <button onclick="nav.tab('clans')">CLANS</button>
        <button onclick="nav.to('social')">NET_SOCIAL</button>
        <button onclick="nav.to('jobs')">JOBS / GIGS</button>
        <button onclick="nav.to('events')">EVENTS</button>
        <button onclick="nav.tab('global')">GLOBAL COMMS</button>
        <button onclick="nav.to('news')"  style="color:#00FFFF;border-color:#00FFFF;">[ WORLD_WIRE ]</button>
        <button onclick="nav.to('radio')" style="color:var(--warn-color);border-color:var(--warn-color);">[ SIGNAL_INTERCEPT ]</button>
        <button onclick="nav.to('verified')" id="btn-verified" class="hidden" style="color:#FFD700;border-color:#FFD700;">[ ELITE_UPLINK ]</button>
        <button onclick="nav.to('ectotape')" style="color:var(--rep-watch);border-color:var(--rep-watch);">[ ECTOTAPE ]</button>
        <button onclick="nav.to('soc')"  id="btn-soc"     class="hidden admin"  style="grid-column:span 2;">[ SECURITY OPS CENTER ]</button>
        <button onclick="nav.to('cockpit')" id="btn-payload" class="hidden warn" style="grid-column:span 2;border-style:dashed;">[ CYBER_DECK COMMAND ]</button>
    </div>

    <!-- CLAN TAB -->
    <div id="tab-clans">
        <div id="panel-no-clan">
            <button onclick="nav.to('create')">INITIALIZE NEW CLAN</button>
            <div class="card" style="margin-top:10px;">
                <p style="font-size:11px;opacity:0.7;margin-bottom:8px;">SEARCH NETWORK:</p>
                <input type="text"     id="join-name" placeholder="EXACT CLAN NAME">
                <input type="password" id="join-pass" placeholder="ACCESS KEY">
                <button onclick="app.joinClan()">CONNECT</button>
            </div>
        </div>

        <div id="panel-in-clan" class="hidden">
            <h2 id="clan-header">CLAN_NAME</h2>

            <!-- VOICE COMMS -->
            <div class="card" style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <small style="opacity:0.7;letter-spacing:1px;">VOICE COMMS</small>
                    <div id="voice-status" style="width:9px;height:9px;border-radius:50%;background:#330000;border:1px solid currentColor;"></div>
                </div>
                <div id="voice-users-container" class="hidden">
                    <div style="font-size:9px;opacity:0.5;margin-bottom:3px;">CONNECTED USERS:</div>
                    <div id="voice-users-list" class="voice-users-list"></div>
                </div>
                <div class="voice-bar-container" id="voice-viz"></div>
                <div class="grid-2" style="margin-top:6px;">
                    <button onclick="app.toggleVoice()" id="btn-voice-conn" style="font-size:10px;margin:0;">CONNECT MIC</button>
                    <button onclick="app.muteVoice()"   id="btn-voice-mute" style="font-size:10px;margin:0;" disabled>MUTE</button>
                </div>
                <small style="font-size:8px;opacity:0.4;display:block;margin-top:4px;">⚠ WebRTC P2P detection only. Full voice needs external server.</small>
            </div>

            <div class="chat-box" id="clan-chat"></div>
            <div style="display:flex;gap:5px;">
                <button onclick="app.toggleEnc()"  id="btn-enc"  style="width:50px;font-size:10px;opacity:0.5;margin:0;">ENC</button>
                <button onclick="app.toggleDict()" id="btn-dict" style="width:50px;font-size:10px;opacity:0.5;margin:0;">DICT</button>
                <input type="text" id="clan-input" placeholder="Secure Message..." style="margin:0;">
                <button onclick="app.sendClanMsg()" style="width:60px;margin:0;">SEND</button>
            </div>

            <!-- LEADER COMMANDS -->
            <div id="clan-leader-cmds" class="hidden" style="margin-top:10px;">
                <small style="opacity:0.6;font-size:10px;display:block;margin-bottom:5px;">COMMAND UPLINK:</small>
                <div class="grid-3">
                    <button onclick="app.sendClanAlert('ANNOUNCE')" style="color:#00FF00;border-color:#00FF00;font-size:10px;">ANNOUNCE</button>
                    <button onclick="app.sendClanAlert('WARN')"     style="color:var(--warn-color);border-color:var(--warn-color);font-size:10px;">WARNING</button>
                    <button onclick="app.sendClanAlert('ALERT')"    style="background:#500;color:#fff;border-color:red;font-size:10px;">RED ALERT</button>
                </div>
            </div>

            <div class="grid-2" style="margin-top:10px;">
                <button onclick="nav.to('dict')">DICTIONARY</button>
                <button onclick="app.loadRoster()">ROSTER / RANKS</button>
                <button onclick="app.startSymbolEdit()">EDIT SYMBOLS</button>
                <button onclick="app.leaveClan()" class="danger">LEAVE</button>
                <button onclick="app.deleteClan()" id="btn-delete-clan" class="danger hidden" style="grid-column:span 2;border-style:double;">// DELETE CLAN //</button>
            </div>
        </div>
    </div>

    <!-- GLOBAL TAB -->
    <div id="tab-global" class="hidden">
        <p style="font-size:11px;opacity:0.6;margin-bottom:8px;">// PUBLIC FREQUENCY</p>
        <div class="chat-box" id="global-chat"></div>
        <input type="text" id="global-input" placeholder="Public Comment...">
        <button onclick="app.sendGlobalMsg()">POST COMMENT</button>
    </div>

    <button onclick="location.reload()" style="margin-top:20px;border:none;opacity:0.35;font-size:11px;">LOGOUT</button>
</div>

<!-- ================================================================
     VERIFIED ELITE SCREEN
     ================================================================ -->
<div id="screen-verified" class="screen hidden" style="border-color:#FFD700;box-shadow:0 0 28px #FFD700;color:#FFD700;">
    <h2>// ELITE_UPLINK_ESTABLISHED</h2>
    <p style="font-size:10px;opacity:0.6;margin-bottom:10px;">SECURE GROUPCHAT FOR VERIFIED IDENTITIES ONLY.</p>
    <div class="card" style="border-color:#FFD700;margin-bottom:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:9px;height:9px;background:#FFD700;border-radius:50%;box-shadow:0 0 8px #FFD700;animation:pulseAnim 2s infinite;"></div>
            <span style="font-size:10px;opacity:0.8;">ENCRYPTED VOICE TUNNEL: ACTIVE</span>
        </div>
    </div>
    <div class="chat-box" id="verified-chat" style="border-color:#FFD700;"></div>
    <input  type="text" id="verified-input" placeholder="Elite Message..." style="border-color:#FFD700;color:#FFD700;">
    <button onclick="app.sendVerifiedMsg()" style="border-color:#FFD700;color:#FFD700;">TRANSMIT</button>
    <button onclick="nav.to('hub')">BACK</button>
</div>

<!-- ================================================================
     DICTIONARY SCREEN
     ================================================================ -->
<div id="screen-dict" class="screen hidden">
    <h2>// DICTIONARY_EDIT</h2>
    <div class="grid-2">
        <input type="text" id="dict-orig" placeholder="ENGLISH">
        <input type="text" id="dict-new"  placeholder="CLAN WORD">
    </div>
    <button onclick="app.addWord()">ADD / UPDATE WORD</button>
    <div id="dict-list" style="height:250px;overflow-y:scroll;border:1px solid var(--dim);padding:5px;margin-bottom:10px;"></div>
    <button onclick="nav.to('hub')">BACK</button>
</div>

<!-- ================================================================
     SOCIAL SCREEN
     ================================================================ -->
<div id="screen-social" class="screen hidden">
    <h2>// NET_SOCIAL</h2>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
        <button onclick="social.tab('posts')" style="flex:1;">POSTS</button>
        <button onclick="social.tab('polls')" style="flex:1;">POLLS</button>
    </div>

    <div id="soc-tab-posts">
        <div style="border-bottom:1px solid var(--dim);padding-bottom:12px;margin-bottom:12px;">
            <textarea id="post-content" placeholder="What's happening?" style="height:60px;resize:none;"></textarea>
            <input type="text" id="post-video" placeholder="YouTube URL (Optional)">
            <button onclick="social.createPost()">PUBLISH POST</button>
        </div>
        <div id="feed-posts" style="height:400px;overflow-y:scroll;"></div>
    </div>

    <div id="soc-tab-polls" class="hidden">
        <button onclick="document.getElementById('poll-creator').classList.remove('hidden')">CREATE NEW POLL</button>
        <div id="poll-creator" class="hidden card" style="margin-top:10px;">
            <input type="text" id="poll-q"     placeholder="Question">
            <input type="text" id="poll-o1"    placeholder="Option 1">
            <input type="text" id="poll-o2"    placeholder="Option 2">
            <input type="text" id="poll-video" placeholder="YouTube URL (Optional)">
            <button onclick="social.createPoll()">LAUNCH POLL</button>
        </div>
        <div id="feed-polls" style="height:400px;overflow-y:scroll;margin-top:10px;"></div>
    </div>
    <button onclick="nav.to('hub')" style="margin-top:10px;">BACK</button>
</div>

<!-- ================================================================
     RADIO SCREEN
     ================================================================ -->
<div id="screen-radio" class="screen hidden" style="border-color:var(--warn-color);box-shadow:0 0 28px var(--warn-color);color:var(--warn-color);">
    <h2>// SIGNAL_INTERCEPT (RADIO)</h2>
    <div class="card" style="border-color:var(--warn-color);text-align:center;">
        <div id="freq-viz" style="height:50px;display:flex;align-items:flex-end;justify-content:center;overflow:hidden;margin-bottom:10px;"></div>
        <div style="font-size:22px;font-family:var(--font-main);margin-bottom:10px;">FREQ: <span id="radio-freq">462.5625</span> MHz</div>
        <div class="grid-2">
            <button onclick="radio.toggleNoise()" id="btn-noise" style="color:var(--warn-color);border-color:var(--warn-color);">TOGGLE STATIC</button>
            <button onclick="radio.scan()"        style="color:var(--warn-color);border-color:var(--warn-color);">SCAN NEXT</button>
        </div>
    </div>
    <h3 style="margin-top:14px;border-color:var(--warn-color);">// LIVE UPLINKS (EXTERNAL)</h3>
    <div class="grid-2" style="margin-top:8px;">
        <a href="https://www.broadcastify.com/listen/" target="_blank" class="news-link" style="color:var(--warn-color);border-color:var(--warn-color);">BROADCASTIFY (POLICE/FIRE)</a>
        <a href="https://tunein.com/radio/Police-Scanners-c100000/" target="_blank" class="news-link" style="color:var(--warn-color);border-color:var(--warn-color);">TUNEIN POLICE RADIO</a>
    </div>
    <button onclick="nav.to('hub')" style="margin-top:10px;">BACK</button>
</div>

<!-- ================================================================
     NEWS SCREEN
     ================================================================ -->
<div id="screen-news" class="screen hidden" style="border-color:#00FFFF;box-shadow:0 0 28px #00FFFF;color:#00FFFF;">
    <h2>// WORLD_WIRE (NEWS)</h2>
    <h3>UNDERGROUND UPDATES</h3>
    <div class="card" style="border-color:#00FFFF;">
        <input type="text" id="news-headline"   placeholder="Headline...">
        <input type="text" id="news-link-input" placeholder="Source URL (Optional)...">
        <button onclick="news.post()" class="admin">BROADCAST UPDATE</button>
    </div>
    <div id="news-feed-internal" style="height:140px;overflow-y:scroll;border:1px solid var(--dim);margin-bottom:18px;padding:8px;"></div>
    <h3>GLOBAL INTERCEPTS</h3>
    <a href="https://www.foxnews.com"  target="_blank" class="news-link">>> FOX_NEWS_NETWORK</a>
    <a href="https://www.cbc.ca/news"  target="_blank" class="news-link">>> CBC_NEWS_FEED</a>
    <a href="https://www.cnn.com"      target="_blank" class="news-link">>> CNN_GLOBAL</a>
    <a href="https://www.bbc.com/news" target="_blank" class="news-link">>> BBC_WORLD_SERVICE</a>
    <a href="https://news.google.com"  target="_blank" class="news-link">>> GOOGLE_AGGREGATE</a>
    <button onclick="nav.to('hub')" style="margin-top:10px;">BACK</button>
</div>

<!-- ================================================================
     COMMENT OVERLAY
     ================================================================ -->
<div id="comment-overlay" class="hidden">
    <div class="screen" style="width:90%;height:82%;display:flex;flex-direction:column;margin:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid currentColor;padding-bottom:10px;margin-bottom:10px;">
            <h3 style="margin:0;border:none;padding:0;">// COMMENTS_THREAD</h3>
            <button onclick="social.closeComments()" class="warn" style="width:auto;padding:4px 12px;margin:0;">CLOSE [X]</button>
        </div>
        <div id="active-comment-list" style="flex:1;overflow-y:scroll;padding:10px;margin-bottom:10px;border:1px solid var(--dim);"></div>
        <input type="text" id="new-comment-input" placeholder="Add comment..." style="flex-shrink:0;">
        <button onclick="social.submitComment()" style="flex-shrink:0;">POST COMMENT</button>
    </div>
</div>

<!-- ================================================================
     PROFILE SCREEN
     ================================================================ -->
<div id="screen-profile" class="screen hidden">
    <h2>// USER_PROFILE</h2>
    <div class="card">
        <div style="display:flex;gap:12px;align-items:center;">
            <div id="prof-pfp-display" style="width:52px;height:52px;background:#111;border:1px solid currentColor;background-size:cover;background-position:center;flex-shrink:0;"></div>
            <div>
                <h3 id="prof-displayname" style="border:none;padding:0;margin:0;font-size:1.1em;"></h3>
                <small id="prof-username" style="opacity:0.5;"></small>
            </div>
        </div>
        <div id="prof-verified" class="hidden" style="color:#00FFFF;margin-top:8px;font-size:11px;">⚠ VERIFIED IDENTITY ⚠</div>
    </div>
    <p>CLAN: <span id="prof-clan" style="font-weight:bold;">LOADING...</span></p>
    <p>STATUS: <span id="prof-rep" style="font-weight:bold;">LOADING...</span></p>
    <div id="prof-edit-panel" class="hidden" style="border-top:1px solid var(--dim);padding-top:12px;margin-top:12px;">
        <input type="text" id="edit-disp" placeholder="New Display Name">
        <input type="text" id="edit-pfp"  placeholder="PFP Image URL">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
            <input type="checkbox" id="edit-private" style="width:auto;margin:0;"> <label style="font-size:12px;opacity:0.7;">HIDE CLAN FROM PUBLIC</label>
        </div>
        <button onclick="app.saveProfile()">SAVE CHANGES</button>
    </div>
    <div id="prof-admin-panel" class="hidden" style="border:1px solid #00FFFF;padding:10px;margin-top:10px;">
        <strong style="color:#00FFFF;font-size:11px;">SUPERUSER CONTROLS</strong>
        <button onclick="app.verifyUser()" class="admin">GRANT VERIFICATION BADGE</button>
    </div>
    <button onclick="nav.to('hub')" style="margin-top:10px;">BACK</button>
</div>

<!-- ================================================================
     RANKS SCREEN
     ================================================================ -->
<div id="screen-ranks" class="screen hidden">
    <h2>// ROSTER_CONTROL</h2>
    <div id="roster-list" style="height:300px;overflow-y:scroll;"></div>
    <button onclick="nav.to('hub')">BACK</button>
</div>

<!-- ================================================================
     SETTINGS SCREEN — theme preset buttons (The Construct style)
     ================================================================ -->
<div id="screen-settings" class="screen hidden">
    <h2>// SYSTEM_CONFIG — VISUAL THEME</h2>
    <p style="font-size:11px;opacity:0.6;margin-bottom:14px;">Select a color theme. The entire interface adapts to match.</p>

    <div class="theme-grid">
        <button class="theme-btn theme-btn-green"  onclick="settings.apply('green')" >GREEN</button>
        <button class="theme-btn theme-btn-red"    onclick="settings.apply('red')"   >RED</button>
        <button class="theme-btn theme-btn-blue"   onclick="settings.apply('blue')"  >BLUE</button>
        <button class="theme-btn theme-btn-white"  onclick="settings.apply('white')" >WHITE</button>
        <button class="theme-btn theme-btn-gold"   onclick="settings.apply('gold')"  >GOLD</button>
        <button class="theme-btn theme-btn-purple" onclick="settings.apply('purple')">PURPLE</button>
        <button class="theme-btn theme-btn-cyan"   onclick="settings.apply('cyan')"  >CYAN</button>
    </div>

    <div id="settings-active-label" style="font-size:11px;opacity:0.6;margin:10px 0 20px;">
        ACTIVE THEME: <span id="active-theme-name" style="font-weight:bold;text-transform:uppercase;">GREEN</span>
    </div>

    <button onclick="settings.reset()" class="danger">RESET TO DEFAULT (GREEN)</button>
    <button onclick="nav.to('hub')" style="margin-top:6px;">BACK</button>
</div>

<!-- ================================================================
     EVENTS SCREEN
     ================================================================ -->
<div id="screen-events" class="screen hidden">
    <h2>// EVENT_LOG</h2>
    <div class="card">
        <input type="text" id="evt-name" placeholder="EVENT NAME">
        <input type="text" id="evt-desc" placeholder="DESCRIPTION">
        <div class="grid-2">
            <input type="date" id="evt-start">
            <input type="date" id="evt-end">
        </div>
        <button onclick="app.createEvent()">PUBLISH</button>
    </div>
    <div id="event-list" style="height:200px;overflow-y:scroll;"></div>
    <button onclick="nav.to('hub')">BACK</button>
</div>

<!-- ================================================================
     JOBS SCREEN
     ================================================================ -->
<div id="screen-jobs" class="screen hidden">
    <h2>// GIG_NETWORK</h2>
    <div class="grid-2">
        <button onclick="document.getElementById('job-create-panel').classList.remove('hidden');">POST JOB</button>
        <button onclick="app.loadJobs()">BROWSE</button>
    </div>
    <div id="job-create-panel" class="hidden card" style="margin-top:10px;">
        <input type="text" id="job-title" placeholder="TITLE">
        <textarea id="job-desc" placeholder="DESC" style="height:50px;resize:none;"></textarea>
        <button onclick="app.createJob()">UPLOAD</button>
    </div>
    <div id="job-list" style="height:300px;overflow-y:scroll;margin-top:10px;"></div>
    <div id="job-chat-panel" class="hidden" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,4,0,0.98);z-index:10;padding:15px;border:1px solid currentColor;">
        <div id="job-chat-box" class="chat-box" style="height:280px;"></div>
        <input type="text" id="job-msg-input">
        <button onclick="app.sendJobMsg()">SEND</button>
        <button onclick="app.closeJobChat()" class="warn">CLOSE</button>
    </div>
    <button onclick="nav.to('hub')" style="margin-top:10px;">BACK</button>
</div>

<!-- ================================================================
     ECTOTAPE SCREEN
     ================================================================ -->
<div id="screen-ectotape" class="screen hidden" style="border-color:var(--rep-watch);box-shadow:0 0 28px var(--rep-watch);">
    <h2 style="color:var(--rep-watch);border-color:var(--rep-watch);">// ECTOTAPE_STREAM</h2>
    <div id="upload-zone" class="hidden card" style="border-color:var(--rep-watch);">
        <input type="text" id="vid-title" placeholder="TITLE">
        <input type="text" id="vid-url"   placeholder="YouTube URL">
        <button onclick="app.uploadVideo()" style="color:var(--rep-watch);border-color:var(--rep-watch);">BROADCAST</button>
    </div>
    <div id="video-feed" style="height:420px;overflow-y:scroll;"></div>
    <button onclick="nav.to('hub')" style="margin-top:10px;">EXIT</button>
</div>

<!-- ================================================================
     DRAW SCREEN
     ================================================================ -->
<div id="screen-draw" class="screen hidden">
    <h3 id="draw-title">DRAW: A</h3>
    <canvas id="draw-canvas" class="draw-canvas" width="280" height="280"></canvas>
    <div class="grid-2">
        <button onclick="drawing.clear()">CLEAR</button>
        <button onclick="drawing.save()">NEXT →</button>
    </div>
    <button onclick="drawing.cancel()" class="danger" style="margin-top:6px;">CANCEL</button>
</div>

<!-- ================================================================
     CREATE CLAN SCREEN
     ================================================================ -->
<div id="screen-create" class="screen hidden">
    <h2>// NEW_CLAN :: INITIALIZE</h2>
    <input type="text"     id="create-name" placeholder="CLAN NAME">
    <input type="password" id="create-pass" placeholder="ACCESS PASSPHRASE">
    <button onclick="app.createClanStart()">START DRAWING SYMBOLS</button>
    <button onclick="nav.to('hub')" class="danger" style="margin-top:4px;">CANCEL</button>
</div>

<!-- ================================================================
     SOC SCREEN
     ================================================================ -->
<div id="screen-soc" class="screen hidden" style="border-color:#00FFFF;box-shadow:0 0 28px #00FFFF;color:#00FFFF;">
    <h2>// SECURITY_OPS_CENTER</h2>
    <div class="card" style="border-color:#00FFFF;margin-bottom:10px;">
        <small style="opacity:0.6;font-size:10px;display:block;margin-bottom:6px;">GLOBAL ALERT SYSTEM CONTROLS</small>
        <div class="grid-3">
            <button onclick="sysAlerts.trigger('INFO')" style="color:#00FF00;border-color:#00FF00;">ANNOUNCE</button>
            <button onclick="sysAlerts.trigger('WARN')" style="color:var(--warn-color);border-color:var(--warn-color);">WARNING</button>
            <button onclick="sysAlerts.trigger('CRIT')" class="danger">RED ALERT</button>
        </div>
    </div>
    <div class="grid-2">
        <button class="admin" onclick="app.runSecurityScan('TRAFFIC')">ANALYZE TRAFFIC</button>
        <button class="admin" onclick="app.runSecurityScan('VULN')">VULNERABILITY SCAN</button>
    </div>
    <button onclick="nav.to('kali')" style="background:#0a0a0a;color:#3377ff;border:1px solid #3377ff;margin-top:4px;">[ BOOT KALI_LINUX_EMU ]</button>
    <div id="soc-console" style="background:#000;border:1px solid #00FFFF;height:150px;padding:10px;overflow-y:scroll;font-size:11px;margin-top:10px;color:#00FFFF;">
        <span class="term-line">> SOC_INIT... READY.</span>
    </div>
    <button onclick="nav.to('hub')" style="margin-top:10px;border-color:#00FFFF;color:#00FFFF;">DISCONNECT</button>
</div>

<!-- ================================================================
     CYBERDECK COCKPIT
     ================================================================ -->
<div id="screen-cockpit" class="screen hidden" style="border-color:var(--warn-color);box-shadow:0 0 28px var(--warn-color);max-width:920px;">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--warn-color);margin-bottom:12px;padding-bottom:6px;">
        <h2 style="color:var(--warn-color);border:none;padding:0;margin:0;">// CYBER_DECK_V2.0 — EDU SIM</h2>
        <div style="font-size:9px;color:var(--warn-color);animation:blinkAnim 2s infinite;">[ BROWSER SECURITY LIMITS APPLY ]</div>
    </div>
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;">
        <div>
            <div class="grid-3">
                <div class="switch-container"><span class="switch-label">PROXY CHAIN</span><div class="toggle-switch" onclick="cockpit.toggle(this)"></div></div>
                <div class="switch-container"><span class="switch-label">FIREWALL BYPASS</span><div class="toggle-switch" onclick="cockpit.toggle(this)"></div></div>
                <div class="switch-container"><span class="switch-label">ROOT MASK</span><div class="toggle-switch" onclick="cockpit.toggle(this)"></div></div>
            </div>
            <div class="grid-2" style="margin-bottom:10px;">
                <div class="dial-container"><span class="switch-label">SIGNAL GAIN</span><input type="range" min="0" max="100" value="50" oninput="cockpit.updateGain(this.value)"></div>
                <div class="dial-container"><span class="switch-label">DECRYPTION RATE</span><input type="range" min="0" max="100" value="30" oninput="cockpit.updateRate(this.value)"></div>
            </div>
            <div style="background:#000;border:1px solid var(--warn-color);height:120px;position:relative;overflow:hidden;margin-bottom:10px;">
                <canvas id="cockpit-canvas" width="450" height="120" style="border:none;background:transparent;box-shadow:none;"></canvas>
                <div id="visual-text" style="position:absolute;top:5px;left:5px;font-size:9px;color:rgba(255,170,0,0.6);"></div>
            </div>
            <div class="grid-4">
                <div class="action-btn" onclick="cockpit.runAction('PING_SWEEP')"><div class="led"></div>PING</div>
                <div class="action-btn" onclick="cockpit.runAction('PORT_SCAN')"><div class="led"></div>SCAN</div>
                <div class="action-btn" onclick="cockpit.runAction('PACKET_SNIFF')"><div class="led"></div>SNIFF</div>
                <div class="action-btn" onclick="cockpit.runAction('TRACE_ROUTE')"><div class="led"></div>TRACE</div>
                <div class="action-btn" onclick="cockpit.runAction('BRUTE_FORCE')"><div class="led"></div>BRUTE</div>
                <div class="action-btn" onclick="cockpit.runAction('INJECT_SQL')"><div class="led"></div>INJECT</div>
                <div class="action-btn" onclick="cockpit.runAction('OVERFLOW')"><div class="led"></div>OVRFLW</div>
                <div class="action-btn" onclick="cockpit.runAction('EXECUTE_PAYLOAD')" style="border-style:dashed;"><div class="led busy"></div>EXECUTE</div>
            </div>
            <div style="margin-top:10px;">
                <button onclick="cockpit.scanNetwork()" class="warn" style="width:100%;padding:10px;">LAN DISCOVERY (SIM + WEBRTC)</button>
                <div id="scan-progress"><div id="scan-progress-fill"></div></div>
            </div>
            <div class="real-tools-panel hidden" id="real-tools-panel">
                <h4 style="color:#00FFFF;margin:0 0 5px;">>> REAL TOOLS (EDU) <<</h4>
                <ul style="font-size:9px;padding-left:14px;">
                    <li><a href="https://nmap.org/" target="_blank">Nmap</a></li>
                    <li><a href="https://github.com/samyk/webscan" target="_blank">WebScan</a></li>
                    <li><a href="https://wireshark.org/" target="_blank">Wireshark</a></li>
                    <li><a href="https://wii.hacks.guide/" target="_blank">Wii Homebrew</a></li>
                </ul>
                <button onclick="document.getElementById('real-tools-panel').classList.add('hidden')" style="font-size:8px;width:auto;padding:2px 6px;margin:0;">HIDE</button>
            </div>
            <button onclick="document.getElementById('real-tools-panel').classList.toggle('hidden')" style="width:100%;margin-top:5px;font-size:10px;opacity:0.6;">SHOW REAL TOOLS GUIDE</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;">
            <div class="card" style="border-color:var(--warn-color);margin:0;">
                <label style="font-size:10px;color:var(--warn-color);display:block;margin-bottom:4px;">TARGET IP / URL</label>
                <input type="text" id="cockpit-target" value="192.168.1.1" style="color:var(--warn-color);border-color:var(--warn-color);">
                <label style="font-size:10px;color:var(--warn-color);display:block;margin-bottom:4px;">PROTOCOL</label>
                <select id="cockpit-proto" style="color:var(--warn-color);border-color:var(--warn-color);">
                    <option>SSH (22)</option><option>HTTP (80)</option><option>HTTPS (443)</option><option>FTP (21)</option><option>TELNET (23)</option>
                </select>
            </div>
            <div class="chat-box" id="cockpit-log" style="flex:1;border-color:var(--warn-color);font-size:10px;color:var(--warn-color);margin:0;">
                <div class="term-line">>> DECK INITIALIZED...</div>
            </div>
            <div id="network-scan-panel" class="hidden"><div id="scan-results"></div></div>
        </div>
    </div>
    <button onclick="nav.to('hub')" style="margin-top:12px;border-color:var(--warn-color);color:var(--warn-color);">DISCONNECT</button>
</div>

<!-- REMOTE ACCESS OVERLAY -->
<div id="remote-access-overlay" class="hidden">
    <div style="width:90%;height:80%;background:#000;border:2px solid var(--warn-color);padding:12px;color:inherit;font-family:var(--font-main);box-shadow:0 0 30px var(--warn-color);display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--warn-color);padding-bottom:6px;margin-bottom:10px;">
            <h3 id="remote-title" style="margin:0;color:var(--warn-color);border:none;padding:0;">REMOTE ACCESS</h3>
            <button onclick="cockpit.closeRemote()" class="danger" style="width:auto;padding:5px 10px;margin:0;font-size:10px;">EXIT</button>
        </div>
        <div id="remote-content" style="flex:1;overflow-y:scroll;"></div>
    </div>
</div>

<!-- ================================================================
     KALI OVERLAY
     ================================================================ -->
<div id="screen-kali" class="hidden">
    <div id="kali-bar">
        <div style="display:flex;align-items:center;">
            <span style="color:#f00;font-weight:bold;margin-right:10px;">🐉 KALI_EMU</span>
            <button class="kali-btn" onclick="document.getElementById('kali-menu').classList.toggle('hidden')">Applications ▾</button>
        </div>
        <span style="font-size:11px;opacity:0.5;">root@kali</span>
    </div>
    <div id="kali-desktop" onmousemove="kali.drag(event)" onmouseup="kali.stopDrag()">
        <div id="win-term" class="window" style="z-index:10;">
            <div class="win-header" onmousedown="kali.startDrag(event,'win-term')">
                <span>root@kali:~/python_scripts</span>
                <button onclick="nav.to('soc')" style="background:#ff5f56;width:14px;height:14px;border-radius:50%;padding:0;cursor:pointer;border:none;margin:0;min-width:auto;"></button>
            </div>
            <div class="win-body">
                <div id="py-console"><span class="term-info">Kali GNU/Linux Rolling</span></div>
                <div id="py-input-line">
                    <span style="color:cyan;margin-right:5px;font-size:12px;">>>></span>
                    <input type="text" id="py-input" onkeydown="kali.handleInput(event)">
                </div>
            </div>
        </div>
        <div id="kali-menu" class="hidden" style="position:absolute;top:0;left:0;width:180px;background:#2a2a2a;z-index:50;border:1px solid #444;">
            <button class="kali-btn" style="width:100%;text-align:left;" onclick="kali.openApp('nmap')">Nmap</button>
            <button class="kali-btn" style="width:100%;text-align:left;" onclick="nav.to('soc')">Logout</button>
        </div>
    </div>
</div>

<!-- ================================================================
     SCRIPTS
     ================================================================ -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, getDocs, deleteField, deleteDoc, arrayUnion, arrayRemove }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDxb5GEGx9LZYD4Ijo-N6K849rsneYlgqk", authDomain: "ectenopo.firebaseapp.com", projectId: "ectenopo", storageBucket: "ectenopo.firebasestorage.app", messagingSenderId: "283760497520", appId: "1:283760497520:web:c9fdda2d704ca95c0bf5b5" };
    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);

    const loading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);

    // ================================================================
    // MATRIX RAIN — color tracks body currentColor (same as The Construct)
    // ================================================================
    const matCanvas = document.getElementById('matrix-canvas');
    const matCtx = matCanvas.getContext('2d');
    matCanvas.width  = window.innerWidth;
    matCanvas.height = window.innerHeight;
    window.addEventListener('resize', () => { matCanvas.width = window.innerWidth; matCanvas.height = window.innerHeight; });
    const matLetters = "0101XYZA10110101";
    const matFontSize = 14;
    const matCols = Math.floor(matCanvas.width / matFontSize);
    const matDrops = Array(matCols).fill(1);
    function drawMatrix() {
        matCtx.fillStyle = "rgba(0,0,0,0.05)";
        matCtx.fillRect(0, 0, matCanvas.width, matCanvas.height);
        matCtx.fillStyle = getComputedStyle(document.body).color;
        matCtx.font = matFontSize + "px monospace";
        for (let i = 0; i < matDrops.length; i++) {
            matCtx.fillText(matLetters.charAt(Math.floor(Math.random() * matLetters.length)), i * matFontSize, matDrops[i] * matFontSize);
            if (matDrops[i] * matFontSize > matCanvas.height && Math.random() > 0.975) matDrops[i] = 0;
            matDrops[i]++;
        }
    }
    setInterval(drawMatrix, 33);

    // ================================================================
    // AUDIO
    // ================================================================
    window.audioSys = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        playTone: (freq, type, dur) => {
            if(audioSys.ctx.state==='suspended') audioSys.ctx.resume();
            const o = audioSys.ctx.createOscillator();
            const g = audioSys.ctx.createGain();
            o.type = type; o.frequency.value = freq;
            o.connect(g); g.connect(audioSys.ctx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioSys.ctx.currentTime + dur);
            o.stop(audioSys.ctx.currentTime + dur);
        }
    };

    // ================================================================
    // DEVICE DETECT
    // ================================================================
    window.deviceDetect = {
        getInfo: () => {
            const ua = navigator.userAgent;
            let device = "Desktop", os = "Unknown", browser = "Unknown";
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry/.test(ua)) device = "Mobile";
            else if (/Tablet|iPad/.test(ua)) device = "Tablet";
            if      (ua.indexOf("Win")    > -1) os = "Windows";
            else if (ua.indexOf("Mac")    > -1) os = "macOS";
            else if (ua.indexOf("Linux")  > -1) os = "Linux";
            else if (ua.indexOf("Android")> -1) os = "Android";
            else if (ua.indexOf("iPhone") > -1 || ua.indexOf("iPad") > -1) os = "iOS";
            if      (ua.indexOf("Firefox")> -1) browser = "Firefox";
            else if (ua.indexOf("Chrome") > -1) browser = "Chrome";
            else if (ua.indexOf("Safari") > -1) browser = "Safari";
            else if (ua.indexOf("Edge")   > -1) browser = "Edge";
            return `${device} | ${os} | ${browser}`;
        }
    };

    // ================================================================
    // SYSTEM ALERTS
    // ================================================================
    window.sysAlerts = {
        timer: null,
        banner: document.getElementById('sys-alert-banner'),
        msg: document.getElementById('sys-alert-msg'),
        trigger: (type) => {
            sysAlerts.banner.className = 'alert-off';
            if(sysAlerts.timer) clearTimeout(sysAlerts.timer);
            let text = "", cls = "alert-on ";
            if(type==='INFO')  { text="SYSTEM ANNOUNCEMENT: ROUTINE MAINTENANCE SCHEDULED"; cls+="type-info"; audioSys.playTone(600,'sine',0.5); }
            else if(type==='WARN') { text="WARNING: UNIDENTIFIED NETWORK TRAFFIC DETECTED"; cls+="type-warn"; audioSys.playTone(300,'square',0.2); setTimeout(()=>audioSys.playTone(300,'square',0.2),300); }
            else if(type==='CRIT') { text="CRITICAL: SECURITY BREACH IN PROGRESS — LOCKDOWN"; cls+="type-crit"; let i=0; const s=setInterval(()=>{audioSys.playTone(800+(i%2)*200,'sawtooth',0.1);i++;if(i>10)clearInterval(s);},200); }
            setTimeout(()=>{ sysAlerts.msg.innerText=text; sysAlerts.banner.className=cls; }, 100);
            sysAlerts.timer = setTimeout(sysAlerts.hide, 10000);
        },
        hide: () => { sysAlerts.banner.className = 'alert-off'; }
    };

    // ================================================================
    // STATE
    // ================================================================
    window.state = { user:null, clan:null, clanData:{}, viewedProfile:null, activeCommentId:null, activeCommentType:null, unsubComments:null, currentJob:null };

    // ================================================================
    // NAV
    // ================================================================
    window.nav = {
        to: (id) => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            document.getElementById('screen-kali').classList.add('hidden');
            if(id==='kali') document.getElementById('screen-kali').classList.remove('hidden');
            else document.getElementById('screen-'+id).classList.remove('hidden');
            if(id==='hub')      app.initHub();
            if(id==='jobs')     app.loadJobs();
            if(id==='social')   social.loadPosts();
            if(id==='settings') settings.loadUI();
            if(id==='dict')     app.renderDict();
            if(id==='cockpit')  cockpit.init();
            if(id==='radio')    radio.init();
            if(id==='news')     news.init();
            if(id==='verified') app.initVerifiedChat();
            if(id==='ectotape') app.loadEctoTape();
            if(id==='events')   app.loadEvents();
        },
        tab: (t) => {
            document.getElementById('tab-clans').classList.add('hidden');
            document.getElementById('tab-global').classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('hidden');
        }
    };

    // ================================================================
    // APP
    // ================================================================
    window.app = {
        encMode:false, dictMode:false, clanUnsub:null, clanChatUnsub:null, alertInterval:null,
        voiceContext:null, voiceSource:null, voiceAnalyser:null, voiceAnim:null, voiceActive:false, voiceUnsubscribe:null, voiceHeartbeat:null,

        login: async () => {
            const u=document.getElementById('auth-user').value.trim(); const p=document.getElementById('auth-pass').value.trim();
            if(!u||!p) return; loading(true);
            const snap=await getDoc(doc(db,"users",u)); loading(false);
            if(snap.exists()&&snap.data().pass===p){ state.user=u; nav.to('hub'); } else alert("INVALID");
        },
        register: async () => {
            const u=document.getElementById('auth-user').value.trim(); const p=document.getElementById('auth-pass').value.trim();
            if(!u||!p) return; loading(true);
            const check=await getDoc(doc(db,"users",u));
            if(check.exists()){loading(false);return alert("TAKEN");}
            await setDoc(doc(db,"users",u),{pass:p,clan:null,rep:0,displayName:u,verified:false,pfp:"",private:false});
            loading(false); alert("REGISTERED");
        },
        initHub: async () => {
            loading(true);
            document.getElementById('device-info').innerText="DEVICE: "+deviceDetect.getInfo();
            const snap=await getDoc(doc(db,"users",state.user)); const ud=snap.data();
            let vHTML=ud.verified?`<span class="verified-badge">♦✓</span>`:'';
            document.getElementById('hub-user').innerHTML=`${ud.displayName||state.user} ${vHTML}`;
            const admins=["user1234","user4321"];
            if(admins.includes(state.user.toLowerCase())) document.getElementById('btn-soc').classList.remove('hidden');
            if(ud.verified){ document.getElementById('btn-payload').classList.remove('hidden'); document.getElementById('btn-verified').classList.remove('hidden'); }
            else { document.getElementById('btn-payload').classList.add('hidden'); document.getElementById('btn-verified').classList.add('hidden'); }

            const setupClan=(data)=>{
                if(data.clan){ state.clan=data.clan; if(app.clanUnsub)app.clanUnsub(); app.listenToClan(data.clan); document.getElementById('panel-no-clan').classList.add('hidden'); document.getElementById('panel-in-clan').classList.remove('hidden'); }
                else{ state.clan=null; document.getElementById('panel-no-clan').classList.remove('hidden'); document.getElementById('panel-in-clan').classList.add('hidden'); }
                document.getElementById('hub-rep').innerText="REP: "+(data.rep||0);
            };
            setupClan(ud);
            app.userUnsub=onSnapshot(doc(db,"users",state.user),(d)=>setupClan(d.data()));
            loading(false);
            const gq=query(collection(db,"global_chat"),orderBy("ts","desc"),limit(50));
            onSnapshot(gq,(snap)=>{ const d=document.getElementById('global-chat'); d.innerHTML=""; const msgs=[]; snap.forEach(dc=>msgs.push(dc.data())); msgs.reverse().forEach(m=>d.innerHTML+=`<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}</div>`); d.scrollTop=d.scrollHeight; });
        },
        sendGlobalMsg: async()=>{ const t=document.getElementById('global-input').value; if(t){await addDoc(collection(db,"global_chat"),{u:state.user,txt:t,ts:serverTimestamp()});document.getElementById('global-input').value="";} },

        initVerifiedChat: ()=>{
            const d=document.getElementById('verified-chat'); d.innerHTML="Establishing Secure Uplink...";
            const q=query(collection(db,"verified_chat"),orderBy("ts","desc"),limit(50));
            onSnapshot(q,(snap)=>{ d.innerHTML=""; const msgs=[]; snap.forEach(dc=>msgs.push(dc.data())); msgs.reverse().forEach(m=>d.innerHTML+=`<div class="chat-msg" style="color:#FFD700;border-color:#664400;"><strong>${m.u}:</strong> ${m.txt}</div>`); d.scrollTop=d.scrollHeight; });
        },
        sendVerifiedMsg: async()=>{ const t=document.getElementById('verified-input').value; if(t){await addDoc(collection(db,"verified_chat"),{u:state.user,txt:t,ts:serverTimestamp()});document.getElementById('verified-input').value="";} },

        searchUser: ()=>{ const u=document.getElementById('search-user-input').value.trim(); if(u)app.openProfile(u); },
        openProfile: async(target)=>{
            loading(true); const snap=await getDoc(doc(db,"users",target)); loading(false);
            if(!snap.exists()) return alert("USER NOT FOUND");
            const d=snap.data(); state.viewedProfile=target;
            document.getElementById('prof-username').innerText="@"+target;
            document.getElementById('prof-displayname').innerText=d.displayName||target;
            document.getElementById('prof-pfp-display').style.backgroundImage=d.pfp?`url('${d.pfp}')`:"none";
            if(d.verified)document.getElementById('prof-verified').classList.remove('hidden'); else document.getElementById('prof-verified').classList.add('hidden');
            if(d.private&&target!==state.user){document.getElementById('prof-clan').innerText="[REDACTED]";document.getElementById('prof-rep').innerText="[REDACTED]";}
            else{document.getElementById('prof-clan').innerText=d.clan||"NONE";document.getElementById('prof-rep').innerText=d.rep||"0";}
            if(target===state.user){document.getElementById('prof-edit-panel').classList.remove('hidden');document.getElementById('edit-disp').value=d.displayName||"";document.getElementById('edit-pfp').value=d.pfp||"";document.getElementById('edit-private').checked=d.private||false;}
            else document.getElementById('prof-edit-panel').classList.add('hidden');
            const admins=["user1234","user4321"];
            if(admins.includes(state.user.toLowerCase())&&target!==state.user)document.getElementById('prof-admin-panel').classList.remove('hidden'); else document.getElementById('prof-admin-panel').classList.add('hidden');
            nav.to('profile');
        },
        saveProfile: async()=>{ const dn=document.getElementById('edit-disp').value.trim(); const pf=document.getElementById('edit-pfp').value.trim(); const priv=document.getElementById('edit-private').checked; await updateDoc(doc(db,"users",state.user),{displayName:dn,pfp:pf,private:priv}); alert("SAVED"); app.openProfile(state.user); },
        verifyUser: async()=>{ if(!confirm("VERIFY?"))return; await updateDoc(doc(db,"users",state.viewedProfile),{verified:true}); alert("VERIFIED"); app.openProfile(state.viewedProfile); },

        listenToClan: (cName)=>{
            document.getElementById('panel-no-clan').classList.add('hidden');
            document.getElementById('panel-in-clan').classList.remove('hidden');
            document.getElementById('clan-header').innerText=cName;
            if(app.clanUnsub){app.clanUnsub();app.clanUnsub=null;}
            if(app.clanChatUnsub){app.clanChatUnsub();app.clanChatUnsub=null;}

            app.clanUnsub=onSnapshot(doc(db,"clans",cName),(dc)=>{
                state.clanData=dc.data()||{};
                if(state.clanData.leader===state.user){document.getElementById('btn-delete-clan').classList.remove('hidden');document.getElementById('clan-leader-cmds').classList.remove('hidden');}
                else{document.getElementById('btn-delete-clan').classList.add('hidden');document.getElementById('clan-leader-cmds').classList.add('hidden');}
                if(!document.getElementById('screen-dict').classList.contains('hidden'))app.renderDict();
            });

            const q=query(collection(db,"clans",cName,"msgs"),orderBy("ts","desc"),limit(50));
            app.clanChatUnsub=onSnapshot(q,(snap)=>{
                const d=document.getElementById('clan-chat'); d.innerHTML="";
                const msgs=[]; snap.forEach(dc=>msgs.push(dc.data()));
                snap.docChanges().forEach(change=>{
                    if(change.type==="added"){
                        const m=change.doc.data(); const now=Date.now(); const mt=m.ts?m.ts.toMillis():now;
                        if(now-mt<15000){
                            if(m.type==='WARN'){audioSys.playTone(800,'sine',0.1);setTimeout(()=>audioSys.playTone(800,'sine',0.1),200);setTimeout(()=>audioSys.playTone(800,'sine',0.1),400);}
                            if(m.type==='ALERT')app.triggerClanRedAlert(m.txt);
                        }
                    }
                });
                msgs.reverse().forEach(m=>{
                    let txt=app.translate(m.txt); let style="";
                    const rank=(state.clanData.ranks&&state.clanData.ranks[m.u])?state.clanData.ranks[m.u].toUpperCase():'MEMBER';
                    const prefix=`<span style="opacity:0.5;font-size:0.8em;">[${rank}]</span>`;
                    if(m.type==='ANNOUNCE') style="font-weight:bold;color:#00FF00;border:1px solid #004400;padding:5px;margin:4px 0;background:rgba(0,255,0,0.05);display:block;";
                    if(m.type==='WARN')    style="font-weight:bold;color:#FFAA00;border:1px solid #332200;padding:5px;margin:4px 0;background:rgba(255,170,0,0.05);display:block;";
                    if(m.type==='ALERT')   style="font-weight:bold;color:#fff;background:red;padding:5px;margin:4px 0;border:1px solid #fff;display:block;";
                    if(m.u==="SYSTEM") d.innerHTML+=`<div class="chat-msg" style="${style}"><strong>SYSTEM:</strong> ${txt}</div>`;
                    else d.innerHTML+=`<div class="chat-msg" style="${style}">${prefix} <strong>${m.u}:</strong> ${txt}</div>`;
                });
                d.scrollTop=d.scrollHeight;
            });
            app.listenToVoiceUsers();
        },

        sendClanAlert: async(level)=>{
            if(state.clanData.leader!==state.user)return;
            const txt=prompt(`ENTER ${level} MESSAGE:`); if(!txt)return;
            await addDoc(collection(db,"clans",state.clan,"msgs"),{u:"SYSTEM",txt,type:level,ts:serverTimestamp()});
        },
        triggerClanRedAlert: (msg)=>{
            document.getElementById('clan-alert-msg').innerText=msg;
            document.getElementById('clan-alert-overlay').classList.remove('hidden');
            if(app.alertInterval)clearInterval(app.alertInterval);
            const ctx=audioSys.ctx;
            app.alertInterval=setInterval(()=>{
                if(ctx.state==='suspended')ctx.resume();
                const osc=ctx.createOscillator(); const g=ctx.createGain();
                osc.connect(g); g.connect(ctx.destination); osc.type='sawtooth';
                const now=ctx.currentTime;
                osc.frequency.setValueAtTime(600,now); osc.frequency.linearRampToValueAtTime(1200,now+0.5); osc.frequency.linearRampToValueAtTime(600,now+1.0);
                g.gain.setValueAtTime(0.2,now); osc.start(now); osc.stop(now+1.0);
            },1000);
        },
        ackAlert: ()=>{ document.getElementById('clan-alert-overlay').classList.add('hidden'); if(app.alertInterval)clearInterval(app.alertInterval); },

        listenToVoiceUsers: ()=>{
            if(!state.clan)return;
            if(app.voiceUnsubscribe)app.voiceUnsubscribe();
            const q=query(collection(db,"clans",state.clan,"voice_users"),orderBy("joinedAt","desc"));
            app.voiceUnsubscribe=onSnapshot(q,(snap)=>{
                const list=document.getElementById('voice-users-list'); const cont=document.getElementById('voice-users-container');
                if(snap.empty){cont.classList.add('hidden');return;}
                cont.classList.remove('hidden'); list.innerHTML="";
                snap.forEach(dc=>{ const ud=dc.data(); const now=Date.now(); const ls=ud.lastSeen?ud.lastSeen.toMillis():now; if(now-ls<10000) list.innerHTML+=`<div class="voice-user-item"><div class="voice-user-indicator"></div><span>${dc.id}</span><small style="opacity:0.4;margin-left:auto;">${ud.device||'?'}</small></div>`; });
            });
        },

        toggleVoice: async()=>{
            const btn=document.getElementById('btn-voice-conn'); const status=document.getElementById('voice-status'); const viz=document.getElementById('voice-viz'); const muteBtn=document.getElementById('btn-voice-mute');
            if(app.voiceActive){
                if(app.voiceSource){app.voiceSource.disconnect();app.voiceSource=null;}
                if(app.voiceAnim){cancelAnimationFrame(app.voiceAnim);app.voiceAnim=null;}
                if(state.clan&&state.user){try{await deleteDoc(doc(db,"clans",state.clan,"voice_users",state.user));}catch(e){}}
                if(app.voiceHeartbeat){clearInterval(app.voiceHeartbeat);app.voiceHeartbeat=null;}
                btn.innerText="CONNECT MIC"; status.style.background="#330000"; viz.innerHTML=""; muteBtn.disabled=true; app.voiceActive=false;
            } else {
                try {
                    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
                    app.voiceContext=new(window.AudioContext||window.webkitAudioContext)();
                    app.voiceAnalyser=app.voiceContext.createAnalyser(); app.voiceAnalyser.fftSize=64;
                    app.voiceSource=app.voiceContext.createMediaStreamSource(stream);
                    app.voiceSource.connect(app.voiceAnalyser);
                    const bufLen=app.voiceAnalyser.frequencyBinCount; const dataArr=new Uint8Array(bufLen);
                    viz.innerHTML="";
                    for(let i=0;i<bufLen;i++){const b=document.createElement('div');b.className='voice-bar';b.id='vbar-'+i;viz.appendChild(b);}
                    if(state.clan&&state.user){
                        await setDoc(doc(db,"clans",state.clan,"voice_users",state.user),{joinedAt:serverTimestamp(),lastSeen:serverTimestamp(),speaking:false,device:deviceDetect.getInfo()});
                        app.voiceHeartbeat=setInterval(async()=>{ if(state.clan&&state.user&&app.voiceActive){app.voiceAnalyser.getByteFrequencyData(dataArr);const avg=dataArr.reduce((a,b)=>a+b,0)/dataArr.length;await updateDoc(doc(db,"clans",state.clan,"voice_users",state.user),{lastSeen:serverTimestamp(),speaking:avg>30});} },2000);
                    }
                    const draw=()=>{ if(!app.voiceActive)return; app.voiceAnim=requestAnimationFrame(draw); app.voiceAnalyser.getByteFrequencyData(dataArr); for(let i=0;i<bufLen;i++){const b=document.getElementById('vbar-'+i);if(b)b.style.height=(dataArr[i]/5)+"px";} };
                    app.voiceActive=true; draw();
                    btn.innerText="DISCONNECT"; status.style.background="currentColor"; muteBtn.disabled=false;
                } catch(e){alert("MIC ACCESS DENIED OR NOT FOUND");}
            }
        },
        muteVoice: ()=>{
            const btn=document.getElementById('btn-voice-mute');
            if(btn.innerText==="MUTE"){if(app.voiceSource)app.voiceSource.disconnect(app.voiceAnalyser);btn.innerText="UNMUTE";}
            else{if(app.voiceSource)app.voiceSource.connect(app.voiceAnalyser);btn.innerText="MUTE";}
        },

        loadRoster: ()=>{
            nav.to('ranks'); const list=document.getElementById('roster-list'); list.innerHTML="";
            const ranks=state.clanData.ranks||{}; const isLeader=state.clanData.leader===state.user;
            for(const [member,rank] of Object.entries(ranks)){
                let ctrl="";
                if(isLeader&&member!==state.user) ctrl=`<button onclick="app.clanKick('${member}')" style="width:auto;font-size:10px;padding:3px 6px;margin:0;" class="danger">KICK</button><button onclick="app.setCustomRank('${member}')" style="width:auto;font-size:10px;padding:3px 6px;margin:0 0 0 5px;">SET RANK</button>`;
                list.innerHTML+=`<div class="card" style="display:flex;justify-content:space-between;align-items:center;"><span>${member} <span style="color:#FFD700;font-size:11px;">[${rank.toUpperCase()}]</span></span><div>${ctrl}</div></div>`;
            }
        },
        setCustomRank: async(member)=>{ const r=prompt("ENTER CUSTOM RANK TITLE:"); if(r){await updateDoc(doc(db,"clans",state.clan),{[`ranks.${member}`]:r.toUpperCase()});app.loadRoster();} },
        clanKick: async(target)=>{ if(!confirm(`KICK ${target}?`))return; await updateDoc(doc(db,"clans",state.clan),{[`ranks.${target}`]:deleteField()}); await updateDoc(doc(db,"users",target),{clan:null}); app.loadRoster(); },
        deleteClan: async()=>{ const cN=state.clan; if(!confirm("WARNING: DELETE CLAN?"))return; loading(true); const cD=await getDoc(doc(db,"clans",cN)); for(const m of Object.keys(cD.data().ranks))await updateDoc(doc(db,"users",m),{clan:null}); await deleteDoc(doc(db,"clans",cN)); loading(false); alert("DELETED"); nav.to('hub'); },
        joinClan: async()=>{ const n=document.getElementById('join-name').value.trim(); const p=document.getElementById('join-pass').value.trim(); const s=await getDoc(doc(db,"clans",n)); if(s.exists()&&s.data().pass===p){await updateDoc(doc(db,"users",state.user),{clan:n});await updateDoc(doc(db,"clans",n),{[`ranks.${state.user}`]:'member'});}else alert("INVALID"); },
        leaveClan: async()=>{ if(!confirm("LEAVE?"))return; await updateDoc(doc(db,"users",state.user),{clan:null}); await updateDoc(doc(db,"clans",state.clan),{[`ranks.${state.user}`]:deleteField()}); },
        sendClanMsg: async()=>{ const t=document.getElementById('clan-input').value; if(t){await addDoc(collection(db,"clans",state.clan,"msgs"),{u:state.user,txt:t,ts:serverTimestamp()});document.getElementById('clan-input').value="";} },

        toggleEnc: ()=>{ app.encMode=!app.encMode; document.getElementById('btn-enc').style.opacity=app.encMode?'1':'0.5'; },
        toggleDict: ()=>{ app.dictMode=!app.dictMode; document.getElementById('btn-dict').style.opacity=app.dictMode?'1':'0.5'; },
        translate: (txt)=>{ if(!app.encMode&&!app.dictMode)return txt; let out=""; const words=state.clanData.words||{}; const syms=state.clanData.symbols||{}; txt.split(" ").forEach(w=>{ const c=w.toLowerCase().replace(/[^a-z]/g,''); let fw=w; if(app.dictMode&&words[c])fw=words[c]; else if(app.encMode&&words[c])fw=words[c]; if(app.encMode){const cl=fw.toLowerCase().replace(/[^a-z]/g,'');out+=app.strToSym(cl,syms)+" ";}else{out+=fw+" ";} }); return out; },
        strToSym: (str,syms)=>{ let html=""; for(let c of str){if(syms[c.toUpperCase()])html+=`<img src="${syms[c.toUpperCase()]}" class="chat-img">`;else html+=c;} return html; },

        renderDict: ()=>{ const list=document.getElementById('dict-list'); list.innerHTML=""; const words=state.clanData.words||{}; if(!Object.keys(words).length){list.innerHTML="<div style='opacity:0.4;padding:8px;'>DICTIONARY EMPTY</div>";return;} for(const[k,v]of Object.entries(words)){list.innerHTML+=`<div style="border-bottom:1px solid var(--dim);padding:5px;display:flex;justify-content:space-between;"><span>${k} <span style="opacity:0.5;">→</span> ${v}</span><button onclick="app.delWord('${k}')" style="width:auto;padding:2px 6px;margin:0;font-size:10px;" class="danger">X</button></div>`;} },
        addWord: async()=>{ const k=document.getElementById('dict-orig').value.toLowerCase(); const v=document.getElementById('dict-new').value.toLowerCase(); if(k&&v&&state.clan)await updateDoc(doc(db,"clans",state.clan),{[`words.${k}`]:v}); app.renderDict(); },
        delWord: async(k)=>{ if(!confirm("DELETE?"))return; await updateDoc(doc(db,"clans",state.clan),{[`words.${k}`]:deleteField()}); app.renderDict(); },

        createEvent: async()=>{ const n=document.getElementById('evt-name').value; if(!n)return; await addDoc(collection(db,"events"),{name:n,desc:document.getElementById('evt-desc').value,start:document.getElementById('evt-start').value,end:document.getElementById('evt-end').value,creator:state.user,ts:serverTimestamp()}); alert("CREATED"); app.loadEvents(); },
        loadEvents: async()=>{ const list=document.getElementById('event-list'); list.innerHTML="LOADING..."; const q=query(collection(db,"events"),orderBy("start","asc")); const snap=await getDocs(q); list.innerHTML=""; snap.forEach(d=>{const e=d.data();list.innerHTML+=`<div class="card"><strong>${e.name}</strong><br><span style="opacity:0.6;font-size:11px;">${e.start} — ${e.end||'?'}</span><br><p style="margin:4px 0;font-size:12px;">${e.desc}</p><small style="opacity:0.4;">ORG: ${e.creator}</small></div>`;}); },
        createJob: async()=>{ const t=document.getElementById('job-title').value; if(!t)return; await addDoc(collection(db,"jobs"),{title:t,desc:document.getElementById('job-desc').value,owner:state.user,worker:null,status:'OPEN',ts:serverTimestamp()}); alert("POSTED"); app.loadJobs(); },
        loadJobs: async()=>{ const list=document.getElementById('job-list'); list.innerHTML="LOADING..."; const q=query(collection(db,"jobs"),orderBy("ts","desc")); const snap=await getDocs(q); list.innerHTML=""; snap.forEach(d=>{const j=d.data();const id=d.id;let act="";if(j.status==='OPEN'&&j.owner!==state.user)act=`<button onclick="app.acceptJob('${id}')" style="margin-top:5px;">ACCEPT</button>`;else if(j.owner===state.user||j.worker===state.user)act=`<button onclick="app.openJobChat('${id}')" class="warn" style="margin-top:5px;">OPEN CHAT</button>`;else act=`<button disabled style="margin-top:5px;">CLOSED</button>`;list.innerHTML+=`<div class="card"><strong>${j.title}</strong> <span style="opacity:0.5;font-size:10px;">[${j.status}]</span><br><em style="opacity:0.7;font-size:11px;">${j.desc}</em><br><small style="opacity:0.4;">CLIENT: ${j.owner}</small>${act}</div>`;}); },
        acceptJob: async(jid)=>{ if(!confirm("ACCEPT?"))return; await updateDoc(doc(db,"jobs",jid),{worker:state.user,status:'ASSIGNED'}); app.openJobChat(jid); },
        openJobChat: (jid)=>{ document.getElementById('job-chat-panel').classList.remove('hidden'); state.currentJob=jid; onSnapshot(query(collection(db,"jobs",jid,"msgs"),orderBy("ts","desc")),(snap)=>{const div=document.getElementById('job-chat-box');div.innerHTML="";const msgs=[];snap.forEach(d=>msgs.push(d.data()));msgs.reverse().forEach(m=>div.innerHTML+=`<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}</div>`);div.scrollTop=div.scrollHeight;}); },
        sendJobMsg: async()=>{ const t=document.getElementById('job-msg-input').value; if(t)await addDoc(collection(db,"jobs",state.currentJob,"msgs"),{u:state.user,txt:t,ts:serverTimestamp()}); document.getElementById('job-msg-input').value=""; },
        closeJobChat: ()=>{ document.getElementById('job-chat-panel').classList.add('hidden'); state.currentJob=null; },

        loadEctoTape: async()=>{
            const admins=["user1234","user4321"]; const feed=document.getElementById('video-feed');
            feed.innerHTML="<div style='opacity:0.4;padding:10px;'>LOADING STREAM...</div>";
            try{
                const q=query(collection(db,"ectotape_vids"),orderBy("ts","desc"),limit(20));
                const snap=await getDocs(q); feed.innerHTML="";
                if(snap.empty){feed.innerHTML="<div style='opacity:0.4;padding:20px;text-align:center;'>NO BROADCASTS YET.</div>";return;}
                snap.forEach(d=>{const v=d.data();const embed=app.getEmbedUrl(v.url);const vh=embed?`<iframe width="100%" height="150" src="${embed}" frameborder="0" allowfullscreen style="display:block;margin-top:5px;"></iframe>`:`<a href="${v.url}" target="_blank" style="color:var(--rep-watch);">[OPEN LINK]</a>`;feed.innerHTML+=`<div class="card" style="border-color:var(--rep-watch);"><strong style="color:var(--rep-watch);">${v.title}</strong><br><small style="opacity:0.4;">BY: ${v.uploader||'?'}</small>${vh}</div>`;});
            }catch(e){feed.innerHTML="<div style='color:red;'>ERROR: "+e.message+"</div>";}
            if(admins.includes(state.user.toLowerCase()))document.getElementById('upload-zone').classList.remove('hidden');
        },
        uploadVideo: async()=>{ const title=document.getElementById('vid-title').value.trim(); const url=document.getElementById('vid-url').value.trim(); if(!title||!url)return alert("TITLE AND URL REQUIRED"); await addDoc(collection(db,"ectotape_vids"),{title,url,uploader:state.user,ts:serverTimestamp()}); document.getElementById('vid-title').value=""; document.getElementById('vid-url').value=""; alert("BROADCAST UPLOADED"); app.loadEctoTape(); },

        createClanStart: ()=>{ const n=document.getElementById('create-name').value; const p=document.getElementById('create-pass').value; if(!n||!p)return; drawing.mode="create"; drawing.tempData={name:n,pass:p,syms:{}}; drawing.letters="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''); drawing.idx=0; nav.to('draw'); },
        startSymbolEdit: ()=>{ drawing.mode="edit"; drawing.tempData={syms:{...state.clanData.symbols}}; drawing.letters="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''); drawing.idx=0; nav.to('draw'); },
        runSecurityScan: (type)=>{ const c=document.getElementById('soc-console'); c.innerHTML+=`<div class="term-line">> SCANNING ${type}...</div>`; setTimeout(()=>c.innerHTML+=`<div class="term-line">> COMPLETE. CLEAN.</div>`,1500); },
        getEmbedUrl: (url)=>{ if(!url)return null; let id=null; const s=url.match(/youtu\.be\/([^?&]+)/); if(s)id=s[1]; const l=url.match(/[?&]v=([^?&]+)/); if(!id&&l)id=l[1]; const e=url.match(/embed\/([^?&]+)/); if(!id&&e)id=e[1]; return id?`https://www.youtube.com/embed/${id}`:null; }
    };

    // ================================================================
    // SOCIAL
    // ================================================================
    window.social = {
        tab: (t)=>{ document.getElementById('soc-tab-posts').classList.add('hidden'); document.getElementById('soc-tab-polls').classList.add('hidden'); document.getElementById('soc-tab-'+t).classList.remove('hidden'); if(t==='posts')social.loadPosts(); if(t==='polls')social.loadPolls(); },
        like: async(id,type)=>{ const col=type==='post'?'posts':'polls'; const ref=doc(db,col,id); const snap=await getDoc(ref); const d=snap.data(); const likes=d.likes||[]; const dislikes=d.dislikes||[]; if(likes.includes(state.user))await updateDoc(ref,{likes:arrayRemove(state.user)});else{await updateDoc(ref,{likes:arrayUnion(state.user)});if(dislikes.includes(state.user))await updateDoc(ref,{dislikes:arrayRemove(state.user)});} type==='post'?social.loadPosts():social.loadPolls(); },
        dislike: async(id,type)=>{ const col=type==='post'?'posts':'polls'; const ref=doc(db,col,id); const snap=await getDoc(ref); const d=snap.data(); const likes=d.likes||[]; const dislikes=d.dislikes||[]; if(dislikes.includes(state.user))await updateDoc(ref,{dislikes:arrayRemove(state.user)});else{await updateDoc(ref,{dislikes:arrayUnion(state.user)});if(likes.includes(state.user))await updateDoc(ref,{likes:arrayRemove(state.user)});} type==='post'?social.loadPosts():social.loadPolls(); },

        openComments: (id, type)=>{
            state.activeCommentId=id; state.activeCommentType=type;
            const col=type==='post'?'posts':'polls';
            document.getElementById('comment-overlay').classList.remove('hidden');
            document.getElementById('active-comment-list').innerHTML="<div style='opacity:0.4;'>Loading...</div>";
            if(state.unsubComments){state.unsubComments();state.unsubComments=null;}
            const q=query(collection(db,col,id,"comments"),orderBy("ts","asc"));
            state.unsubComments=onSnapshot(q,(snap)=>{
                const div=document.getElementById('active-comment-list'); div.innerHTML="";
                if(snap.empty){div.innerHTML="<div style='opacity:0.4;padding:10px;'>No comments yet. Be first!</div>";return;}
                snap.forEach(d=>{ const c=d.data(); div.innerHTML+=`<div class="comment-item"><strong>${c.u}:</strong> ${c.txt}</div>`; });
                div.scrollTop=div.scrollHeight;
            });
        },
        closeComments: ()=>{ document.getElementById('comment-overlay').classList.add('hidden'); if(state.unsubComments){state.unsubComments();state.unsubComments=null;} state.activeCommentId=null; state.activeCommentType=null; },
        submitComment: async()=>{
            const txt=document.getElementById('new-comment-input').value.trim(); if(!txt||!state.activeCommentId)return;
            const col=state.activeCommentType==='post'?'posts':'polls';
            const btn=document.querySelector('#comment-overlay button:last-child'); if(btn)btn.disabled=true;
            await addDoc(collection(db,col,state.activeCommentId,"comments"),{u:state.user,txt,ts:serverTimestamp()});
            document.getElementById('new-comment-input').value="";
            if(btn)btn.disabled=false;
        },

        createPost: async()=>{ const txt=document.getElementById('post-content').value; const vid=document.getElementById('post-video').value; if(!txt)return; await addDoc(collection(db,"posts"),{u:state.user,txt,video:vid||null,ts:serverTimestamp(),likes:[],dislikes:[]}); document.getElementById('post-content').value=""; document.getElementById('post-video').value=""; social.loadPosts(); },
        loadPosts: async()=>{
            const div=document.getElementById('feed-posts'); div.innerHTML="LOADING FEED...";
            const q=query(collection(db,"posts"),orderBy("ts","desc"),limit(20)); const snap=await getDocs(q); div.innerHTML="";
            snap.forEach(d=>{ const p=d.data(); const likes=(p.likes||[]).length; const dislikes=(p.dislikes||[]).length; const uL=(p.likes||[]).includes(state.user)?"active-action":""; const uD=(p.dislikes||[]).includes(state.user)?"active-action":""; let vH=""; if(p.video){const e=app.getEmbedUrl(p.video);if(e)vH=`<iframe class="vid-embed" src="${e}" allowfullscreen></iframe>`;} div.innerHTML+=`<div class="card"><div class="post-header"><span onclick="app.openProfile('${p.u}')" style="cursor:pointer;">@${p.u}</span><span>${p.ts?new Date(p.ts.toDate()).toLocaleTimeString():'NOW'}</span></div><div style="margin-bottom:5px;">${p.txt}</div>${vH}<div class="social-actions"><button class="social-btn ${uL}" onclick="social.like('${d.id}','post')">LIKE (${likes})</button><button class="social-btn ${uD}" onclick="social.dislike('${d.id}','post')">DISLIKE (${dislikes})</button><button class="social-btn" onclick="social.openComments('${d.id}','post')">COMMENTS</button></div></div>`; });
        },
        createPoll: async()=>{ const q=document.getElementById('poll-q').value; const o1=document.getElementById('poll-o1').value; const o2=document.getElementById('poll-o2').value; const vid=document.getElementById('poll-video').value; if(!q||!o1||!o2)return; await addDoc(collection(db,"polls"),{u:state.user,q,video:vid||null,opts:[{t:o1,v:0},{t:o2,v:0}],voters:[],likes:[],dislikes:[],ts:serverTimestamp()}); document.getElementById('poll-creator').classList.add('hidden'); social.loadPolls(); },
        loadPolls: async()=>{
            const div=document.getElementById('feed-polls'); div.innerHTML="LOADING POLLS...";
            const q=query(collection(db,"polls"),orderBy("ts","desc"),limit(10)); const snap=await getDocs(q); div.innerHTML="";
            snap.forEach(d=>{ const p=d.data(); const likes=(p.likes||[]).length; const dislikes=(p.dislikes||[]).length; const uL=(p.likes||[]).includes(state.user)?"active-action":""; const uD=(p.dislikes||[]).includes(state.user)?"active-action":""; let optsH=""; p.opts.forEach((opt,idx)=>{const total=p.opts.reduce((a,b)=>a+b.v,0)||1;const pct=Math.round((opt.v/total)*100);optsH+=`<div style="margin-top:6px;cursor:pointer;" onclick="social.vote('${d.id}',${idx})"><div style="display:flex;justify-content:space-between;font-size:12px;"><span>${opt.t}</span><span>${opt.v}</span></div><div class="poll-bar"><div class="poll-fill" style="width:${pct}%"></div></div></div>`;}); let vH=""; if(p.video){const e=app.getEmbedUrl(p.video);if(e)vH=`<iframe class="vid-embed" src="${e}" allowfullscreen></iframe>`;} div.innerHTML+=`<div class="card"><div class="post-header"><span>POLL BY @${p.u}</span></div><strong>${p.q}</strong>${vH}${optsH}<div class="social-actions"><button class="social-btn ${uL}" onclick="social.like('${d.id}','poll')">LIKE (${likes})</button><button class="social-btn ${uD}" onclick="social.dislike('${d.id}','poll')">DISLIKE (${dislikes})</button><button class="social-btn" onclick="social.openComments('${d.id}','poll')">COMMENTS</button></div></div>`; });
        },
        vote: async(id,optIdx)=>{ const ref=doc(db,"polls",id); const snap=await getDoc(ref); const d=snap.data(); if(d.voters.includes(state.user))return alert("ALREADY VOTED"); d.opts[optIdx].v++; d.voters.push(state.user); await updateDoc(ref,{opts:d.opts,voters:d.voters}); social.loadPolls(); }
    };

    // ================================================================
    // NEWS
    // ================================================================
    window.news = {
        init: async()=>{ news.loadInternal(); },
        post: async()=>{ const h=document.getElementById('news-headline').value; const l=document.getElementById('news-link-input').value; if(!h)return; await addDoc(collection(db,"news"),{title:h,link:l||null,u:state.user,ts:serverTimestamp()}); document.getElementById('news-headline').value=""; document.getElementById('news-link-input').value=""; news.loadInternal(); },
        loadInternal: async()=>{
            const d=document.getElementById('news-feed-internal'); d.innerHTML="Scanning local nodes...";
            const q=query(collection(db,"news"),orderBy("ts","desc"),limit(10)); const snap=await getDocs(q); d.innerHTML="";
            snap.forEach(dc=>{ const n=dc.data(); d.innerHTML+=`<div style="border-bottom:1px solid var(--dim);margin-bottom:5px;padding-bottom:5px;"><strong>${n.title}</strong>${n.link?`<br><a href="${n.link}" target="_blank" style="font-size:10px;opacity:0.5;">[SOURCE]</a>`:''}<br><small style="opacity:0.4;">@${n.u}</small></div>`; });
            if(snap.empty)d.innerHTML="<div style='opacity:0.4;'>No broadcasts yet.</div>";
        }
    };

    // ================================================================
    // RADIO
    // ================================================================
    window.radio = {
        interval:null, noiseNode:null,
        init: ()=>{
            const viz=document.getElementById('freq-viz'); viz.innerHTML="";
            for(let i=0;i<24;i++)viz.innerHTML+=`<div class="freq-bar" id="fb-${i}" style="height:${Math.random()*48}px"></div>`;
            if(radio.interval)clearInterval(radio.interval);
            radio.interval=setInterval(()=>{ for(let i=0;i<24;i++){const el=document.getElementById(`fb-${i}`);if(el)el.style.height=(Math.random()*44+4)+"px";} },90);
        },
        scan: ()=>{ audioSys.playTone(800,'sawtooth',0.1); document.getElementById('radio-freq').innerText=(400+Math.random()*100).toFixed(4); },
        toggleNoise: ()=>{
            if(radio.noiseNode){radio.noiseNode.disconnect();radio.noiseNode=null;document.getElementById('btn-noise').style.cssText="";}
            else{
                const ctx=audioSys.ctx; if(ctx.state==='suspended')ctx.resume();
                const wn=ctx.createScriptProcessor(4096,1,1);
                wn.onaudioprocess=(e)=>{const out=e.outputBuffer.getChannelData(0);for(let i=0;i<4096;i++)out[i]=Math.random()*0.08-0.04;};
                wn.connect(ctx.destination); radio.noiseNode=wn;
                document.getElementById('btn-noise').style.cssText="background:var(--warn-color);color:#000;";
            }
        }
    };

    // ================================================================
    // COCKPIT
    // ================================================================
    window.cockpit = {
        running:false, ctx:null, canvas:null, gain:50, rate:30, currentDevices:[], currentRemote:null,
        init: ()=>{
            cockpit.canvas=document.getElementById('cockpit-canvas');
            cockpit.ctx=cockpit.canvas.getContext('2d');
            cockpit.running=true; cockpit.animate(); cockpit.detectLocalIP();
        },
        toggle: (el)=>{ el.classList.toggle('toggle-active'); audioSys.playTone(600,'square',0.05); },
        updateGain: (v)=>cockpit.gain=v,
        updateRate: (v)=>cockpit.rate=v,
        log: (txt)=>{ const l=document.getElementById('cockpit-log'); l.innerHTML+=`<div class="term-line">${txt}</div>`; l.scrollTop=l.scrollHeight; },
        runAction: (action)=>{
            audioSys.playTone(200,'sawtooth',0.1);
            const t=document.getElementById('cockpit-target').value; const p=document.getElementById('cockpit-proto').value;
            const led=event.currentTarget.querySelector('.led'); led.classList.add('on');
            cockpit.log(`>> EXEC: ${action} ON ${t} (${p})...`);
            setTimeout(()=>{
                if(action==='PING_SWEEP')cockpit.log(`>> REPLY: BYTES=32 TIME=${Math.floor(Math.random()*50)}ms TTL=54`);
                else if(action==='PORT_SCAN')cockpit.log(`>> PORT ${Math.floor(Math.random()*65535)} [OPEN]`);
                else if(action==='BRUTE_FORCE')cockpit.log(`>> CREDENTIALS... [FAIL]`);
                else if(action==='EXECUTE_PAYLOAD'){cockpit.log(`>> UPLOADING... [||||||||||] 100%`);cockpit.log(`>> ROOT ACCESS GRANTED`);audioSys.playTone(1000,'square',0.5);}
                else cockpit.log(`>> PROCESS COMPLETE.`);
                setTimeout(()=>led.classList.remove('on'),200);
            },1000+Math.random()*2000);
        },
        detectLocalIP: ()=>{
            const rtc=new RTCPeerConnection({iceServers:[]});
            rtc.createDataChannel(''); rtc.createOffer().then(o=>rtc.setLocalDescription(o));
            rtc.onicecandidate=(e)=>{ if(e.candidate){const ip=/([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(e.candidate.candidate)?.[1];if(ip)cockpit.log(`>> LOCAL IP: ${ip}`);} };
            setTimeout(()=>rtc.close(),1000);
        },
        scanNetwork: ()=>{
            cockpit.log(`>> INITIATING LAN DISCOVERY...`);
            audioSys.playTone(400,'sawtooth',0.2);
            const pf=document.getElementById('scan-progress-fill'); let prog=0;
            const iv=setInterval(()=>{prog+=Math.random()*10;if(prog>100)prog=100;pf.style.width=prog+'%';},100);
            setTimeout(()=>{
                clearInterval(iv); pf.style.width='100%';
                cockpit.currentDevices=[
                    {ip:'192.168.1.1',mac:'00:11:22:33:44:55',os:'Router (Firmware v2.1)',ports:'80,443',vuln:'Low',type:'Router'},
                    {ip:'192.168.1.10',mac:'AA:BB:CC:DD:EE:FF',os:'Windows 10',ports:'3389,445',vuln:'Medium',type:'PC'},
                    {ip:'192.168.1.15',mac:'11:22:33:44:55:66',os:'iOS 17',ports:'5353',vuln:'Low',type:'Mobile'},
                    {ip:'192.168.1.20',mac:'FF:EE:DD:CC:BB:AA',os:'Linux Ubuntu 22.04',ports:'22,80',vuln:'High',type:'Server'},
                    {ip:'192.168.1.50',mac:'77:88:99:00:11:22',os:'Nintendo Wii (v4.3)',ports:'80',vuln:'High',type:'Console'},
                    {ip:'192.168.1.100',mac:'33:44:55:66:77:88',os:'Smart TV (Android)',ports:'8080',vuln:'Medium',type:'IoT'}
                ];
                const rd=document.getElementById('scan-results');
                rd.innerHTML='<div style="color:#00FFFF;font-weight:bold;margin-bottom:5px;">DISCOVERED: 6 DEVICES (SIM)</div>';
                cockpit.currentDevices.forEach(dev=>{rd.innerHTML+=`<div class="device-card" onclick="cockpit.showDeviceDetails('${dev.ip}')"><div class="device-info"><span>IP: ${dev.ip} | ${dev.type}</span><span>OS: ${dev.os}</span><span>PORTS: ${dev.ports}</span><span>VULN: <span style="color:${dev.vuln==='High'?'red':dev.vuln==='Medium'?'orange':'#0f0'}">${dev.vuln}</span></span></div></div>`;});
                document.getElementById('network-scan-panel').classList.remove('hidden');
                cockpit.log(`>> SCAN COMPLETE: ${cockpit.currentDevices.length} DEVICES`);
            },3000);
        },
        showDeviceDetails: (ip)=>{
            const dev=cockpit.currentDevices.find(d=>d.ip===ip); if(!dev)return;
            document.getElementById('remote-title').innerText=`DETAILS: ${dev.ip} (${dev.type})`;
            document.getElementById('remote-content').innerHTML=`<div style="font-size:11px;"><strong>OS:</strong> ${dev.os}<br><strong>Ports:</strong> ${dev.ports}<br><strong>Vulnerability:</strong> ${dev.vuln}<br><br><button onclick="cockpit.remoteInto('${ip}')" style="font-size:10px;padding:5px;margin:2px;">REMOTE (SIM)</button><button onclick="cockpit.hackDevice('${ip}','${dev.vuln}')" style="font-size:10px;padding:5px;margin:2px;background:red;color:#000;border-color:red;">HACK/DEFEND (SIM)</button></div>`;
            document.getElementById('remote-access-overlay').classList.remove('hidden');
            audioSys.playTone(500,'square',0.1);
        },
        remoteInto: (ip)=>{
            const dev=cockpit.currentDevices.find(d=>d.ip===ip); cockpit.currentRemote=ip;
            let gui=`<h4 style="color:var(--warn-color);">REMOTE: ${dev.os} (${ip}) SIM</h4>`;
            if(dev.type==='Console')gui+=`<div style="background:#111;padding:20px;text-align:center;color:#ff6b35;"><p>Wii Dashboard Sim</p><button onclick="alert('SIM: Homebrew!')" style="background:#ff6b35;color:#000;padding:5px;">INSTALL HOMEBREW (SIM)</button></div>`;
            else gui+=`<div style="height:200px;background:#000;color:#555;display:flex;align-items:center;justify-content:center;font-size:11px;">Device GUI Sim — ${dev.type}</div>`;
            document.getElementById('remote-content').innerHTML=gui;
        },
        closeRemote: ()=>{ document.getElementById('remote-access-overlay').classList.add('hidden'); cockpit.currentRemote=null; },
        hackDevice: (ip,vuln)=>{
            cockpit.log(`>> SIM HACK/DEFEND ${ip} (${vuln}):`);
            setTimeout(()=>{ if(vuln==='Low')cockpit.log(`>> DEFEND: Patched.`); else if(vuln==='Medium')cockpit.log(`>> PARTIAL: Run updates.`); else cockpit.log(`>> BREACH SIM. DEFEND: Change defaults.`); },1000);
            audioSys.playTone(300,'sawtooth',0.2);
        },
        animate: ()=>{
            if(!cockpit.running||document.getElementById('screen-cockpit').classList.contains('hidden'))return;
            const w=cockpit.canvas.width; const h=cockpit.canvas.height; const ctx=cockpit.ctx;
            ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fillRect(0,0,w,h);
            ctx.lineWidth=2; ctx.strokeStyle=`rgba(255,170,0,${cockpit.gain/100})`; ctx.beginPath();
            for(let i=0;i<w;i+=5){const y=h/2+Math.sin(i*0.05+Date.now()*(cockpit.rate*0.001))*(h/3);ctx.lineTo(i,y);}
            ctx.stroke();
            if(Math.random()>0.8)document.getElementById('visual-text').innerText="HEX_DUMP: "+Math.random().toString(16).substr(2,8).toUpperCase();
            requestAnimationFrame(cockpit.animate);
        }
    };

    // ================================================================
    // DRAWING
    // ================================================================
    window.drawing = {
        canvas: document.getElementById('draw-canvas'),
        ctx: document.getElementById('draw-canvas').getContext('2d'),
        isDrawing:false, mode:'create', letters:[], idx:0, tempData:{},
        init: ()=>{
            drawing.ctx.lineWidth=4;
            drawing.ctx.strokeStyle=getComputedStyle(document.body).color;
            const start=(x,y)=>{drawing.isDrawing=true;drawing.ctx.beginPath();drawing.ctx.moveTo(x,y);};
            const move=(x,y)=>{if(drawing.isDrawing){drawing.ctx.lineTo(x,y);drawing.ctx.stroke();}};
            drawing.canvas.onmousedown=e=>start(e.offsetX,e.offsetY);
            drawing.canvas.onmousemove=e=>move(e.offsetX,e.offsetY);
            drawing.canvas.onmouseup=()=>drawing.isDrawing=false;
        },
        clear: ()=>drawing.ctx.clearRect(0,0,280,280),
        cancel: ()=>nav.to('hub'),
        save: async()=>{
            const char=drawing.letters[drawing.idx]; drawing.tempData.syms[char]=drawing.canvas.toDataURL(); drawing.idx++;
            if(drawing.idx<drawing.letters.length){drawing.clear();document.getElementById('draw-title').innerText="DRAW: "+drawing.letters[drawing.idx];}
            else{
                loading(true);
                if(drawing.mode==='create'){await setDoc(doc(db,"clans",drawing.tempData.name),{pass:drawing.tempData.pass,leader:state.user,symbols:drawing.tempData.syms,words:{},ranks:{[state.user]:'leader'}});await updateDoc(doc(db,"users",state.user),{clan:drawing.tempData.name});}
                else if(drawing.mode==='edit'){await updateDoc(doc(db,"clans",state.clan),{symbols:drawing.tempData.syms});}
                loading(false); nav.to('hub');
            }
        }
    };
    drawing.init();

    // ================================================================
    // KALI
    // ================================================================
    window.kali = {
        dragTarget:null, offsetX:0, offsetY:0,
        openApp: (a)=>{ const c=document.getElementById('py-console'); c.innerHTML+=`\n<span class="term-info">root@kali:~# start ${a}</span>\n`; setTimeout(()=>c.scrollTop=c.scrollHeight,100); },
        handleInput: (e)=>{
            if(e.key==='Enter'){
                const inp=document.getElementById('py-input'); const cmd=inp.value.trim();
                const con=document.getElementById('py-console'); con.innerHTML+=`\n<span style="color:#ddd">>>> ${cmd}</span>\n`;
                inp.value=""; con.scrollTop=con.scrollHeight; audioSys.playTone(600,'sine',0.1);
            } else audioSys.playTone(800,'sine',0.05);
        },
        startDrag: (e,id)=>{ kali.dragTarget=document.getElementById(id); const r=kali.dragTarget.getBoundingClientRect(); kali.offsetX=e.clientX-r.left; kali.offsetY=e.clientY-r.top; },
        drag: (e)=>{ if(kali.dragTarget){kali.dragTarget.style.left=(e.clientX-kali.offsetX)+'px';kali.dragTarget.style.top=(e.clientY-kali.offsetY)+'px';} },
        stopDrag: ()=>{ kali.dragTarget=null; }
    };

    // ================================================================
    // SETTINGS — theme preset system (The Construct style)
    // ================================================================
    window.settings = {
        themeMap: {
            green:  'color-green',
            red:    'color-red',
            blue:   'color-blue',
            white:  'color-white',
            gold:   'color-gold',
            purple: 'color-purple',
            cyan:   'color-cyan',
        },
        apply: (theme) => {
            const cls = settings.themeMap[theme] || 'color-green';
            document.body.className = cls;
            localStorage.setItem('clanNetTheme', theme);
            // Update the drawing canvas stroke color to match
            if(drawing && drawing.ctx) drawing.ctx.strokeStyle = getComputedStyle(document.body).color;
            // Update active label if on settings screen
            const label = document.getElementById('active-theme-name');
            if(label) label.innerText = theme.toUpperCase();
            // Mark active button
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.theme-btn-${theme}`);
            if(btn) btn.classList.add('active');
            audioSys.playTone(600, 'sine', 0.1);
        },
        loadUI: () => {
            // Called when settings screen opens — mark the current theme
            const saved = localStorage.getItem('clanNetTheme') || 'green';
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.theme-btn-${saved}`);
            if(btn) btn.classList.add('active');
            const label = document.getElementById('active-theme-name');
            if(label) label.innerText = saved.toUpperCase();
        },
        load: () => {
            // Called on page init
            const saved = localStorage.getItem('clanNetTheme') || 'green';
            const cls = settings.themeMap[saved] || 'color-green';
            document.body.className = cls;
        },
        reset: () => {
            if(!confirm("RESET TO DEFAULT?")) return;
            localStorage.removeItem('clanNetTheme');
            document.body.className = 'color-green';
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector('.theme-btn-green');
            if(btn) btn.classList.add('active');
            const label = document.getElementById('active-theme-name');
            if(label) label.innerText = 'GREEN';
            audioSys.playTone(400, 'sine', 0.2);
        }
    };

    // Boot: apply saved theme immediately
    settings.load();

    // Keyboard sounds
    document.addEventListener('keydown', (e)=>{
        if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'){
            if(e.key==='Enter')audioSys.playTone(400,'square',0.1);
            else if(e.key==='Backspace')audioSys.playTone(300,'sawtooth',0.1);
            else audioSys.playTone(800,'sine',0.05);
        }
    });

    // Click focuses command input areas
    document.addEventListener('click', ()=>{
        const active = document.querySelector('.screen:not(.hidden) input[type="text"]');
        if(active && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'BUTTON') {
            // Don't steal focus aggressively — only when nothing is focused
        }
    });
</script>
</body>
</html>
