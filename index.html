<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAN_NET // ONLINE</title>
    <style>
        /* --- THEME: BLACK & NEON GREEN --- */
        :root {
            --bg-color: #000000;
            --main-color: #00FF00;
            --dim-color: #004400;
            --warn-color: #FFAA00;
            --err-color: #FF0000;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            font-size: 14px;
        }

        /* --- UI COMPONENTS --- */
        .hidden { display: none !important; }
        .screen { max-width: 600px; margin: 0 auto; border: 1px solid var(--dim-color); padding: 15px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.1); position: relative; }
        
        button, input, select, textarea {
            background: #0a0a0a;
            border: 1px solid var(--dim-color);
            color: var(--main-color);
            padding: 10px;
            margin-bottom: 8px;
            font-family: var(--font-main);
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }

        button:hover { background: var(--main-color); color: black; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.danger { border-color: var(--err-color); color: var(--err-color); }
        button.danger:hover { background: var(--err-color); color: white; }
        button.warn { border-color: var(--warn-color); color: var(--warn-color); }
        
        /* --- REPUTATION COLORS --- */
        .rep-green { color: #00FF00; text-shadow: 0 0 5px #00FF00; }
        .rep-purple { color: #D000FF; text-shadow: 0 0 5px #D000FF; }
        .rep-red { color: #FF0000; text-shadow: 0 0 5px #FF0000; font-weight: bold; }

        /* --- ALERTS & FLASHING --- */
        @keyframes flashRed { 0% {background:black;} 50% {background:#330000;} 100% {background:black;} }
        .alert-mode { animation: flashRed 1s infinite; }
        
        #alert-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 2px solid var(--err-color);
        }

        /* --- CHAT --- */
        .chat-box { height: 250px; overflow-y: scroll; border: 1px solid #222; margin-bottom: 10px; padding: 10px; background: #050505; }
        .chat-msg { margin-bottom: 8px; border-bottom: 1px solid #111; padding-bottom: 4px; font-size: 0.9em; word-wrap: break-word; }
        .chat-img { height: 20px; vertical-align: middle; }
        
        canvas { border: 1px solid var(--main-color); cursor: crosshair; background: #050505; display: block; margin: 0 auto 10px auto; }
        
        /* --- LOADING SPINNER --- */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">Connecting to Firebase...</div>

    <div id="audio-controls" class="hidden"></div>

    <div id="alert-overlay" class="hidden">
        <h1 style="color:red; font-size: 3em;">⚠ ALERT ⚠</h1>
        <p id="alert-msg" style="color:white; font-size: 1.5em; text-align: center; padding: 20px;">SYSTEM COMPROMISED</p>
        <button onclick="audioSys.stopAlarm(); document.getElementById('alert-overlay').classList.add('hidden')" style="width: 200px; border-color: red; color: red;">ACKNOWLEDGE</button>
    </div>

    <div id="screen-auth" class="screen">
        <h1>// NET_LOGIN_ONLINE</h1>
        <input type="text" id="auth-user" placeholder="USERNAME">
        <input type="password" id="auth-pass" placeholder="PASSWORD">
        <button onclick="app.login()">AUTHENTICATE</button>
        <button onclick="app.register()" style="border-style: dashed; opacity: 0.7;">REGISTER IDENTITY</button>
    </div>

    <div id="screen-hub" class="screen hidden">
        <div style="display: flex; justify-content: space-between;">
            <span>USER: <span id="hub-user"></span></span>
            <span id="hub-rep">REP: <span id="rep-badge">LOADING...</span></span>
        </div>
        <hr style="border-color: #333;">

        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button onclick="nav.tab('clans')">CLANS</button>
            <button onclick="nav.tab('global')">GLOBAL COMMS</button>
        </div>

        <div id="tab-clans">
            <div id="panel-no-clan">
                <button onclick="nav.to('create')">INITIALIZE NEW CLAN</button>
                <div style="border: 1px solid #333; padding: 10px; margin-top: 10px;">
                    <p style="margin: 0 0 5px 0;">SEARCH NETWORK:</p>
                    <input type="text" id="join-name" placeholder="EXACT CLAN NAME">
                    <input type="password" id="join-pass" placeholder="ACCESS KEY">
                    <button onclick="app.joinClan()">CONNECT</button>
                </div>
            </div>
            <div id="panel-in-clan" class="hidden">
                <h2 id="clan-header" style="color:white;">CLAN_NAME</h2>
                <div class="chat-box" id="clan-chat"></div>
                
                <div style="display: flex; gap: 5px;">
                    <button onclick="app.toggleTrans()" id="btn-trans" style="width: 50px; font-size: 10px;">ENC</button>
                    <input type="text" id="clan-input" placeholder="Secure Message..." style="margin:0;">
                    <button onclick="app.sendClanMsg()" style="width: 60px;">SEND</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
                    <button onclick="nav.to('dict')">DICTIONARY</button>
                    <button onclick="nav.to('ranks')">MEMBERS/RANKS</button>
                    <button onclick="nav.to('alert')" id="btn-alerts" class="warn hidden">SEND ALERT</button>
                    <button onclick="app.leaveClan()" class="danger">LEAVE</button>
                </div>
            </div>
        </div>

        <div id="tab-global" class="hidden">
            <p style="font-size: 0.8em; color: #888;">// PUBLIC FREQUENCY</p>
            <div class="chat-box" id="global-chat"></div>
            <input type="text" id="global-input" placeholder="Public Comment...">
            <button onclick="app.sendGlobalMsg()">POST COMMENT</button>
        </div>
        
        <button onclick="location.reload()" style="margin-top: 20px; border: none; color: #444;">LOGOUT</button>
    </div>

    <div id="screen-create" class="screen hidden">
        <h2>// NEW_CLAN</h2>
        <input type="text" id="create-name" placeholder="UNIQUE NAME">
        <input type="password" id="create-pass" placeholder="PASSWORD">
        <div style="border: 1px dashed green; padding: 10px; text-align: center; cursor: pointer;" onclick="this.style.background='#003300'; app.isHuman=true;">[ ] NOT A ROBOT</div>
        <br>
        <button onclick="app.createClanStart()">START SYMBOL DRAWING</button>
        <button onclick="nav.to('hub')" style="border-style: dashed;">CANCEL</button>
    </div>

    <div id="screen-draw" class="screen hidden">
        <h3 id="draw-title">DRAW: A</h3>
        <canvas id="draw-canvas" width="280" height="280"></canvas>
        <button onclick="drawing.clear()">CLEAR</button>
        <button onclick="drawing.save()">SAVE & NEXT</button>
    </div>

    <div id="screen-dict" class="screen hidden">
        <h3>// DICTIONARY_EDIT</h3>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="dict-orig" placeholder="ENGLISH">
            <input type="text" id="dict-new" placeholder="CLAN WORD">
        </div>
        <button onclick="app.addWord()">ADD/UPDATE WORD</button>
        <div id="dict-list" style="height: 200px; overflow-y: scroll; border: 1px solid #222;"></div>
        <button onclick="nav.to('hub')" style="margin-top: 10px;">BACK</button>
    </div>

    <div id="screen-alert" class="screen hidden">
        <h2 style="color: var(--warn-color);">// BROADCAST_SYSTEM</h2>
        <button onclick="app.sendAlert(1)">LEVEL 1: ANNOUNCEMENT</button>
        <button onclick="app.sendAlert(2)" class="warn">LEVEL 2: IMPORTANT</button>
        <button onclick="app.sendAlert(3)" class="danger">LEVEL 3: EMERGENCY</button>
        <textarea id="alert-text" placeholder="MESSAGE CONTENT..." style="height: 100px; background: #111; color: white; border: 1px solid green;"></textarea>
        <button onclick="nav.to('hub')" style="margin-top: 10px;">CANCEL</button>
    </div>

    <div id="screen-ranks" class="screen hidden">
        <h3>// ROSTER_CONTROL</h3>
        <div id="member-list" style="height: 300px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <script type="module">
        // --- 1. FIREBASE SETUP (Using CDN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, arrayUnion, arrayRemove, deleteField } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxb5GEGx9LZYD4Ijo-N6K849rsneYlgqk",
            authDomain: "ectenopo.firebaseapp.com",
            projectId: "ectenopo",
            storageBucket: "ectenopo.firebasestorage.app",
            messagingSenderId: "283760497520",
            appId: "1:283760497520:web:c9fdda2d704ca95c0bf5b5"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        // --- 2. AUDIO ENGINE ---
        window.audioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone: (freq, type, dur) => {
                const o = audioSys.ctx.createOscillator();
                const g = audioSys.ctx.createGain();
                o.type = type; o.frequency.value = freq;
                o.connect(g); g.connect(audioSys.ctx.destination);
                o.start(); g.gain.exponentialRampToValueAtTime(0.00001, audioSys.ctx.currentTime + dur);
                o.stop(audioSys.ctx.currentTime + dur);
            },
            playDing: () => { audioSys.playTone(800, 'sine', 1); setTimeout(() => audioSys.playTone(1200, 'sine', 1), 100); },
            startAlarm: () => {
                if(audioSys.osc) return;
                audioSys.osc = audioSys.ctx.createOscillator(); audioSys.osc.type = 'sawtooth';
                audioSys.osc.connect(audioSys.ctx.destination); audioSys.osc.start();
                let up=true;
                audioSys.int = setInterval(() => {
                    let f = audioSys.osc.frequency.value || 500;
                    if(up) f+=50; else f-=50;
                    if(f>1000) up=false; if(f<500) up=true;
                    audioSys.osc.frequency.value = f;
                }, 50);
            },
            stopAlarm: () => { if(audioSys.osc){ audioSys.osc.stop(); audioSys.osc=null; clearInterval(audioSys.int); } }
        };

        // --- 3. STATE & UTILS ---
        window.state = { user: null, clan: null, unsubClan: null, unsubGlobal: null };
        const loading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);

        window.nav = {
            to: (id) => {
                document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
                document.getElementById('screen-' + id).classList.remove('hidden');
                if(id === 'hub') app.initHub();
            },
            tab: (t) => {
                document.getElementById('tab-clans').classList.add('hidden');
                document.getElementById('tab-global').classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('hidden');
            }
        };

        // --- 4. APP LOGIC ---
        window.app = {
            isHuman: false, autoTrans: true, tempClan: {},

            // AUTH
            login: async () => {
                const u = document.getElementById('auth-user').value.trim();
                const p = document.getElementById('auth-pass').value.trim();
                if(!u || !p) return alert("MISSING INPUT");
                
                loading(true);
                const docRef = doc(db, "users", u);
                const docSnap = await getDoc(docRef);
                loading(false);

                if (docSnap.exists() && docSnap.data().pass === p) {
                    state.user = u;
                    nav.to('hub');
                } else {
                    alert("INVALID USER OR PASSWORD");
                }
            },

            register: async () => {
                const u = document.getElementById('auth-user').value.trim();
                const p = document.getElementById('auth-pass').value.trim();
                if(!u || !p) return alert("MISSING INPUT");
                
                loading(true);
                const docRef = doc(db, "users", u);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    loading(false); return alert("USERNAME TAKEN");
                }

                await setDoc(docRef, { pass: p, clan: null, rep: 0 });
                loading(false);
                alert("IDENTITY REGISTERED. PLEASE LOGIN.");
            },

            // MAIN HUB
            initHub: () => {
                const u = state.user;
                document.getElementById('hub-user').innerText = u;

                // Listen to User Data (for clan changes)
                onSnapshot(doc(db, "users", u), (doc) => {
                    const data = doc.data();
                    if(data.clan) {
                        state.clan = data.clan;
                        app.listenToClan(data.clan);
                    } else {
                        state.clan = null;
                        if(state.unsubClan) state.unsubClan(); // Stop listening to old clan
                        document.getElementById('panel-no-clan').classList.remove('hidden');
                        document.getElementById('panel-in-clan').classList.add('hidden');
                    }
                    // Rep Check
                    const rep = data.rep || 0;
                    const badge = document.getElementById('rep-badge');
                    if(rep > 50) { badge.innerText="BLACKLISTED"; badge.className="rep-red"; }
                    else if(rep > 0) { badge.innerText="WATCHLIST"; badge.className="rep-purple"; }
                    else { badge.innerText="GOOD"; badge.className="rep-green"; }
                });

                // Listen to Global Chat
                if(state.unsubGlobal) state.unsubGlobal();
                const q = query(collection(db, "global_chat"), orderBy("ts", "desc"), limit(50));
                state.unsubGlobal = onSnapshot(q, (snapshot) => {
                    const div = document.getElementById('global-chat');
                    div.innerHTML = "";
                    const msgs = [];
                    snapshot.forEach(doc => msgs.push(doc.data()));
                    msgs.reverse().forEach(m => {
                        div.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${m.txt}</div>`;
                    });
                    div.scrollTop = div.scrollHeight;
                });
            },

            // CLAN LOGIC
            listenToClan: (clanName) => {
                document.getElementById('panel-no-clan').classList.add('hidden');
                document.getElementById('panel-in-clan').classList.remove('hidden');
                document.getElementById('clan-header').innerText = clanName;

                // Listen to Clan Data (Alerts, Dictionary, Ranks)
                state.unsubClan = onSnapshot(doc(db, "clans", clanName), (doc) => {
                    state.clanData = doc.data();
                    
                    // Show Leader Buttons
                    const isLeader = state.clanData.leader === state.user;
                    const myRank = (state.clanData.ranks || {})[state.user] || 'member';
                    if(isLeader || myRank === 'admin') document.getElementById('btn-alerts').classList.remove('hidden');
                    else document.getElementById('btn-alerts').classList.add('hidden');

                    // Check Alerts
                    if(state.clanData.lastAlert) {
                        const a = state.clanData.lastAlert;
                        // Simple logic to not spam: In real app, check timestamp
                        if(Date.now() - a.ts < 5000) { 
                            if(a.level === 2) audioSys.playDing();
                            if(a.level === 3) { 
                                document.getElementById('alert-msg').innerText = a.txt;
                                document.getElementById('alert-overlay').classList.remove('hidden');
                                audioSys.startAlarm();
                            }
                        }
                    }
                });

                // Listen to Clan Chat
                const q = query(collection(db, "clans", clanName, "msgs"), orderBy("ts", "desc"), limit(50));
                onSnapshot(q, (snapshot) => {
                    const div = document.getElementById('clan-chat');
                    div.innerHTML = "";
                    const msgs = [];
                    snapshot.forEach(doc => msgs.push(doc.data()));
                    msgs.reverse().forEach(m => {
                         let content = app.autoTrans ? app.translate(m.txt) : m.txt;
                         div.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${content}</div>`;
                    });
                    div.scrollTop = div.scrollHeight;
                });
            },

            createClanStart: async () => {
                if(!app.isHuman) return alert("BOT DETECTED");
                const n = document.getElementById('create-name').value.trim();
                const p = document.getElementById('create-pass').value.trim();
                
                loading(true);
                const check = await getDoc(doc(db, "clans", n));
                if(check.exists()){ loading(false); return alert("NAME TAKEN"); }
                
                app.tempClan = { name: n, pass: p };
                loading(false);
                drawing.idx = 0; drawing.tempSym = {}; drawing.clear();
                nav.to('draw');
            },

            joinClan: async () => {
                const n = document.getElementById('join-name').value.trim();
                const p = document.getElementById('join-pass').value.trim();
                
                loading(true);
                const ref = doc(db, "clans", n);
                const snap = await getDoc(ref);
                loading(false);

                if(!snap.exists()) return alert("NOT FOUND");
                const data = snap.data();
                if(data.pass !== p) return alert("WRONG PASS");
                if((data.blacklist || []).includes(state.user)) return alert("BLACKLISTED");

                await updateDoc(doc(db, "users", state.user), { clan: n });
                await updateDoc(ref, { [`ranks.${state.user}`]: 'member' });
            },

            leaveClan: async () => {
                if(!confirm("LEAVE CLAN?")) return;
                const c = state.clan;
                await updateDoc(doc(db, "users", state.user), { clan: null });
                await updateDoc(doc(db, "clans", c), { [`ranks.${state.user}`]: deleteField() });
            },

            // MESSAGING
            sendGlobalMsg: async () => {
                const txt = document.getElementById('global-input').value;
                if(!txt) return;
                await addDoc(collection(db, "global_chat"), {
                    u: state.user, txt: txt, ts: serverTimestamp()
                });
                document.getElementById('global-input').value = "";
            },

            sendClanMsg: async () => {
                const txt = document.getElementById('clan-input').value;
                if(!txt) return;
                await addDoc(collection(db, "clans", state.clan, "msgs"), {
                    u: state.user, txt: txt, ts: serverTimestamp()
                });
                document.getElementById('clan-input').value = "";
            },

            sendAlert: async (lvl) => {
                const txt = document.getElementById('alert-text').value;
                if(!txt) return;
                
                // Save alert to clan doc to trigger listeners
                await updateDoc(doc(db, "clans", state.clan), {
                    lastAlert: { txt: txt, level: lvl, ts: Date.now() }
                });

                // Add to chat history
                const prefix = lvl === 1 ? "ANNOUNCEMENT: " : (lvl === 2 ? "BROADCAST: " : "EMERGENCY: ");
                await addDoc(collection(db, "clans", state.clan, "msgs"), {
                    u: "SYSTEM", txt: prefix + txt, ts: serverTimestamp()
                });
                nav.to('hub');
            },

            // TRANSLATION & DICTIONARY
            translate: (text) => {
                let out = "";
                const words = state.clanData.words || {};
                const symbols = state.clanData.symbols || {};
                
                text.split(" ").forEach(word => {
                    const clean = word.toLowerCase().replace(/[^a-z]/g,'');
                    if(words[clean]) out += app.strToSym(words[clean], symbols) + " ";
                    else out += app.strToSym(clean, symbols) + " ";
                });
                return out;
            },
            strToSym: (str, symbols) => {
                let html = "";
                for(let c of str) {
                    const U = c.toUpperCase();
                    if(symbols[U]) html += `<img src="${symbols[U]}" class="chat-img">`;
                    else html += c;
                }
                return html;
            },
            toggleTrans: () => {
                app.autoTrans = !app.autoTrans;
                document.getElementById('btn-trans').style.color = app.autoTrans ? '#00FF00' : '#444';
                // Trigger re-render by toggling a class or just wait for next update
            },
            addWord: async () => {
                const k = document.getElementById('dict-orig').value.toLowerCase();
                const v = document.getElementById('dict-new').value.toLowerCase();
                if(k && v) {
                    await updateDoc(doc(db, "clans", state.clan), { [`words.${k}`]: v });
                    // update UI list manually or wait for listener
                    app.renderDict();
                }
            },
            renderDict: () => {
                const list = document.getElementById('dict-list');
                list.innerHTML = "";
                const words = state.clanData.words || {};
                for(const [k,v] of Object.entries(words)) {
                    list.innerHTML += `<div style="border-bottom:1px solid #333; padding:5px;">${k} -> ${v}</div>`;
                }
            }
        };

        // --- 5. DRAWING ---
        window.drawing = {
            canvas: document.getElementById('draw-canvas'),
            ctx: document.getElementById('draw-canvas').getContext('2d'),
            isDrawing: false, letters: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''), idx: 0, tempSym: {},
            
            init: () => {
                drawing.ctx.lineWidth=4; drawing.ctx.strokeStyle='#00FF00';
                const start=(x,y)=>{drawing.isDrawing=true;drawing.ctx.beginPath();drawing.ctx.moveTo(x,y);};
                const move=(x,y)=>{if(drawing.isDrawing){drawing.ctx.lineTo(x,y);drawing.ctx.stroke();}};
                drawing.canvas.onmousedown=e=>start(e.offsetX,e.offsetY);
                drawing.canvas.onmousemove=e=>move(e.offsetX,e.offsetY);
                drawing.canvas.onmouseup=()=>drawing.isDrawing=false;
                drawing.canvas.ontouchstart=e=>{e.preventDefault();const r=drawing.canvas.getBoundingClientRect();start(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);};
                drawing.canvas.ontouchmove=e=>{e.preventDefault();const r=drawing.canvas.getBoundingClientRect();move(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);};
                drawing.canvas.ontouchend=()=>drawing.isDrawing=false;
            },
            clear: ()=>drawing.ctx.clearRect(0,0,300,300),
            save: async () => {
                drawing.tempSym[drawing.letters[drawing.idx]] = drawing.canvas.toDataURL();
                drawing.idx++;
                if(drawing.idx < drawing.letters.length) {
                    drawing.clear();
                    document.getElementById('draw-title').innerText = "DRAW: " + drawing.letters[drawing.idx];
                } else {
                    // FINALIZE CLAN CREATION
                    loading(true);
                    await setDoc(doc(db, "clans", app.tempClan.name), {
                        pass: app.tempClan.pass,
                        leader: state.user,
                        symbols: drawing.tempSym,
                        words: {},
                        ranks: { [state.user]: 'leader' },
                        blacklist: []
                    });
                    // Set user to clan
                    await updateDoc(doc(db, "users", state.user), { clan: app.tempClan.name });
                    loading(false);
                    nav.to('hub');
                }
            }
        };
        drawing.init();

    </script>
</body>
</html>
