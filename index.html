<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAN_NET // ONLINE</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #000000;
            --main-color: #00FF00;
            --dim-color: #004400;
            --warn-color: #FFAA00;
            --err-color: #FF0000;
            --rep-good: #00FF00;
            --rep-watch: #D000FF;
            --rep-black: #FF0000;
            --font-main: 'Courier New', Courier, monospace;
            --kali-bg: #1a1a1a;
            --kali-bar: #2d2d2d;
            --kali-accent: #3377ff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            font-size: 14px;
        }

        /* --- UI COMPONENTS --- */
        .hidden { display: none !important; }
        .screen { max-width: 600px; margin: 0 auto; border: 1px solid var(--dim-color); padding: 15px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.1); position: relative; margin-bottom: 20px; }
        
        button, input, select, textarea {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid var(--dim-color);
            color: var(--main-color);
            padding: 10px;
            margin-bottom: 8px;
            font-family: var(--font-main);
            width: 100%;
            box-sizing: border-box;
            outline: none;
        }

        button:hover { background: var(--main-color); color: var(--bg-color); cursor: pointer; font-weight: bold; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.danger { border-color: var(--err-color); color: var(--err-color); }
        button.danger:hover { background: var(--err-color); color: white; }
        button.warn { border-color: var(--warn-color); color: var(--warn-color); }
        button.admin { border-color: cyan; color: cyan; border-style: double; }
        button.admin:hover { background: cyan; color: black; }

        /* --- VERIFICATION BADGE --- */
        .verified-badge {
            display: inline-block;
            color: cyan;
            margin-left: 4px;
            font-size: 1.1em;
            text-shadow: 0 0 5px cyan;
        }

        /* --- LAYOUTS --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { border: 1px dashed var(--dim-color); padding: 10px; margin-bottom: 10px; }
        .chat-box { height: 250px; overflow-y: scroll; border: 1px solid #222; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); }
        .chat-msg { margin-bottom: 8px; border-bottom: 1px solid #111; padding-bottom: 4px; font-size: 0.9em; word-wrap: break-word; }
        .chat-img { height: 20px; vertical-align: middle; filter: sepia(1) hue-rotate(50deg) saturate(5); }
        
        canvas { border: 1px solid var(--main-color); cursor: crosshair; background: #050505; display: block; margin: 0 auto 10px auto; }
        
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }

        /* --- SOCIAL FEED STYLES --- */
        .post-header { display: flex; justify-content: space-between; font-size: 0.8em; color: #888; border-bottom: 1px solid #333; margin-bottom: 5px; }
        .poll-bar { height: 10px; background: #333; margin-top: 2px; position: relative; }
        .poll-fill { height: 100%; background: var(--main-color); width: 0%; transition: width 0.5s; }

        /* --- KALI LINUX EMULATION --- */
        #screen-kali { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('https://www.transparenttextures.com/patterns/dark-matter.png'), #101010; z-index: 2000; padding: 0; margin: 0; border: none; max-width: none; display: flex; flex-direction: column; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #kali-bar { height: 40px; background: var(--kali-bar); border-bottom: 1px solid #444; display: flex; align-items: center; padding: 0 10px; color: #ddd; justify-content: space-between; }
        .kali-btn { background: transparent; border: none; color: #ddd; width: auto; padding: 5px 15px; margin: 0; font-size: 14px; }
        .kali-btn:hover { background: #444; color: white; }
        .kali-logo { font-weight: bold; color: var(--kali-accent); margin-right: 20px; }
        #kali-desktop { flex: 1; position: relative; overflow: hidden; }
        .window { position: absolute; width: 600px; height: 400px; background: #1e1e1e; border: 1px solid #444; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; top: 50px; left: 50px; }
        .win-header { height: 30px; background: #333; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; cursor: move; }
        .win-title { color: #ccc; font-size: 12px; }
        .win-body { flex: 1; background: #000; padding: 5px; color: #00ff00; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; }
        #py-console { flex: 1; overflow-y: auto; padding: 5px; white-space: pre-wrap; }
        #py-input-line { display: flex; margin-top: 5px; border-top: 1px solid #333; padding-top: 5px; }
        #py-input { background: transparent; border: none; color: white; flex: 1; padding: 0; font-family: 'Courier New', monospace; }
        .term-line { font-family: monospace; font-size: 12px; margin: 2px 0; }
        .term-err { color: #FF0000; } .term-info { color: cyan; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">Accessing Neural Net...</div>

    <div id="screen-auth" class="screen">
        <h1>// NET_LOGIN_ONLINE</h1>
        <input type="text" id="auth-user" placeholder="USERNAME">
        <input type="password" id="auth-pass" placeholder="PASSWORD">
        <button onclick="app.login()">AUTHENTICATE</button>
        <button onclick="app.register()" style="border-style: dashed; opacity: 0.7;">REGISTER IDENTITY</button>
    </div>

    <div id="screen-hub" class="screen hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div onclick="app.openProfile(state.user)" style="cursor: pointer; border-bottom: 1px solid transparent;">
                USER: <span id="hub-user"></span>
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="app.openProfile(state.user)" style="width: auto; padding: 5px 10px; font-size: 10px;">PROFILE</button>
                <button onclick="nav.to('settings')" style="width: auto; padding: 5px 10px; font-size: 10px;">CONFIG</button>
            </div>
        </div>
        <div style="margin-bottom: 10px;"><span id="hub-rep">REP: <span id="rep-badge">LOADING...</span></span></div>
        
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <input type="text" id="search-user-input" placeholder="SEARCH EXACT USERNAME..." style="margin:0;">
            <button onclick="app.searchUser()" style="width: 80px; margin:0;">FIND</button>
        </div>

        <hr style="border-color: var(--dim-color);">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
            <button onclick="nav.tab('clans')">CLANS</button>
            <button onclick="nav.to('social')">NET_SOCIAL</button>
            <button onclick="nav.to('jobs')">JOBS / GIGS</button>
            <button onclick="nav.to('events')">EVENTS</button>
            <button onclick="nav.tab('global')">GLOBAL COMMS</button>
            <button onclick="nav.to('ectotape')" style="border-color: var(--rep-watch); color: var(--rep-watch);">[ ECTOTAPE ]</button>
            <button onclick="nav.to('soc')" id="btn-soc" class="hidden admin" style="grid-column: span 2;">[ SECURITY OPS CENTER ]</button>
        </div>

        <div id="tab-clans">
            <div id="panel-no-clan">
                <button onclick="nav.to('create')">INITIALIZE NEW CLAN</button>
                <div style="border: 1px solid var(--dim-color); padding: 10px; margin-top: 10px;">
                    <p style="margin: 0 0 5px 0;">SEARCH NETWORK:</p>
                    <input type="text" id="join-name" placeholder="EXACT CLAN NAME">
                    <input type="password" id="join-pass" placeholder="ACCESS KEY">
                    <button onclick="app.joinClan()">CONNECT</button>
                </div>
            </div>
            <div id="panel-in-clan" class="hidden">
                <h2 id="clan-header">CLAN_NAME</h2>
                <div class="chat-box" id="clan-chat"></div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="app.toggleTrans()" id="btn-trans" style="width: 50px; font-size: 10px;">ENC</button>
                    <input type="text" id="clan-input" placeholder="Secure Message..." style="margin:0;">
                    <button onclick="app.sendClanMsg()" style="width: 60px;">SEND</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px;">
                    <button onclick="nav.to('dict')">DICTIONARY</button>
                    <button onclick="app.loadRoster()">ROSTER / RANKS</button>
                    <button onclick="app.startSymbolEdit()">EDIT SYMBOLS</button>
                    <button onclick="app.leaveClan()" class="danger">LEAVE</button>
                    <button onclick="app.deleteClan()" id="btn-delete-clan" class="danger hidden" style="grid-column: span 2; border-style: double;">// DELETE CLAN //</button>
                </div>
            </div>
        </div>

        <div id="tab-global" class="hidden">
            <p style="font-size: 0.8em; opacity: 0.7;">// PUBLIC FREQUENCY</p>
            <div class="chat-box" id="global-chat"></div>
            <input type="text" id="global-input" placeholder="Public Comment...">
            <button onclick="app.sendGlobalMsg()">POST COMMENT</button>
        </div>
        
        <button onclick="location.reload()" style="margin-top: 20px; border: none; opacity: 0.5;">LOGOUT</button>
    </div>

    <div id="screen-social" class="screen hidden">
        <h2>// NET_SOCIAL</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="social.tab('posts')">POSTS</button>
            <button onclick="social.tab('polls')">POLLS</button>
        </div>

        <div id="soc-tab-posts">
            <div style="border-bottom: 1px dashed #333; padding-bottom: 10px; margin-bottom: 10px;">
                <textarea id="post-content" placeholder="What's happening?" style="height: 60px;"></textarea>
                <button onclick="social.createPost()">PUBLISH POST</button>
            </div>
            <div id="feed-posts" style="height: 300px; overflow-y: scroll;"></div>
        </div>

        <div id="soc-tab-polls" class="hidden">
            <button onclick="document.getElementById('poll-creator').classList.remove('hidden')">CREATE NEW POLL</button>
            <div id="poll-creator" class="hidden card">
                <input type="text" id="poll-q" placeholder="Question">
                <input type="text" id="poll-o1" placeholder="Option 1">
                <input type="text" id="poll-o2" placeholder="Option 2">
                <button onclick="social.createPoll()">LAUNCH POLL</button>
            </div>
            <div id="feed-polls" style="height: 300px; overflow-y: scroll; margin-top: 10px;"></div>
        </div>

        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-profile" class="screen hidden">
        <h2 id="prof-header">// USER_PROFILE</h2>
        <div class="card">
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="prof-pfp-display" style="width: 50px; height: 50px; background: #222; border: 1px solid var(--main-color); background-size: cover;"></div>
                <div>
                    <h3 id="prof-displayname" style="margin: 0;"></h3>
                    <small id="prof-username" style="color: #888;"></small>
                </div>
            </div>
            <div id="prof-verified" class="hidden" style="color: cyan; margin-top: 5px;">‚ö† VERIFIED IDENTITY ‚ö†</div>
        </div>

        <div id="prof-details">
            <p>CLAN: <span id="prof-clan">LOADING...</span></p>
            <p>STATUS: <span id="prof-rep">LOADING...</span></p>
        </div>

        <div id="prof-edit-panel" class="hidden" style="border-top: 1px solid #333; padding-top: 10px; margin-top: 10px;">
            <input type="text" id="edit-disp" placeholder="New Display Name">
            <input type="text" id="edit-pfp" placeholder="PFP Image URL">
            <div style="display: flex; gap: 5px; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="edit-private" style="width: auto;"> <label>HIDE CLAN FROM PUBLIC</label>
            </div>
            <button onclick="app.saveProfile()">SAVE CHANGES</button>
        </div>

        <div id="prof-admin-panel" class="hidden" style="border: 1px solid cyan; padding: 10px; margin-top: 10px;">
            <strong style="color: cyan;">SUPERUSER CONTROLS</strong>
            <button onclick="app.verifyUser()" class="admin">GRANT VERIFICATION BADGE</button>
        </div>

        <button onclick="nav.to('hub')" style="margin-top: 10px;">BACK</button>
    </div>

    <div id="screen-ranks" class="screen hidden">
        <h3>// ROSTER_CONTROL</h3>
        <div id="roster-list" style="height: 300px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-settings" class="screen hidden">
        <h2>// SYSTEM_CONFIG</h2>
        <div class="grid-2">
            <div>BG: <input type="color" id="col-bg" value="#000000" onchange="settings.apply()"></div>
            <div>MAIN: <input type="color" id="col-main" value="#00FF00" onchange="settings.apply()"></div>
        </div>
        <button onclick="settings.reset()" style="margin-top: 20px;" class="danger">RETURN TO DEFAULT SETTINGS</button>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-events" class="screen hidden">
        <h2>// EVENT_LOG</h2>
        <div style="border: 1px solid var(--dim-color); padding: 10px; margin-bottom: 10px;">
            <input type="text" id="evt-name" placeholder="EVENT NAME">
            <input type="text" id="evt-desc" placeholder="DESCRIPTION">
            <div class="grid-2"><input type="date" id="evt-start"><input type="date" id="evt-end"></div>
            <button onclick="app.createEvent()">PUBLISH</button>
        </div>
        <div id="event-list" style="height: 200px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-jobs" class="screen hidden">
        <h2>// GIG_NETWORK</h2>
        <div class="grid-2"><button onclick="document.getElementById('job-create-panel').classList.remove('hidden');">POST JOB</button><button onclick="app.loadJobs()">BROWSE</button></div>
        <div id="job-create-panel" class="hidden" style="margin-top: 10px; border: 1px dashed var(--dim-color); padding: 10px;">
            <input type="text" id="job-title" placeholder="TITLE"><textarea id="job-desc" placeholder="DESC"></textarea><button onclick="app.createJob()">UPLOAD</button>
        </div>
        <div id="job-list-panel" style="margin-top: 10px;"><div id="job-list" style="height: 300px; overflow-y: scroll;"></div></div>
        <div id="job-chat-panel" class="hidden" style="position: absolute; top:0; left:0; width:100%; height:100%; background: var(--bg-color); z-index: 10; padding: 15px; box-sizing: border-box;">
            <h3>// SECURE_CHANNEL</h3><div id="job-chat-box" class="chat-box" style="height: 300px;"></div>
            <input type="text" id="job-msg-input"><button onclick="app.sendJobMsg()">SEND</button><button onclick="app.closeJobChat()" class="warn">CLOSE</button>
        </div>
        <button onclick="nav.to('hub')">BACK</button>
    </div>

    <div id="screen-ectotape" class="screen hidden">
        <h2 style="color: var(--rep-watch); text-align: center;">// ECTOTAPE_STREAM</h2>
        <div id="upload-zone" class="hidden"><input type="text" id="vid-title" placeholder="TITLE"><input type="text" id="vid-url" placeholder="URL"><button onclick="app.uploadVideo()">BROADCAST</button></div>
        <div id="video-feed" style="height: 400px; overflow-y: scroll;"></div>
        <button onclick="nav.to('hub')">EXIT</button>
    </div>

    <div id="screen-draw" class="screen hidden">
        <h3 id="draw-title">DRAW: A</h3>
        <canvas id="draw-canvas" width="280" height="280"></canvas>
        <div class="grid-2"><button onclick="drawing.clear()">CLEAR</button><button onclick="drawing.save()">NEXT</button></div>
        <button onclick="drawing.cancel()">CANCEL</button>
    </div>

    <div id="screen-create" class="screen hidden"><h2>// NEW_CLAN</h2><input type="text" id="create-name" placeholder="NAME"><input type="password" id="create-pass" placeholder="PASS"><button onclick="app.createClanStart()">START DRAWING</button><button onclick="nav.to('hub')">CANCEL</button></div>
    <div id="screen-dict" class="screen hidden"><h3>// DICT</h3><div class="grid-2"><input type="text" id="dict-orig"><input type="text" id="dict-new"></div><button onclick="app.addWord()">ADD</button><div id="dict-list"></div><button onclick="nav.to('hub')">BACK</button></div>

    <div id="screen-soc" class="screen hidden" style="border-color: cyan; box-shadow: 0 0 15px cyan;">
        <h2 style="color: cyan;">// SECURITY_OPS_CENTER</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <button class="admin" onclick="app.runSecurityScan('TRAFFIC')">ANALYZE TRAFFIC</button>
            <button class="admin" onclick="app.runSecurityScan('VULN')">VULNERABILITY SCAN</button>
        </div>
        <button onclick="nav.to('kali')" style="background: #111; color: var(--kali-accent); border: 1px solid var(--kali-accent); font-weight: bold;">[ BOOT KALI_LINUX_EMU ]</button>
        <div id="soc-console" style="background: #000; border: 1px solid cyan; height: 150px; padding: 10px; overflow-y: scroll; font-family: monospace; font-size: 11px; margin-top:10px;">
            <span class="term-line">> SOC_INIT... READY.</span>
        </div>
        <button onclick="nav.to('hub')" style="margin-top: 10px; border-color: cyan; color: cyan;">DISCONNECT</button>
    </div>

    <div id="screen-kali" class="hidden">
        <div id="kali-bar"><div style="display: flex; align-items: center;"><span class="kali-logo">üêâ KALI_EMU</span><button class="kali-btn" onclick="document.getElementById('kali-menu').classList.toggle('hidden')">Applications</button></div><div id="kali-clock">12:00</div></div>
        <div id="kali-desktop" onmousemove="kali.drag(event)" onmouseup="kali.stopDrag()">
            <div id="win-term" class="window" style="z-index: 10;">
                <div class="win-header" onmousedown="kali.startDrag(event, 'win-term')"><span class="win-title">root@kali:~/python_scripts</span><div class="win-controls"><button onclick="nav.to('soc')" style="background:#ff5f56;width:15px;height:15px;border-radius:50%;padding:0;"></button></div></div>
                <div class="win-body"><div id="py-console"><span class="term-info">Kali GNU/Linux Rolling</span></div><div id="py-input-line"><span style="color:cyan;margin-right:5px;">>>></span><input type="text" id="py-input" onkeydown="kali.handleInput(event)"></div></div>
            </div>
            <div id="kali-menu" class="hidden" style="position: absolute; top:0; left:0; width:200px; background:#2d2d2d; z-index:50; border:1px solid #444;"><button class="kali-btn" style="width:100%;text-align:left;" onclick="kali.openApp('nmap')">Nmap</button><button class="kali-btn" style="width:100%;text-align:left;" onclick="nav.to('soc')">Logout</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, where, getDocs, deleteField, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDxb5GEGx9LZYD4Ijo-N6K849rsneYlgqk", authDomain: "ectenopo.firebaseapp.com", projectId: "ectenopo", storageBucket: "ectenopo.firebasestorage.app", messagingSenderId: "283760497520", appId: "1:283760497520:web:c9fdda2d704ca95c0bf5b5" };
        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        // --- UTILS ---
        const loading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        window.audioSys = { ctx: new (window.AudioContext||window.webkitAudioContext)(), playClick:()=>{/*...*/}, playEnter:()=>{/*...*/} }; // Simplified for space

        // --- STATE ---
        window.state = { user: null, clan: null, clanData: {}, viewedProfile: null };

        // --- NAVIGATION ---
        window.nav = {
            to: (id) => {
                document.querySelectorAll('.screen, #screen-kali').forEach(e => e.classList.add('hidden'));
                if(id === 'kali') document.getElementById('screen-kali').classList.remove('hidden');
                else document.getElementById('screen-' + id).classList.remove('hidden');
                
                if(id === 'hub') app.initHub();
                if(id === 'jobs') app.loadJobs();
                if(id === 'social') social.loadPosts();
                if(id === 'settings') settings.load();
            },
            tab: (t) => { document.getElementById('tab-clans').classList.add('hidden'); document.getElementById('tab-global').classList.add('hidden'); document.getElementById('tab-' + t).classList.remove('hidden'); }
        };

        // --- APP LOGIC ---
        window.app = {
            autoTrans: true,
            
            // AUTH
            login: async () => {
                const u = document.getElementById('auth-user').value.trim();
                const p = document.getElementById('auth-pass').value.trim();
                loading(true);
                const docSnap = await getDoc(doc(db, "users", u));
                loading(false);
                if (docSnap.exists() && docSnap.data().pass === p) {
                    state.user = u;
                    nav.to('hub');
                } else alert("INVALID");
            },
            register: async () => {
                const u = document.getElementById('auth-user').value.trim();
                const p = document.getElementById('auth-pass').value.trim();
                if(!u || !p) return;
                loading(true);
                const check = await getDoc(doc(db, "users", u));
                if (check.exists()) { loading(false); return alert("TAKEN"); }
                await setDoc(doc(db, "users", u), { pass: p, clan: null, rep: 0, displayName: u, verified: false, pfp: "", private: false });
                loading(false); alert("REGISTERED");
            },

            // HUB & CORE
            initHub: async () => {
                const docSnap = await getDoc(doc(db, "users", state.user));
                const userData = docSnap.data();
                
                let verifiedHTML = userData.verified ? `<span class="verified-badge">‚ô¶‚úì</span>` : '';
                document.getElementById('hub-user').innerHTML = `${userData.displayName || state.user} ${verifiedHTML}`;

                // Admin Check for SOC
                const admins = ["user1234", "user4321"];
                const isSuper = admins.includes(state.user.toLowerCase());
                if(isSuper) document.getElementById('btn-soc').classList.remove('hidden');

                // Clan Listener
                onSnapshot(doc(db, "users", state.user), (d) => {
                    const data = d.data();
                    if(data.clan) { state.clan = data.clan; app.listenToClan(data.clan); }
                    else { state.clan = null; document.getElementById('panel-no-clan').classList.remove('hidden'); document.getElementById('panel-in-clan').classList.add('hidden'); }
                });
            },

            // PROFILES
            searchUser: () => {
                const u = document.getElementById('search-user-input').value.trim();
                if(u) app.openProfile(u);
            },
            openProfile: async (targetUser) => {
                loading(true);
                const snap = await getDoc(doc(db, "users", targetUser));
                loading(false);
                
                if(!snap.exists()) return alert("USER NOT FOUND");
                const d = snap.data();
                state.viewedProfile = targetUser;

                document.getElementById('prof-username').innerText = "@" + targetUser;
                document.getElementById('prof-displayname').innerText = d.displayName || targetUser;
                
                const pfp = d.pfp || "";
                document.getElementById('prof-pfp-display').style.backgroundImage = pfp ? `url('${pfp}')` : "none";

                if(d.verified) document.getElementById('prof-verified').classList.remove('hidden');
                else document.getElementById('prof-verified').classList.add('hidden');

                // Privacy Logic
                if(d.private && targetUser !== state.user) {
                    document.getElementById('prof-clan').innerText = "[REDACTED]";
                    document.getElementById('prof-rep').innerText = "[REDACTED]";
                } else {
                    document.getElementById('prof-clan').innerText = d.clan || "NONE";
                    document.getElementById('prof-rep').innerText = d.rep || "0";
                }

                // Edit Panel
                if(targetUser === state.user) {
                    document.getElementById('prof-edit-panel').classList.remove('hidden');
                    document.getElementById('edit-disp').value = d.displayName || "";
                    document.getElementById('edit-pfp').value = d.pfp || "";
                    document.getElementById('edit-private').checked = d.private || false;
                } else {
                    document.getElementById('prof-edit-panel').classList.add('hidden');
                }

                // Admin Verification Panel
                const admins = ["user1234", "user4321"];
                if(admins.includes(state.user.toLowerCase()) && targetUser !== state.user) {
                    document.getElementById('prof-admin-panel').classList.remove('hidden');
                } else {
                    document.getElementById('prof-admin-panel').classList.add('hidden');
                }

                nav.to('profile');
            },
            saveProfile: async () => {
                const dn = document.getElementById('edit-disp').value.trim();
                const pf = document.getElementById('edit-pfp').value.trim();
                const priv = document.getElementById('edit-private').checked;
                await updateDoc(doc(db, "users", state.user), { displayName: dn, pfp: pf, private: priv });
                alert("PROFILE UPDATED");
                app.openProfile(state.user);
            },
            verifyUser: async () => {
                if(!confirm("GRANT VERIFIED STATUS?")) return;
                await updateDoc(doc(db, "users", state.viewedProfile), { verified: true });
                alert("USER VERIFIED");
                app.openProfile(state.viewedProfile);
            },

            // CLAN
            listenToClan: (cName) => {
                document.getElementById('panel-no-clan').classList.add('hidden');
                document.getElementById('panel-in-clan').classList.remove('hidden');
                document.getElementById('clan-header').innerText = cName;
                
                onSnapshot(doc(db, "clans", cName), (doc) => { 
                    state.clanData = doc.data(); 
                    // Show Delete Button if Leader
                    if(state.clanData.leader === state.user) {
                        document.getElementById('btn-delete-clan').classList.remove('hidden');
                    } else {
                        document.getElementById('btn-delete-clan').classList.add('hidden');
                    }
                });
                
                // Chat Listener (Simplified)
                const q = query(collection(db, "clans", cName, "msgs"), orderBy("ts", "desc"), limit(50));
                onSnapshot(q, (snap) => {
                    const d = document.getElementById('clan-chat'); d.innerHTML = "";
                    const msgs = []; snap.forEach(doc => msgs.push(doc.data()));
                    msgs.reverse().forEach(m => { 
                        let txt = app.autoTrans ? app.translate(m.txt) : m.txt; 
                        d.innerHTML += `<div class="chat-msg"><strong>${m.u}:</strong> ${txt}</div>`; 
                    });
                    d.scrollTop = d.scrollHeight;
                });
            },
            
            // ROSTER (Fixed)
            loadRoster: () => {
                nav.to('ranks');
                const list = document.getElementById('roster-list');
                list.innerHTML = "";
                const ranks = state.clanData.ranks || {};
                const isLeader = state.clanData.leader === state.user;

                for (const [member, rank] of Object.entries(ranks)) {
                    let controls = "";
                    if (isLeader && member !== state.user) {
                        controls = `
                        <button onclick="app.clanKick('${member}')" style="width:auto; font-size:10px; padding:2px;" class="danger">KICK</button>
                        <button onclick="app.clanPromote('${member}')" style="width:auto; font-size:10px; padding:2px;">PROMOTE</button>
                        `;
                    }
                    list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>${member} <span style="color:yellow">[${rank.toUpperCase()}]</span></span>
                        <div>${controls}</div>
                    </div>`;
                }
            },
            clanKick: async (target) => {
                if(!confirm(`KICK ${target}?`)) return;
                await updateDoc(doc(db, "clans", state.clan), { [`ranks.${target}`]: deleteField() });
                await updateDoc(doc(db, "users", target), { clan: null });
                app.loadRoster();
            },
            clanPromote: async (target) => {
                await updateDoc(doc(db, "clans", state.clan), { [`ranks.${target}`]: 'admin' });
                app.loadRoster();
            },

            // DELETE CLAN
            deleteClan: async () => {
                const cName = state.clan;
                if(!confirm("WARNING: THIS WILL PERMANENTLY DELETE THE CLAN AND REMOVE ALL MEMBERS. PROCEED?")) return;
                loading(true);
                
                // 1. Get all members
                const cDoc = await getDoc(doc(db, "clans", cName));
                const ranks = cDoc.data().ranks;
                
                // 2. Remove clan from all users
                const batch = []; 
                // Note: In real app use Batch writes. Here iterating for simplicity of code block.
                for(const member of Object.keys(ranks)) {
                    await updateDoc(doc(db, "users", member), { clan: null });
                }

                // 3. Delete Clan Doc
                await deleteDoc(doc(db, "clans", cName));
                
                loading(false);
                alert("CLAN DELETED");
                nav.to('hub');
            },

            // DRAWING (Fix Black Screen)
            startSymbolEdit: () => {
                drawing.mode = "edit";
                // Clone existing symbols
                drawing.tempData = { syms: { ...state.clanData.symbols } };
                drawing.letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
                drawing.idx = 0;
                nav.to('draw');
                // Force reset canvas
                setTimeout(() => drawing.clear(), 100);
            },
            
            // Standard Ops
            joinClan: async () => {/*...*/},
            leaveClan: async () => {/*...*/},
            sendClanMsg: async () => {/*...*/},
            sendGlobalMsg: async () => {/*...*/},
            translate: (txt) => {/*...*/},
            strToSym: (str, syms) => {/*...*/},
            toggleTrans: () => {/*...*/},
            // ... (Other generic functions assumed from previous prompt)
        };

        // --- SOCIAL LOGIC ---
        window.social = {
            tab: (t) => {
                document.getElementById('soc-tab-posts').classList.add('hidden');
                document.getElementById('soc-tab-polls').classList.add('hidden');
                document.getElementById('soc-tab-' + t).classList.remove('hidden');
                if(t === 'posts') social.loadPosts();
                if(t === 'polls') social.loadPolls();
            },
            // POSTS
            createPost: async () => {
                const txt = document.getElementById('post-content').value;
                if(!txt) return;
                await addDoc(collection(db, "posts"), { u: state.user, txt: txt, ts: serverTimestamp(), likes: [] });
                document.getElementById('post-content').value = "";
                social.loadPosts();
            },
            loadPosts: async () => {
                const div = document.getElementById('feed-posts');
                div.innerHTML = "LOADING FEED...";
                const q = query(collection(db, "posts"), orderBy("ts", "desc"), limit(20));
                const snap = await getDocs(q);
                div.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    div.innerHTML += `
                    <div class="card">
                        <div class="post-header"><span onclick="app.openProfile('${p.u}')" style="cursor:pointer; color:var(--main-color);">@${p.u}</span> <span>${new Date(p.ts?.toDate()).toLocaleTimeString()}</span></div>
                        <div>${p.txt}</div>
                    </div>`;
                });
            },
            // POLLS
            createPoll: async () => {
                const q = document.getElementById('poll-q').value;
                const o1 = document.getElementById('poll-o1').value;
                const o2 = document.getElementById('poll-o2').value;
                if(!q || !o1 || !o2) return;
                
                await addDoc(collection(db, "polls"), {
                    u: state.user, q: q, 
                    opts: [{t: o1, v:0}, {t: o2, v:0}],
                    voters: [], ts: serverTimestamp()
                });
                document.getElementById('poll-creator').classList.add('hidden');
                social.loadPolls();
            },
            loadPolls: async () => {
                const div = document.getElementById('feed-polls');
                div.innerHTML = "LOADING POLLS...";
                const q = query(collection(db, "polls"), orderBy("ts", "desc"), limit(10));
                const snap = await getDocs(q);
                div.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    let optsHTML = "";
                    p.opts.forEach((opt, idx) => {
                        const total = p.opts.reduce((a,b)=>a+b.v,0) || 1;
                        const pct = Math.round((opt.v / total) * 100);
                        optsHTML += `
                        <div style="margin-top:5px; cursor:pointer;" onclick="social.vote('${d.id}', ${idx})">
                            <div style="display:flex; justify-content:space-between;"><span>${opt.t}</span> <span>${opt.v}</span></div>
                            <div class="poll-bar"><div class="poll-fill" style="width:${pct}%"></div></div>
                        </div>`;
                    });
                    
                    div.innerHTML += `
                    <div class="card">
                        <div class="post-header"><span>POLL BY @${p.u}</span></div>
                        <strong>${p.q}</strong>
                        ${optsHTML}
                    </div>`;
                });
            },
            vote: async (id, optIdx) => {
                const ref = doc(db, "polls", id);
                const snap = await getDoc(ref);
                const d = snap.data();
                if(d.voters.includes(state.user)) return alert("ALREADY VOTED");
                
                d.opts[optIdx].v++;
                d.voters.push(state.user);
                await updateDoc(ref, { opts: d.opts, voters: d.voters });
                social.loadPolls();
            }
        };

        // --- DRAWING ENGINE ---
        window.drawing = {
            canvas: document.getElementById('draw-canvas'),
            ctx: document.getElementById('draw-canvas').getContext('2d'),
            isDrawing: false, mode: 'create',
            init: () => {
                drawing.ctx.lineWidth=4; drawing.ctx.strokeStyle='#00FF00';
                const start=(x,y)=>{drawing.isDrawing=true;drawing.ctx.beginPath();drawing.ctx.moveTo(x,y);};
                const move=(x,y)=>{if(drawing.isDrawing){drawing.ctx.lineTo(x,y);drawing.ctx.stroke();}};
                drawing.canvas.onmousedown=e=>start(e.offsetX,e.offsetY);
                drawing.canvas.onmousemove=e=>move(e.offsetX,e.offsetY);
                drawing.canvas.onmouseup=()=>drawing.isDrawing=false;
            },
            clear: () => drawing.ctx.clearRect(0,0,300,300),
            cancel: () => nav.to('hub'),
            save: async () => {
                const char = drawing.letters[drawing.idx];
                drawing.tempData.syms[char] = drawing.canvas.toDataURL();
                drawing.idx++;
                if(drawing.idx < drawing.letters.length) {
                    drawing.clear(); document.getElementById('draw-title').innerText = "DRAW: " + drawing.letters[drawing.idx];
                } else {
                    loading(true);
                    if(drawing.mode === 'create') {
                        await setDoc(doc(db, "clans", drawing.tempData.name), { pass: drawing.tempData.pass, leader: state.user, symbols: drawing.tempData.syms, words: {}, ranks: { [state.user]: 'leader' } });
                        await updateDoc(doc(db, "users", state.user), { clan: drawing.tempData.name });
                    } else if (drawing.mode === 'edit') {
                        await updateDoc(doc(db, "clans", state.clan), { symbols: drawing.tempData.syms });
                    }
                    loading(false); nav.to('hub');
                }
            }
        };
        drawing.init();
        
        // --- KALI & SETTINGS (Condensed) ---
        window.kali = { /* ... previous implementation ... */ 
            toggleMenu: () => document.getElementById('kali-menu').classList.toggle('hidden'),
            startDrag: (e, id) => { /*...*/ }, drag: (e) => { /*...*/ }, stopDrag: () => { /*...*/ }
        };
        window.settings = { apply: () => { /*...*/ }, load: () => { /*...*/ }, reset: () => { /*...*/ } };

        // --- FILL IN MISSING FUNCTIONS FROM PREVIOUS PROMPT FOR COMPLETENESS IF NEEDED ---
        app.joinClan = async () => {
            const n = document.getElementById('join-name').value.trim();
            const p = document.getElementById('join-pass').value.trim();
            const s = await getDoc(doc(db, "clans", n));
            if(s.exists() && s.data().pass === p) {
                 await updateDoc(doc(db, "users", state.user), { clan: n });
                 await updateDoc(doc(db, "clans", n), { [`ranks.${state.user}`]: 'member' });
            } else alert("INVALID");
        };
        app.leaveClan = async () => {
            if(!confirm("LEAVE?")) return;
            await updateDoc(doc(db, "users", state.user), { clan: null });
            await updateDoc(doc(db, "clans", state.clan), { [`ranks.${state.user}`]: deleteField() });
        };
        app.sendClanMsg = async () => {
            const t = document.getElementById('clan-input').value;
            if(t) { await addDoc(collection(db, "clans", state.clan, "msgs"), { u: state.user, txt: t, ts: serverTimestamp() }); document.getElementById('clan-input').value=""; }
        };
        app.toggleTrans = () => { app.autoTrans = !app.autoTrans; document.getElementById('btn-trans').style.color = app.autoTrans ? '#00FF00' : '#555'; };
        app.translate = (txt) => { let out = ""; const words = state.clanData.words || {}; const syms = state.clanData.symbols || {}; txt.split(" ").forEach(w => { const c = w.toLowerCase().replace(/[^a-z]/g,''); if(words[c]) out += app.strToSym(words[c], syms) + " "; else out += app.strToSym(c, syms) + " "; }); return out; };
        app.strToSym = (str, syms) => { let html = ""; for(let c of str) { if(syms[c.toUpperCase()]) html += `<img src="${syms[c.toUpperCase()]}" class="chat-img">`; else html += c; } return html; };
        app.createClanStart = async () => { const n = document.getElementById('create-name').value; const p = document.getElementById('create-pass').value; if(!n || !p) return; drawing.mode = "create"; drawing.tempData = { name: n, pass: p, syms: {} }; drawing.letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''); drawing.idx = 0; nav.to('draw'); };

    </script>
</body>
</html>
